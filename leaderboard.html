<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Leaderboard | BA Fitness</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Rank Gradients */
        .rank-1 { background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.05)); border: 1px solid rgba(234, 179, 8, 0.3); }
        .rank-2 { background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(148, 163, 184, 0.05)); border: 1px solid rgba(148, 163, 184, 0.3); }
        .rank-3 { background: linear-gradient(135deg, rgba(180, 83, 9, 0.2), rgba(180, 83, 9, 0.05)); border: 1px solid rgba(180, 83, 9, 0.3); }
        
        .gold-text { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .silver-text { color: #cbd5e1; text-shadow: 0 0 10px rgba(203, 213, 225, 0.5); }
        .bronze-text { color: #fdba74; text-shadow: 0 0 10px rgba(253, 186, 116, 0.5); }
        
        @keyframes pulse-orange {
            0%, 100% { filter: drop-shadow(0 0 2px #f97316); }
            50% { filter: drop-shadow(0 0 8px #f97316); }
        }
        .fire-anim { animation: pulse-orange 2s infinite; }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32 pt-16">

    <header class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter leading-none">
                THE <span class="text-purple-500">ARENA</span>
            </h1>
            <p class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.3em]">Last 7 Days Performance</p>
        </div>
        <div class="w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center border border-purple-500/20">
            <i data-lucide="trophy" class="w-5 h-5 text-purple-500"></i>
        </div>
    </header>

    <main class="space-y-4">
        
        <div class="glass p-1 rounded-xl flex mb-6">
            <button @click="metric = 'volume'" class="flex-1 py-3 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all" :class="metric === 'volume' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'">
                Volume
            </button>
            <button @click="metric = 'sessions'" class="flex-1 py-3 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all" :class="metric === 'sessions' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'">
                Consistency
            </button>
            <button @click="metric = 'streak'" class="flex-1 py-3 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-1" :class="metric === 'streak' ? 'bg-orange-600 text-white shadow-lg' : 'text-slate-500'">
                <i v-if="metric === 'streak'" data-lucide="flame" class="w-3 h-3 fill-white"></i> Streak
            </button>
        </div>

        <div :key="metric" class="space-y-4">
            <div v-for="(user, index) in sortedUsers" :key="user.user_id" 
                 class="relative p-4 rounded-3xl flex items-center gap-4 transition-all active:scale-95"
                 :class="getRankClass(index)">
                
                <div class="w-8 h-8 flex-shrink-0 flex items-center justify-center font-black italic text-lg" 
                     :class="getRankColor(index)">
                    {{ index + 1 }}
                </div>

                <div class="relative">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-slate-800 border border-white/10 overflow-hidden">
                        <img v-if="user.avatar_url" :src="user.avatar_url" class="w-full h-full object-cover">
                        <span v-else class="font-black text-slate-500">{{ user.initials || '??' }}</span>
                    </div>
                    <div v-show="index === 0" class="absolute -top-4 -right-2 text-2xl rotate-12 z-10 drop-shadow-md">ðŸ‘‘</div>
                </div>

                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-white uppercase italic text-sm">{{ user.full_name || 'Anonymous' }}</span>
                        <span v-if="user.user_id === session?.user?.id" class="text-[8px] bg-white/10 px-1.5 py-0.5 rounded text-slate-400 font-bold uppercase">You</span>
                    </div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                        <span v-if="metric === 'volume'">Total Load</span>
                        <span v-else-if="metric === 'sessions'">Sessions</span>
                        <span v-else class="text-orange-400 flex items-center gap-1"><i data-lucide="flame" class="w-3 h-3"></i> Active Streak</span>
                    </div>
                </div>

                <div class="text-right">
                    <div class="font-black italic text-xl text-white" :class="metric === 'streak' ? 'text-orange-500 fire-anim' : ''">
                        {{ getScore(user) }}
                    </div>
                    <div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">
                        {{ getUnit() }}
                    </div>
                </div>

            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
        <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
        <a href="gym.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
        <a href="#" class="flex flex-col items-center tab-active text-purple-500"><i data-lucide="trophy" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Rank</span></a>
        <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
        <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
    </nav>

</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient('https://mvoyrchefjcpjkdtezmz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ');

    createApp({
        data() {
            return {
                session: null,
                users: [],
                metric: 'streak' 
            }
        },
        computed: {
            sortedUsers() {
                // Ensure we return a new array reference to trigger updates properly
                return [...this.users].sort((a, b) => {
                    if (this.metric === 'volume') return b.total_volume - a.total_volume;
                    if (this.metric === 'sessions') return b.sessions_count - a.sessions_count;
                    return b.current_streak - a.current_streak;
                });
            }
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            this.session = session;
            await this.fetchLeaderboard();
            this.$nextTick(() => lucide.createIcons());
        },
        updated() { this.$nextTick(() => lucide.createIcons()); },
        methods: {
            async fetchLeaderboard() {
                const { data, error } = await _client.from('leaderboard').select('*');
                if (error) console.error(error);
                else this.users = data || [];
            },
            getScore(user) {
                if (this.metric === 'volume') return this.formatNumber(user.total_volume);
                if (this.metric === 'sessions') return user.sessions_count;
                return user.current_streak;
            },
            getUnit() {
                if (this.metric === 'volume') return 'LBS';
                if (this.metric === 'sessions') return 'SESSIONS';
                return 'DAYS';
            },
            formatNumber(num) {
                return num ? parseInt(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
            },
            getRankClass(index) {
                if (index === 0) return 'rank-1 glass border-yellow-500/30';
                if (index === 1) return 'rank-2 glass border-slate-400/30';
                if (index === 2) return 'rank-3 glass border-orange-500/30';
                return 'glass border-white/5 opacity-80'; 
            },
            getRankColor(index) {
                if (index === 0) return 'gold-text';
                if (index === 1) return 'silver-text';
                if (index === 2) return 'bronze-text';
                return 'text-slate-600';
            }
        }
    }).mount('#app');
</script>
</body>
</html>
