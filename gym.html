<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Performance | Constellation</title>

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Layout Utilities */
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-solid { background: #020617; border-bottom: 1px solid rgba(255,255,255,0.08); }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-checkbox { appearance: none; background-color: #1e293b; width: 1.5rem; height: 1.5rem; border-radius: 0.5rem; display: grid; place-content: center; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .custom-checkbox::before { content: ""; width: 0.75rem; height: 0.75rem; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .failure-checkbox { appearance: none; width: 1.2rem; height: 1.2rem; background-color: #334155; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>') no-repeat center / contain; mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>') no-repeat center / contain; transition: all 0.2s; }
        .failure-checkbox:checked { background-color: #ef4444; filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.8)); }

        .exercise-card { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform, opacity, filter; }
        .exercise-blurred { opacity: 0.3; filter: grayscale(100%); transform: scale(0.96); pointer-events: none; }
        .exercise-active { opacity: 1; filter: none; transform: scale(1); border-color: rgba(59, 130, 246, 0.4); background: rgba(30, 41, 59, 0.6); box-shadow: 0 0 40px -10px rgba(59, 130, 246, 0.15); }
        
        .picker-container { height: 200px; position: relative; mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); display: flex; }
        .wheel-col { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; text-align: center; }
        .wheel-item { height: 50px; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: #64748b; transition: all 0.2s; }
        .wheel-item-active { color: #3b82f6; font-size: 2rem; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .wheel-highlight { position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%); border-top: 1px solid rgba(59, 130, 246, 0.3); border-bottom: 1px solid rgba(59, 130, 246, 0.3); pointer-events: none; background: rgba(59, 130, 246, 0.05); z-index: 10; }

        .muscle-base { fill: #1e293b; stroke: rgba(255, 255, 255, 0.1); stroke-width: 1px; transition: all 0.6s ease; }
        .muscle-active-fresh { fill: #3b82f6 !important; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); }
        .muscle-active-tired { fill: #f97316 !important; }
        .muscle-active-recov { fill: #ef4444 !important; }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(100%); }
        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950">
<div id="app" v-cloak class="h-[100dvh] w-screen flex flex-col overflow-hidden">
    
    <div v-if="loading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">{{ loadingText }}</p>
        </div>
    </div>

    <transition name="toast">
        <div v-if="toast.visible" class="fixed top-6 left-6 right-6 glass p-4 rounded-2xl shadow-2xl z-[250] flex items-center gap-4 border-l-4 border-blue-500">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <div>
                <h4 class="text-xs font-black italic text-white uppercase">{{ toast.title }}</h4>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <div v-if="view === 'dashboard'" class="flex flex-col h-full w-full">
        <div class="flex-1 overflow-y-auto no-scrollbar p-6 pb-32">
            <header class="flex justify-between items-center mb-6 pt-2">
                <div>
                    <h1 class="text-3xl font-black italic text-blue-500 uppercase">Performance</h1>
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Progressive Overload</p>
                </div>
                <div class="flex gap-2">
                    <button @click="generateAIWorkout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-purple-400 hover:text-purple-300"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                    <button @click="confirmLogout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div class="glass p-6 rounded-[2.5rem] mb-8 border-t-4 border-t-blue-500 shadow-xl relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-900/10 blur-3xl pointer-events-none"></div>
                <div class="flex items-center justify-between mb-6 relative z-10">
                    <div class="flex items-center gap-2 opacity-80">
                        <i data-lucide="flame" class="w-4 h-4 text-blue-400"></i>
                        <h3 class="text-xs font-black uppercase tracking-widest">System Status</h3>
                    </div>
                    <div class="flex gap-3 text-[8px] font-bold uppercase tracking-wider">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Recov</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Ready</span>
                    </div>
                </div>
                <div class="flex justify-center relative z-10 px-2">
                    <svg version="1.1" id="bodyMapSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 130 612 590" style="enable-background:new 0 0 612 792; height: 400px; width: auto;" xml:space="preserve">
                        <g id="Base"><path class="muscle-base" d="M306,170 C 350,170 380,200 380,250 C 380,300 350,320 306,320 C 262,320 232,300 232,250 C 232,200 262,170 306,170 Z M 200,200 L 150,250 L 120,350 L 150,380 L 180,300 L 220,250 Z M 412,200 L 462,250 L 492,350 L 462,380 L 432,300 L 392,250 Z M 250,330 L 250,450 L 230,550 L 260,680 L 290,680 L 300,500 L 310,680 L 340,680 L 370,550 L 350,450 L 350,330 Z" style="opacity:0.2"/></g>
                        <g id="Chest"><path class="muscle-base" d="M 260,230 Q 306,260 352,230 Q 340,280 306,280 Q 272,280 260,230 Z" /></g>
                        <g id="Core"><path class="muscle-base" d="M 270,290 L 342,290 L 335,350 L 277,350 Z" /></g>
                        <g id="Biceps"><path class="muscle-base" d="M 220,240 Q 200,260 190,290 Q 210,290 220,260 Z" /></g>
                        <g id="Triceps"><path class="muscle-base" d="M 420,240 Q 440,260 450,290 Q 430,290 420,260 Z" /></g>
                        <g id="Shoulders"><path class="muscle-base" d="M 220,210 Q 200,220 190,240 L 230,240 Z M 392,210 Q 412,220 422,240 L 382,240 Z" /></g>
                        <g id="Back"><path class="muscle-base" d="M 240,230 L 260,290 L 230,320 Z M 372,230 L 352,290 L 382,320 Z" /></g>
                        <g id="Quads"><path class="muscle-base" d="M 250,400 Q 220,480 235,540 L 270,540 L 285,400 Z M 362,400 Q 392,480 377,540 L 342,540 L 327,400 Z" /></g>
                        <g id="Hamstrings"><path class="muscle-base" d="M 275,410 L 260,530 L 280,530 Z M 337,410 L 352,530 L 332,530 Z" /></g>
                        <g id="Calves"><path class="muscle-base" d="M 240,560 Q 220,600 245,650 L 275,650 Q 280,600 270,560 Z M 372,560 Q 392,600 367,650 L 337,650 Q 332,600 342,560 Z" /></g>
                        <g id="Forearms"><path class="muscle-base" d="M 180,310 L 160,360 L 140,360 L 150,310 Z M 432,310 L 452,360 L 472,360 L 462,310 Z" /></g>
                    </svg>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-3">This Week</h3>
                <div class="flex gap-2 overflow-x-auto no-scrollbar snap-x">
                    <div v-for="dayObj in upcomingDays" :key="dayObj.fullDate" @click="openScheduleModal(dayObj)" class="snap-start flex-shrink-0 w-20 glass rounded-2xl p-3 flex flex-col items-center border border-white/5 relative group active:scale-95 transition-transform">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">{{ dayObj.dayName }}</span>
                        <span class="text-xs font-bold text-slate-300 mb-2">{{ dayObj.dateNum }}</span>
                        <div v-if="getScheduleForDay(dayObj.dayName)" class="flex flex-col items-center">
                            <i :data-lucide="getScheduleForDay(dayObj.dayName).icon_name" class="w-5 h-5 text-blue-400 mb-1"></i>
                            <span class="text-[8px] font-bold text-center leading-none whitespace-normal break-words w-full text-blue-400">{{ getScheduleForDay(dayObj.dayName).name }}</span>
                        </div>
                        <div v-else class="w-8 h-8 rounded-full border border-dashed border-slate-700 flex items-center justify-center">
                            <i data-lucide="plus" class="w-3 h-3 text-slate-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Protocols</h3>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <button v-for="routine in routines" :key="routine.id" @click="previewRoutine(routine)" class="glass p-6 rounded-3xl text-left hover:border-blue-500/50 transition-all active:scale-95 group relative overflow-hidden">
                    <a :href="'builder.html?edit=' + routine.id" @click.stop class="absolute top-3 right-3 p-2 bg-slate-950/50 rounded-full text-slate-500 hover:text-white hover:bg-blue-600 transition-all z-10">
                        <i data-lucide="pencil" class="w-3 h-3"></i>
                    </a>
                    <i :data-lucide="routine.icon_name" class="w-6 h-6 text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
                    <div class="font-black text-lg italic leading-tight mb-1 pr-6 break-words">{{ routine.name }}</div>
                    <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">{{ routine.exercise_order?.length || 0 }} Exercises</div>
                </button>
                <a href="builder.html" class="glass p-6 rounded-3xl text-left hover:border-green-500/50 transition-all active:scale-95 group border-dashed border-slate-700">
                    <i data-lucide="plus-circle" class="w-6 h-6 text-green-500 mb-3 group-hover:scale-110 transition-transform"></i>
                    <div class="font-black text-xl italic text-slate-400">NEW</div>
                    <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Workout / Exercise</div>
                </a>
            </div>

            <div class="glass rounded-[2.5rem] p-8 shadow-2xl pb-24">
                <div class="flex items-center gap-2 mb-6 opacity-60">
                    <i data-lucide="history" class="w-4 h-4 text-slate-400"></i>
                    <h3 class="text-xs font-black uppercase tracking-widest">Recent Sessions</h3>
                </div>
                <div v-if="recentSessions.length === 0" class="text-center py-4 text-slate-600 text-xs italic">No recent activity found.</div>
                <div class="space-y-4">
                    <div v-for="session in recentSessions" :key="session.id" class="flex justify-between items-center border-b border-white/5 pb-4 last:border-0">
                        <div>
                            <div class="font-black text-sm uppercase italic text-slate-200">{{ session.name }}</div>
                            <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-wider">
                                {{ session.date }} • {{ session.exerciseCount }} Exercises • {{ session.volume }} Sets
                            </div>
                        </div>
                        <div class="text-right"><span class="block font-black text-green-500 text-xs">COMPLETED</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
            <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
            <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
            <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
            <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
        </nav>
    </div>


    <div v-if="view === 'active_session'" class="flex flex-col h-full w-full bg-slate-950">
        
        <div class="glass-solid p-4 pt-safe-top z-30 shadow-2xl flex-none">
            <div class="flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-[10px] text-red-500 font-black uppercase tracking-widest">LIVE</span>
                    </div>
                    <h2 class="text-xl font-black italic uppercase leading-none">{{ activeRoutine.name }}</h2>
                </div>
                <div class="font-mono text-3xl font-black text-white tracking-tight">{{ formatTimer(sessionTimer) }}</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-6 scroll-smooth" id="session-container">
            <div v-for="(group, groupIdx) in activeRoutine.data" 
                 :key="groupIdx" 
                 :id="'cluster-' + groupIdx"
                 @click="activeExerciseIdx = groupIdx"
                 class="exercise-card rounded-3xl border border-white/5 relative p-1"
                 :class="activeExerciseIdx === groupIdx ? 'exercise-active' : 'exercise-blurred'">
                
                <div class="p-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center border border-white/10 shadow-lg">
                                <i :data-lucide="group.exercises[0].icon || 'dumbbell'" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-lg italic text-white leading-none mb-1">
                                    <span v-for="(ex, i) in group.exercises" :key="i">
                                        {{ ex.name }}<span v-if="i < group.exercises.length - 1" class="text-slate-500"> + </span>
                                        <button @click.stop="openSwapModal(groupIdx, i)" class="ml-1 text-slate-600 hover:text-blue-400 transition-colors"><i data-lucide="refresh-cw" class="w-3 h-3 inline"></i></button>
                                    </span>
                                </h3>
                                <div class="flex gap-2">
                                    <span class="text-[9px] font-bold uppercase text-slate-500 bg-slate-900 px-2 py-0.5 rounded tracking-wider">{{ group.exercises[0].weightType === 'per_side' ? 'Per Side' : 'Total' }}</span>
                                    <span v-if="group.exercises[0].personalRecord > 0" class="text-[9px] font-bold uppercase text-yellow-500 bg-yellow-500/10 px-2 py-0.5 rounded tracking-wider border border-yellow-500/20">PR: {{ group.exercises[0].personalRecord }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-[10px] font-black text-slate-700 bg-slate-900 px-2 py-1 rounded-lg">#{{ groupIdx + 1 }}</div>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2 text-[8px] text-slate-500 font-black uppercase tracking-widest mb-2 text-center">
                        <div class="col-span-1">#</div>
                        <div class="col-span-1">Ex</div>
                        <div class="col-span-4">lbs</div>
                        <div class="col-span-3">Reps</div>
                        <div class="col-span-2">Done</div>
                        <div class="col-span-1"><i data-lucide="skull" class="w-3 h-3 mx-auto"></i></div>
                    </div>

                    <template v-for="(n, i) in getMaxSets(group)" :key="i">
                        <div v-for="(ex, exIdx) in group.exercises" :key="ex.id + '-' + i" 
                             class="grid grid-cols-12 gap-2 mb-2 items-center relative" 
                             :class="{'mt-3 pt-3 border-t border-white/5': i > 0 && exIdx === 0}">
                            
                            <div class="col-span-1 flex justify-center">
                                <div class="w-5 h-5 rounded-full bg-slate-800 flex items-center justify-center text-[9px] font-bold text-slate-500">{{ i + 1 }}</div>
                            </div>
                            
                            <div class="col-span-1 flex justify-center">
                                <i :data-lucide="ex.icon || 'dumbbell'" class="w-3 h-3 text-slate-600"></i>
                            </div>

                            <div class="col-span-4" v-if="ex.sets[i]">
                                <button v-if="shouldShowBodyWeight(ex, i)" @click="openDualPicker(ex.sets[i], ex.weightType)" class="w-full bg-slate-900/30 border border-white/5 rounded-lg p-2.5 text-center font-black text-[10px] text-slate-500 tracking-wider hover:bg-slate-800 active:scale-95 transition-all">
                                    BW
                                </button>
                                <button v-else @click="openDualPicker(ex.sets[i], ex.weightType)" class="w-full bg-slate-950/50 border border-white/5 rounded-lg p-2.5 text-center font-bold text-sm text-white focus:ring-1 focus:ring-blue-500 transition-all hover:bg-slate-900 relative active:scale-95">
                                    <span v-if="ex.sets[i].weight !== ''">{{ ex.sets[i].weight }}</span>
                                    <span v-else class="text-slate-700">{{ ex.sets[i].prevWeight || '-' }}</span>
                                </button>
                            </div>

                            <div class="col-span-3" v-if="ex.sets[i]">
                                <button @click="openDualPicker(ex.sets[i], ex.weightType)" class="w-full bg-slate-950/50 border border-white/5 rounded-lg p-2.5 text-center font-bold text-sm text-white focus:ring-1 focus:ring-blue-500 transition-all hover:bg-slate-900 relative active:scale-95">
                                    <span v-if="ex.sets[i].reps">{{ ex.sets[i].reps }}</span>
                                    <span v-else class="text-slate-700">{{ ex.sets[i].prevReps || '-' }}</span>
                                </button>
                            </div>

                            <div class="col-span-2 flex justify-center" v-if="ex.sets[i]">
                                <input type="checkbox" v-model="ex.sets[i].done" class="custom-checkbox">
                            </div>
                            <div class="col-span-1 flex justify-center" v-if="ex.sets[i]">
                                <input type="checkbox" v-model="ex.sets[i].failure" class="failure-checkbox">
                            </div>
                        </div>
                    </template>
                    
                    <div v-if="activeExerciseIdx === groupIdx" class="flex gap-2 mt-4">
                         <button @click.stop="addSetToGroup(groupIdx)" class="flex-1 py-3 border border-dashed border-slate-700 rounded-xl text-[10px] text-slate-500 font-black uppercase tracking-widest hover:border-blue-500 hover:text-blue-500">+ Set</button>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <div class="glass flex-none p-4 pb-safe-bottom z-30">
            <div class="grid grid-cols-4 gap-2 mb-3">
                
                <button @click="prevExercise" :disabled="activeExerciseIdx === 0" class="col-span-1 h-12 rounded-2xl bg-slate-800/80 flex items-center justify-center text-slate-400 disabled:opacity-30 disabled:cursor-not-allowed active:scale-95 transition-all">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                
                <button v-if="activeExerciseIdx < activeRoutine.data.length - 1" @click="nextExercise" class="col-span-2 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-black uppercase tracking-wider text-sm shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
                    Next
                </button>
                <button v-else @click="finishModal = true" class="col-span-2 h-12 bg-green-600 rounded-2xl flex items-center justify-center text-white font-black uppercase tracking-wider text-sm shadow-lg shadow-green-900/20 active:scale-95 transition-all">
                    Finish
                </button>

                <button @click="toggleRestTimer" :class="restTimerRunning ? 'bg-red-500/20 text-red-500 border border-red-500/50' : 'bg-slate-800/80 text-slate-400 border border-transparent'" class="col-span-1 h-12 rounded-2xl flex items-center justify-center transition-all relative overflow-hidden active:scale-95">
                     <span v-if="restTimerRunning" class="absolute inset-0 bg-red-500/10 animate-pulse z-0"></span>
                     <span v-if="restTimerRunning" class="relative z-10 font-mono font-black text-xl">{{ formatTimer(restTimer) }}</span>
                     <i v-else data-lucide="timer" class="w-6 h-6 z-10"></i>
                </button>
            </div>
            
            <button @click="exitModal = true" class="w-full py-2 text-[10px] text-slate-500 font-black uppercase hover:text-white transition-colors">Exit Workout</button>
        </div>
    </div>


    <transition name="modal">
        <div v-if="previewModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="previewModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 border border-blue-500/20">
                        <i :data-lucide="previewModal.icon_name" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black italic uppercase">{{ previewModal.name }}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{{ previewModal.exercises.length }} Movements</p>
                    </div>
                </div>
                <div class="space-y-2 mb-8 max-h-64 overflow-y-auto">
                    <div v-for="(exId, idx) in previewModal.exercise_order" :key="idx" class="flex items-center gap-3 p-3 bg-slate-950/50 rounded-xl border border-white/5">
                        <span class="text-xs font-mono text-slate-600">0{{idx+1}}</span>
                        <span class="text-sm font-bold text-slate-300">{{ getExerciseName(exId) }}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="previewModal = null" class="py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
                    <button @click="startActiveSession(previewModal)" class="py-3 rounded-xl bg-blue-600 text-white font-black text-xs uppercase shadow-lg shadow-blue-900/20">Start Session</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="scheduleModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="scheduleModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <h2 class="text-xl font-black italic uppercase mb-2">Schedule Protocol</h2>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-6">For {{ scheduleModal.dayName }} {{ scheduleModal.dateNum }}</p>
                <div class="space-y-2 max-h-64 overflow-y-auto mb-6">
                    <button @click="saveSchedule(null)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 text-slate-500 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">Rest Day (Clear)</button>
                    <button v-for="routine in routines" :key="routine.id" @click="saveSchedule(routine)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                        <i :data-lucide="routine.icon_name" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-white font-bold text-sm uppercase italic">{{ routine.name }}</span>
                    </button>
                </div>
                <button @click="scheduleModal = null" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Close</button>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="finishModal" class="fixed inset-0 z-[300] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="finishModal = false"></div>
            <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-green-500/20 shadow-2xl">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20 mb-4 shadow-[0_0_20px_rgba(34,197,94,0.2)]">
                        <i data-lucide="trophy" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-black italic uppercase text-center text-white">Session Complete</h2>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">{{ activeRoutine.name }} • {{ formatTimer(sessionTimer) }}</p>
                </div>
                
                <label class="flex items-center gap-3 p-4 bg-slate-900/50 rounded-xl mb-6 cursor-pointer border border-white/5">
                    <div class="relative"><input type="checkbox" v-model="stackTaken" class="sr-only peer"><div class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div></div>
                    <span class="text-[10px] font-black uppercase tracking-widest flex-1"><span class="block text-slate-400">Inventory</span><span :class="stackTaken ? 'text-purple-400' : 'text-slate-600'">Log Stack Consumption?</span></span>
                </label>

                <div class="space-y-3">
                    <button @click="confirmFinishSession" class="w-full py-4 rounded-xl bg-green-600 text-white font-black text-sm uppercase shadow-lg shadow-green-900/20 hover:bg-green-500 transition-all active:scale-95">Save Workout</button>
                    <button @click="finishModal = false" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">Resume Training</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="exitModal" class="fixed inset-0 z-[300] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="exitModal = false"></div>
            <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-red-500/20 shadow-2xl">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20 mb-4">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-xl font-black italic uppercase text-center text-white">Exit Session?</h2>
                    <p class="text-xs text-slate-500 font-bold text-center mt-2">Unsaved progress will be permanently lost.</p>
                </div>
                <div class="space-y-3">
                    <button @click="confirmFinishSession" class="w-full py-3 rounded-xl bg-slate-800 text-green-500 font-black text-xs uppercase hover:bg-slate-700">Save & Finish</button>
                    <button @click="discardSession" class="w-full py-3 rounded-xl bg-red-600 text-white font-black text-xs uppercase shadow-lg shadow-red-900/20 hover:bg-red-500">Discard Data</button>
                    <button @click="exitModal = false" class="w-full py-2 text-[10px] text-slate-500 font-black uppercase hover:text-white">Cancel</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="pickerModal.visible" class="fixed inset-0 z-[400] flex items-end justify-center">
            <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" @click="saveDualPicker"></div>
            <div class="glass-solid w-full border-t border-blue-500/30 rounded-t-3xl p-6 relative pb-safe-bottom bg-slate-900">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black uppercase italic text-blue-500">Edit Set</h3>
                    <button @click="saveDualPicker" class="text-xs font-bold uppercase text-white bg-blue-600 px-6 py-2 rounded-lg shadow-lg shadow-blue-900/20">Set</button>
                </div>
                
                <div class="grid grid-cols-2 text-[10px] font-black uppercase text-slate-500 tracking-widest text-center mb-2">
                    <div>Weight (lbs)</div>
                    <div>Reps</div>
                </div>

                <div class="picker-container">
                    
                    <div class="wheel-col no-scrollbar" ref="weightWheel" @scroll="handleWeightScroll">
                        <div class="h-[75px]"></div>
                        <div v-for="w in pickerModal.weightValues" :key="'w-'+w" class="wheel-item" :class="{'wheel-item-active': pickerModal.weightVal === w}">{{ w }}</div>
                        <div class="h-[75px]"></div>
                    </div>

                    <div class="wheel-col no-scrollbar" ref="repsWheel" @scroll="handleRepsScroll">
                        <div class="h-[75px]"></div>
                        <div v-for="r in pickerModal.repsValues" :key="'r-'+r" class="wheel-item" :class="{'wheel-item-active': pickerModal.repsVal === r}">{{ r }}</div>
                        <div class="h-[75px]"></div>
                    </div>

                    <div class="wheel-highlight"></div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="swapModal.visible" class="fixed inset-0 z-[350] flex items-end justify-center sm:items-center p-4">
             <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="swapModal.visible = false"></div>
             <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl h-[70vh] flex flex-col">
                <h3 class="text-lg font-black uppercase italic text-white mb-2">Swap Exercise</h3>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-4">Targeting: {{ swapModal.targetMuscle }}</p>
                <div class="flex-1 overflow-y-auto space-y-2 no-scrollbar">
                    <button v-for="ex in swapModal.options" :key="ex.id" @click="selectSwap(ex)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                         <i :data-lucide="ex.icon_name || 'dumbbell'" class="w-5 h-5 text-blue-500"></i>
                         <span class="text-white font-bold text-sm uppercase italic">{{ ex.name }}</span>
                    </button>
                </div>
                <button @click="swapModal.visible = false" class="mt-4 w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
             </div>
        </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient(
        'https://mvoyrchefjcpjkdtezmz.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ'
    );

    createApp({
        data() { 
            return { 
                loading: true, 
                loadingText: 'Syncing Protocols',
                session: null,
                view: 'dashboard', 
                toast: { visible: false, title: '', message: '' },
                
                // Modals
                scheduleModal: null, 
                previewModal: null,
                finishModal: false,
                exitModal: false,
                
                // Dual Picker State
                pickerModal: {
                    visible: false,
                    targetSet: null,
                    weightValues: [],
                    repsValues: [],
                    weightVal: 0,
                    repsVal: 0,
                    targetWeightType: 'combined'
                },
                
                swapModal: { visible: false, targetMuscle: '', options: [], groupIdx: null, exIdx: null },

                // Data
                routines: [], 
                libraryExercises: [], 
                schedule: [], 
                recentSessions: [],
                rawLogs: [], 
                
                muscleHeatmap: { 'chest': {status: 'fresh'}, 'back': {status: 'fresh'}, 'legs': {status: 'fresh'}, 'arms': {status: 'fresh'}, 'shoulders': {status: 'fresh'}, 'core': {status: 'fresh'}, 'quads': {status: 'fresh'}, 'hamstrings': {status: 'fresh'}, 'glutes': {status: 'fresh'}, 'calves': {status: 'fresh'}, 'biceps': {status: 'fresh'}, 'triceps': {status: 'fresh'}, 'forearms': {status: 'fresh'}, 'hips': {status: 'fresh'} },

                // Active Session
                activeRoutine: { name: '', data: [] }, 
                activeExerciseIdx: 0,
                stackTaken: false,
                sessionTimer: 0, 
                sessionStartTime: null,
                sessionInterval: null,
                restTimer: 0, 
                restTimerRunning: false, 
                restInterval: null,
                personalRecords: {} 
            } 
        },
        computed: {
            upcomingDays() {
                const days = [];
                for(let i=0; i<7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() + i);
                    days.push({ dateNum: d.getDate(), dayName: d.toLocaleDateString('en-US', {weekday:'short'}), fullDate: d.toLocaleDateString('en-CA') });
                }
                return days;
            }
        },
        watch: {
            activeRoutine: { handler() { this.saveSessionState(); }, deep: true },
            stackTaken() { this.saveSessionState(); },
            activeExerciseIdx(newVal) {
                this.$nextTick(() => {
                    const el = document.getElementById('cluster-' + newVal);
                    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            },
            view(newVal) {
                if(newVal === 'dashboard') {
                    // FIX FOR RACE CONDITION: Wait for DOM, then render SVG
                    this.$nextTick(() => {
                        this.safeUpdateHeatmap();
                    });
                }
            }
        },
        async mounted() {
            const { data: { session }, error } = await _client.auth.getSession();
            if (error || !session) { window.location.href = 'index.html'; return; }
            this.session = session;
            
            try {
                await Promise.all([this.fetchRoutines(), this.fetchExercises(), this.fetchSchedule(), this.fetchHistory()]);
                this.restoreSessionState();
            } catch (err) {
                console.error("Initialization error:", err);
                this.showToast("Sync Error", "Could not load data. Pull to refresh.");
            } finally {
                this.loading = false;
                this.$nextTick(() => { 
                    lucide.createIcons(); 
                    this.safeUpdateHeatmap();
                });
            }
        },
        updated() { 
            this.$nextTick(() => { 
                lucide.createIcons(); 
                if(this.view === 'dashboard') {
                    setTimeout(() => this.updateHeatmapVisuals(), 50);
                }
            }); 
        },
        methods: {
            // --- DUAL PICKER LOGIC ---
            openDualPicker(setObj, weightType) {
                this.pickerModal.targetSet = setObj;
                this.pickerModal.targetWeightType = weightType;
                
                if(this.pickerModal.weightValues.length === 0) {
                     for(let i=0; i<=500; i+=2.5) this.pickerModal.weightValues.push(i);
                     for(let i=0; i<=100; i++) this.pickerModal.repsValues.push(i);
                }
                
                let w = parseFloat(setObj.weight);
                if(isNaN(w)) w = parseFloat(setObj.prevWeight) || 0;
                let r = parseInt(setObj.reps);
                if(isNaN(r)) r = parseInt(setObj.prevReps) || 0;

                this.pickerModal.weightVal = w;
                this.pickerModal.repsVal = r;
                this.pickerModal.visible = true;

                this.$nextTick(() => {
                    const itemHeight = 50;
                    const wIndex = this.pickerModal.weightValues.indexOf(w);
                    if(wIndex > -1 && this.$refs.weightWheel) this.$refs.weightWheel.scrollTop = wIndex * itemHeight;
                    const rIndex = this.pickerModal.repsValues.indexOf(r);
                    if(rIndex > -1 && this.$refs.repsWheel) this.$refs.repsWheel.scrollTop = rIndex * itemHeight;
                });
            },
            handleWeightScroll(e) {
                const itemHeight = 50;
                const index = Math.round(e.target.scrollTop / itemHeight);
                const val = this.pickerModal.weightValues[index];
                if (val !== undefined && val !== this.pickerModal.weightVal) {
                    this.pickerModal.weightVal = val;
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            },
            handleRepsScroll(e) {
                const itemHeight = 50;
                const index = Math.round(e.target.scrollTop / itemHeight);
                const val = this.pickerModal.repsValues[index];
                if (val !== undefined && val !== this.pickerModal.repsVal) {
                    this.pickerModal.repsVal = val;
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            },
            saveDualPicker() {
                if(this.pickerModal.targetSet) {
                    // Logic for Body Weight: If 0, and it's a BW exercise, it reverts to null (showing BW)
                    if(this.pickerModal.targetWeightType === 'bodyweight' && this.pickerModal.weightVal === 0) {
                        this.pickerModal.targetSet.weight = ''; 
                    } else {
                        this.pickerModal.targetSet.weight = this.pickerModal.weightVal;
                    }
                    this.pickerModal.targetSet.reps = this.pickerModal.repsVal;
                }
                this.pickerModal.visible = false;
            },
            shouldShowBodyWeight(ex, i) {
                // If it's a bodyweight type AND (weight is empty OR weight is 0)
                return ex.weightType === 'bodyweight' && (ex.sets[i].weight === '' || ex.sets[i].weight === 0 || ex.sets[i].weight === null);
            },

            // --- STOPWATCH LOGIC ---
            startSessionTimer() {
                if (this.sessionInterval) clearInterval(this.sessionInterval);
                if (!this.sessionStartTime) this.sessionStartTime = Date.now();
                const tick = () => {
                    const now = Date.now();
                    const seconds = Math.floor((now - this.sessionStartTime) / 1000);
                    this.sessionTimer = seconds > 0 ? seconds : 0;
                };
                tick();
                this.sessionInterval = setInterval(tick, 1000);
            },

            // --- NAVIGATION ---
            nextExercise() { if(this.activeExerciseIdx < this.activeRoutine.data.length - 1) this.activeExerciseIdx++; },
            prevExercise() { if(this.activeExerciseIdx > 0) this.activeExerciseIdx--; },

            saveSessionState() {
                if (this.view !== 'active_session' || !this.activeRoutine.name) return;
                const state = { activeRoutine: this.activeRoutine, sessionStartTime: this.sessionStartTime, activeExerciseIdx: this.activeExerciseIdx, stackTaken: this.stackTaken };
                localStorage.setItem('constellation_active_session', JSON.stringify(state));
            },
            restoreSessionState() {
                const savedSession = localStorage.getItem('constellation_active_session');
                if (savedSession) {
                    try {
                        const parsed = JSON.parse(savedSession);
                        this.activeRoutine = parsed.activeRoutine;
                        this.sessionStartTime = parsed.sessionStartTime;
                        this.activeExerciseIdx = parsed.activeExerciseIdx || 0;
                        this.stackTaken = parsed.stackTaken || false;
                        this.view = 'active_session';
                        this.startSessionTimer();
                        this.showToast("Session Restored", "Resumed previous workout.");
                    } catch (e) {
                        localStorage.removeItem('constellation_active_session');
                    }
                }
            },
            
            // --- SWAP LOGIC ---
            openSwapModal(groupIdx, exIdx) {
                const group = this.activeRoutine.data[groupIdx];
                const currentEx = group.exercises[exIdx];
                const libraryEntry = this.libraryExercises.find(e => e.name === currentEx.name);
                const targetMuscle = libraryEntry ? libraryEntry.muscle_group : null;
                
                if(targetMuscle) {
                    this.swapModal.targetMuscle = targetMuscle;
                    this.swapModal.options = this.libraryExercises.filter(e => e.muscle_group === targetMuscle);
                } else {
                    this.swapModal.targetMuscle = 'All';
                    this.swapModal.options = this.libraryExercises;
                }
                this.swapModal.groupIdx = groupIdx;
                this.swapModal.exIdx = exIdx;
                this.swapModal.visible = true;
            },
            async selectSwap(newExDef) {
                const { groupIdx, exIdx } = this.swapModal;
                const group = this.activeRoutine.data[groupIdx];
                const pr = (this.personalRecords[newExDef.name] || 0);
                const newEx = {
                    id: newExDef.id, name: newExDef.name, icon: newExDef.icon_name, weightType: newExDef.weight_type, personalRecord: pr,
                    isLinked: group.exercises[exIdx].isLinked, sets: []
                };
                const { data: lastLog } = await _client.from('workout_logs').select('sets_data').eq('exercise_name', newEx.name).order('created_at', { ascending: false }).limit(1).single();
                if(lastLog && lastLog.sets_data) {
                    newEx.sets = lastLog.sets_data.map(s => ({ weight: '', prevWeight: s.weight, reps: '', prevReps: s.reps, done: false, failure: false }));
                }
                const targetSets = group.exercises[exIdx].sets.length;
                while(newEx.sets.length < targetSets) newEx.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false });
                group.exercises[exIdx] = newEx;
                this.swapModal.visible = false;
                this.showToast('Swapped', `Now doing ${newEx.name}`);
            },

            // --- STANDARD LOGIC ---
            discardSession() {
                localStorage.removeItem('constellation_active_session');
                clearInterval(this.sessionInterval);
                this.finishModal = false;
                this.exitModal = false;
                this.view = 'dashboard';
            },
            async confirmLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },
            showToast(title, message) { this.toast = { visible: true, title, message }; setTimeout(() => this.toast.visible = false, 3000); },
            async fetchRoutines() { const { data } = await _client.from('routines').select('*').order('created_at'); this.routines = data || []; },
            async fetchExercises() { const { data } = await _client.from('exercises').select('*').order('name'); this.libraryExercises = data || []; },
            async fetchSchedule() { const { data } = await _client.from('schedule').select('*, routines(name, icon_name)').eq('user_id', this.session.user.id); this.schedule = data || []; },
            
            async fetchHistory() {
                const { data: rawData } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false }).limit(300);
                this.rawLogs = rawData || [];
                // Update PRs
                this.rawLogs.forEach(log => {
                    if(log.sets_data) {
                        log.sets_data.forEach(s => {
                            const w = parseFloat(s.weight) || 0;
                            if(w > (this.personalRecords[log.exercise_name] || 0)) this.personalRecords[log.exercise_name] = w;
                        });
                    }
                });
                this.calculateHeatmapData();
                if (!this.rawLogs.length) { this.recentSessions = []; return; }
                
                const sessions = []; let currentSession = null;
                const pushSession = (s) => {
                    s.exerciseCount = s.exercises.size;
                    delete s.exercises;
                    sessions.push(s);
                };

                this.rawLogs.forEach((log) => {
                    const logTime = new Date(log.created_at).getTime();
                    if (!currentSession) {
                        currentSession = { 
                            id: log.id, startTime: logTime, 
                            name: log.protocol_name || 'Training Session', 
                            date: new Date(log.created_at).toLocaleDateString(), 
                            volume: 1, 
                            exercises: new Set([log.exercise_name]) 
                        };
                        if(log.sets_data) currentSession.volume = log.sets_data.length;
                    } else {
                        const diffMins = Math.abs(currentSession.startTime - logTime) / (1000 * 60);
                        if (diffMins < 60) {
                            currentSession.volume += (log.sets_data ? log.sets_data.length : 1);
                            currentSession.exercises.add(log.exercise_name);
                        } else { 
                            pushSession(currentSession); 
                            currentSession = { 
                                id: log.id, startTime: logTime, 
                                name: log.protocol_name || 'Training Session', 
                                date: new Date(log.created_at).toLocaleDateString(), 
                                volume: (log.sets_data ? log.sets_data.length : 1), 
                                exercises: new Set([log.exercise_name]) 
                            }; 
                        }
                    }
                });
                if (currentSession) pushSession(currentSession);
                this.recentSessions = sessions.slice(0, 5);
            },
            calculateHeatmapData() {
                const now = new Date().getTime();
                const oneDay = 1000 * 60 * 60 * 24;
                for(let m in this.muscleHeatmap) { this.muscleHeatmap[m].lastTrained = null; this.muscleHeatmap[m].status = 'fresh'; }
                this.rawLogs.forEach(log => {
                    const exDef = this.libraryExercises.find(e => e.name === log.exercise_name);
                    if(exDef && exDef.muscle_group) {
                        let groupKey = exDef.muscle_group.toLowerCase();
                        if(this.muscleHeatmap[groupKey]) {
                             const logTime = new Date(log.created_at).getTime();
                             if(!this.muscleHeatmap[groupKey].lastTrained || logTime > this.muscleHeatmap[groupKey].lastTrained) this.muscleHeatmap[groupKey].lastTrained = logTime;
                        }
                    }
                });
                for(let m in this.muscleHeatmap) {
                    if(this.muscleHeatmap[m].lastTrained) {
                        const daysSince = (now - this.muscleHeatmap[m].lastTrained) / oneDay;
                        if(daysSince < 2) this.muscleHeatmap[m].status = 'recov';
                        else if(daysSince < 4) this.muscleHeatmap[m].status = 'tired';
                        else this.muscleHeatmap[m].status = 'fresh';
                    }
                }
            },
            
            // RACE CONDITION FIX: Recursive check + Watcher
            safeUpdateHeatmap() {
                let attempts = 0;
                const paint = () => {
                    const chest = document.getElementById('Chest'); 
                    if(chest) {
                        this.updateHeatmapVisuals();
                    } else if (attempts < 20) { 
                        attempts++;
                        requestAnimationFrame(paint);
                    }
                };
                requestAnimationFrame(paint);
            },
            updateHeatmapVisuals() {
                const groups = document.querySelectorAll('.muscle-base');
                groups.forEach(el => el.classList.remove('muscle-active-fresh', 'muscle-active-tired', 'muscle-active-recov'));
                for (const [key, data] of Object.entries(this.muscleHeatmap)) {
                    const id = key.charAt(0).toUpperCase() + key.slice(1);
                    const groupEl = document.getElementById(id);
                    if (groupEl) {
                        const paths = groupEl.querySelectorAll('path');
                        paths.forEach(path => {
                            if (data.status === 'recov') path.classList.add('muscle-active-recov');
                            else if (data.status === 'tired') path.classList.add('muscle-active-tired');
                            else if (data.status === 'fresh') path.classList.add('muscle-active-fresh');
                        });
                        if (data.status === 'recov') groupEl.classList.add('animate-pulse');
                        else groupEl.classList.remove('animate-pulse');
                    }
                }
            },
            async generateAIWorkout() {
                this.loading = true; this.loadingText = "Analyzing Biometrics...";
                setTimeout(async () => {
                    const fillerExercises = this.libraryExercises.slice(0, 3).map(e => e.id);
                    if(fillerExercises.length) {
                        await _client.from('routines').insert([{ name: 'AI Gap Filler', icon_name: 'zap', exercise_order: fillerExercises, user_id: this.session.user.id }]);
                        await this.fetchRoutines();
                        this.showToast("AI Generated", "Gap Filler Protocol Created");
                    }
                    this.loading = false;
                }, 1000);
            },
            getScheduleForDay(dayName) { const entry = this.schedule.find(s => s.day_of_week === dayName); return entry ? { name: entry.routines.name, icon_name: entry.routines.icon_name } : null; },
            openScheduleModal(dayObj) { this.scheduleModal = dayObj; },
            async saveSchedule(routine) {
                if (!this.scheduleModal) return;
                const day = this.scheduleModal.dayName; 
                if (routine) await _client.from('schedule').upsert({ user_id: this.session.user.id, day_of_week: day, routine_id: routine.id }, { onConflict: 'user_id, day_of_week' });
                else await _client.from('schedule').delete().eq('user_id', this.session.user.id).eq('day_of_week', day);
                this.scheduleModal = null; this.fetchSchedule(); this.showToast('Schedule Updated', routine ? `${routine.name} set` : 'Rest day assigned');
            },
            previewRoutine(routine) { this.previewModal = { ...routine, exercises: routine.exercise_order || [] }; },
            getExerciseName(id) { const ex = this.libraryExercises.find(e => e.id === id); return ex ? ex.name : 'Unknown Exercise'; },
            async startActiveSession(routine) {
                this.previewModal = null; this.loading = true; this.loadingText = "Constructing Session...";
                const draftRoutine = { name: routine.name, data: [] };
                const flatExercises = (routine.exercise_order || []).map((id, index) => {
                    const exDef = this.libraryExercises.find(e => e.id === id);
                    const pr = exDef ? (this.personalRecords[exDef.name] || 0) : 0;
                    return { id: id, name: exDef ? exDef.name : 'Exercise', icon: exDef ? exDef.icon_name : 'dumbbell', weightType: exDef ? exDef.weight_type : 'combined', personalRecord: pr, isLinked: (routine.supersets || []).includes(index), sets: [{weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}] };
                });
                const clusters = [];
                flatExercises.forEach((ex) => {
                    if (ex.isLinked && clusters.length > 0) clusters[clusters.length - 1].exercises.push(ex);
                    else clusters.push({ type: 'cluster', exercises: [ex] });
                });
                draftRoutine.data = clusters;
                for (let group of draftRoutine.data) {
                    for (let ex of group.exercises) {
                        const { data: lastLog } = await _client.from('workout_logs').select('sets_data').eq('exercise_name', ex.name).order('created_at', { ascending: false }).limit(1).single();
                        if(lastLog && lastLog.sets_data) ex.sets = lastLog.sets_data.map(s => ({ weight: '', prevWeight: s.weight, reps: '', prevReps: s.reps, done: false, failure: false }));
                        while(ex.sets.length < 3) ex.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false });
                    }
                    const maxSets = Math.max(...group.exercises.map(e => e.sets.length));
                    group.exercises.forEach(ex => { while(ex.sets.length < maxSets) ex.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false }); });
                }
                this.activeRoutine = draftRoutine; this.activeExerciseIdx = 0; this.view = 'active_session';
                this.$nextTick(() => { window.scrollTo(0,0); const container = document.getElementById('session-container'); if(container) container.scrollTop = 0; });
                this.sessionStartTime = Date.now();
                this.startSessionTimer();
                this.loading = false;
            },
            getMaxSets(group) { if(!group || !group.exercises) return 0; return Math.max(...group.exercises.map(e => e.sets.length)); },
            addSetToGroup(groupIdx) {
                const group = this.activeRoutine.data[groupIdx];
                group.exercises.forEach(ex => { const prev = ex.sets.slice(-1)[0]; ex.sets.push({ weight: '', prevWeight: prev?.prevWeight||'', reps: '', prevReps: prev?.prevReps||'', done: false, failure: false }); });
            },
            toggleRestTimer() { 
                this.restTimerRunning = !this.restTimerRunning; 
                if(this.restTimerRunning) { 
                    this.restTimer = 0; 
                    this.restInterval = setInterval(() => this.restTimer++, 1000); 
                } else clearInterval(this.restInterval); 
            },
            formatTimer(s) { if(s < 0) s = 0; return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; },
            async confirmFinishSession() {
                clearInterval(this.sessionInterval); this.finishModal = false; this.exitModal = false; this.loading = true; this.loadingText = "Analyzing Performance...";
                const flatLogs = [];
                this.activeRoutine.data.forEach(group => {
                    group.exercises.forEach(ex => {
                        const validSets = ex.sets.filter(s => s.done);
                        if (validSets.length > 0) flatLogs.push({ user_id: this.session.user.id, exercise_name: ex.name, protocol_name: this.activeRoutine.name, sets_data: validSets, duration_seconds: this.sessionTimer, created_at: new Date().toISOString() });
                    });
                });
                if(flatLogs.length) await _client.from('workout_logs').insert(flatLogs);
                if(this.stackTaken) {
                    const { data: inv } = await _client.from('inventory').select('*');
                    if(inv && inv.length) {
                        const updates = inv.map(i => _client.from('inventory').update({servings_left: Math.max(0, i.servings_left - 1)}).eq('id', i.id));
                        await Promise.all(updates);
                    }
                }
                localStorage.removeItem('constellation_active_session');
                await this.fetchHistory(); 
                this.view = 'dashboard'; // Will trigger safeUpdateHeatmap via watcher
                this.loading = false; 
                this.showToast("Victory", "Session archived.");
            }
        }
    }).mount('#app');
</script>
</body>
</html>
