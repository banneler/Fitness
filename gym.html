<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Performance | Constellation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Checkbox */
        .custom-checkbox { appearance: none; background-color: #1e293b; width: 1.5rem; height: 1.5rem; border-radius: 0.5rem; display: grid; place-content: center; transition: all 0.2s; }
        .custom-checkbox::before { content: ""; width: 0.75rem; height: 0.75rem; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #3b82f6; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }

        /* Toast Animation */
        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }

        /* PR GLOW EFFECT */
        .pr-active { 
            border-color: #eab308 !important; 
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
            color: #eab308 !important;
        }

        /* HEATMAP STYLES */
        .muscle-base { 
            fill: rgba(30, 41, 59, 0.1); 
            stroke: rgba(255, 255, 255, 0.2); 
            stroke-width: 1px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Dynamic States with "Ink" Glow */
        .fill-red-500 { 
            fill: rgba(239, 68, 68, 0.4) !important; 
            stroke: #ef4444 !important; 
            stroke-width: 1.5px;
            filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.6)); 
        }
        .fill-orange-500 { 
            fill: rgba(249, 115, 22, 0.3) !important;
            stroke: #f97316 !important;
            stroke-width: 1.2px;
        }
        .fill-blue-500 { 
            fill: rgba(59, 130, 246, 0.05) !important;
            stroke: rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body class="font-sans antialiased">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32">
    
    <div v-if="loading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">{{ loadingText }}</p>
        </div>
    </div>

    <transition name="toast">
        <div v-if="toast.visible" class="fixed bottom-24 left-6 right-6 glass border-blue-500/30 p-4 rounded-2xl shadow-2xl z-[250] flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                <i data-lucide="check" class="w-5 h-5"></i>
            </div>
            <div>
                <h4 class="text-sm font-black italic text-white uppercase">{{ toast.title }}</h4>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="logoutModal" class="fixed inset-0 z-[300] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="logoutModal = false"></div>
            <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-white/10 shadow-2xl">
                <h2 class="text-xl font-black italic uppercase text-center mb-2 text-white">System Logout</h2>
                <p class="text-xs text-slate-500 font-bold text-center mb-6">End current session?</p>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="logoutModal = false" class="py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="confirmLogout" class="py-3 rounded-xl bg-red-600 text-white font-black text-xs uppercase shadow-lg shadow-red-900/20 hover:bg-red-500 transition-colors">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <div v-if="view === 'dashboard'">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-black italic text-slate-200 uppercase">Performance</h1>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Progressive Overload</p>
            </div>
            <div class="flex gap-2">
                <button @click="generateAIWorkout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center border border-white/5 shadow-lg active:scale-95 transition-all text-purple-400 hover:text-purple-300 hover:border-purple-500/30">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </button>
                <button @click="logoutModal = true" class="w-12 h-12 glass rounded-2xl flex items-center justify-center border border-white/5 shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500 hover:border-red-500/30">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="glass p-6 rounded-[2.5rem] mb-8 border-t-4 border-t-blue-500 shadow-xl relative overflow-hidden">
            <div class="absolute inset-0 bg-blue-900/10 blur-3xl pointer-events-none"></div>
            
            <div class="flex items-center justify-between mb-6 relative z-10">
                <div class="flex items-center gap-2 opacity-80">
                    <i data-lucide="flame" class="w-4 h-4 text-blue-400"></i>
                    <h3 class="text-xs font-black uppercase tracking-widest">System Status</h3>
                </div>
                <div class="flex gap-3 text-[8px] font-bold uppercase tracking-wider">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Recov</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Ready</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500/50"></span> Cold</span>
                </div>
            </div>
            
            <div class="flex justify-around relative z-10 px-2">
                <svg version="1.0" class="h-64 w-auto" viewBox="0 0 260 280" xmlns="http://www.w3.org/2000/svg">
                    <g transform="translate(0.000000,280.000000) scale(0.100000,-0.100000)">
                        <path :class="['muscle-base', getMuscleClass('chest')]" d="M792,2563c-39-19-56-46-47-74c4-11,2-26-4-32c-7-9-6-26,5-57c22-65,16-88-33-116c-23-13-57-27-74-32c-56-14-71-47-76-159c-2-54-6-118-9-143s-7-124-10-220c-6-191-2-210,50-251c15-11,33-19,40-16c10,4,15-9,20-46c4-29,19-86,32-127c18-52,24-86,19-110c-3-19-8-66-11-105c-5-64-2-79,35-178c50-131,52-165,11-204c-50-47-43-52,90-52c71,0,122,4,126,10c3,6-9,23-27,39c-45,37-43,74,10,213c45,117,50,164,27,241c-14,45-13,53,9,121c13,40,30,102,36,138c8,42,16,64,24,61c16-6,62,32,79,65c16,31,21,327,6,366c-5,12-11,80-14,151c-4,71-9,138-12,149c-9,28-34,55-52,55c-8,0-41,12-73,26c-54,25-59,29-59,59c0,18,7,51,14,73c9,25,11,44,5,47c-5,4-9,21-9,39C920,2555,852,2592,792,2563z M887,2545c19-13,21-23,19-90c-1-63-5-78-26-100c-13-14-33-25-44-25c-29,0-76,46-76,73c0,13-6,29-12,36c-10,11-10,13,0,7c12-7,16,6,12,55C757,2551,838,2579,887,2545z M833,2320c14,0,33,7,41,16c21,21,21,2,1-56c-19-53-19-60,0-36c8,11,15,28,15,38s1,18,3,18s30-13,62-30c32-16,66-30,75-30c35,0,55-39,57-109c6-154,11-220,18-232c13-20,8-313-5-356c-15-45-70-91-70-58c0,6,6,10,12,10c20,0,41,52,29,72c-8,16-11,15-21-11c-6-16-12-27-14-25c-3,2-6,33-9,69c-2,36-10,88-17,115c-6,28-16,66-21,85c-4,19-6,44-4,55s7,43,11,70c6,43,8,46,15,25c4-14,7-57,8-97c1-48,8-90,22-125c11-29,18-62,16-73c-3-11-8-31-12-45c-5-17-1-14,14,12l20,37l-25,73c-16,48-24,92-23,128c1,30-4,86-10,124c-8,47-8,73-1,80c13,13,13,57-1,76c-8,11-9,7-4-17c4-22,1-40-11-58c-14-22-23-25-60-24c-24,2-46,0-49-3c-8-7,85-19,96-12c13,8,11-15-7-75c-8-28-13-60-9-70c3-11-3-25-14-36c-21-18-58-102-49-110c2-3,15,21,28,52c22,53,24,55,33,32c8-22,16-64,33-169c15-90,6-197-28-323c-17-64-23-75-34-66c-17,14-17,9-4-25c7-18,6-25-2-23c-6,1-14-10-19-25c-9-34-2-37,11-5c8,17,9,14,5-18c-3-22,0-47,6-55c8-12,9-10,4,8c-3,12-2,22,3,22c14,0,25-85,16-123c-3-18-24-76-45-130c-22-53-39-109-39-123c0-35,26-81,50-89c26-8,16-25-16-25c-15,0-24,6-24,15c0,8-4,15-10,15c-5,0-7-7-3-16c4-12,1-15-13-12c-16,3-19,11-18,48c1,25,2,88,2,140c-1,52,0,120,1,150c1,49,1,110-1,250c-1,25,0,61,2,80c1,19-1,81-5,138c-7,89-6,104,9,115s41,77,30,77c-3,0-12-16-20-35s-20-35-27-35c-18,0-37,21-37,41c0,10-5,21-10,24c-16,10,0-47,19-69c16-18,19-57,12-211c-5-122-5-294-1-365c2-25,1-88-2-140c-2-52-1-107,3-121c3-14,3-33-2-42c-6-10-5-18,2-23c8-4,7-9-2-15c-21-13-32-11-25,6c3,8,1,15-4,15c-6,0-10-7-10-15c0-10-10-15-30-15c-37,0-37,5,0,36c49,42,48,75-4,208c-46,118-53,163-36,231l8,30l1-30c1-22,4-26,10-15c6,8,7,28,5,45c-4,22-3,26,5,15c18-26,20-6,2,31c-14,27-15,41-8,55c9,17,9,17-6,6c-14-12-18-8-31,40c-37,127-56,292-37,326c8,15,8,22,1,22c-6,0-4,14,5,36c8,20,15,49,15,65c0,15,4,39,10,53c5,15,6,26,0,26c-5,0-14-26-20-57c-6-32-15-71-20-88c-5-16-10-58-11-92s-6-60-10-57c-5,3-9-1-9-8c0-9-3-9-10,2c-5,8-10,20-10,25c0,6,5,3,10-5s10-10,10-4c0,5-6,18-13,28c-11,15-13,14-15-13c-3-35,27-89,38-71c5,8,10,9,14,2c3-5-1-12-8-15c-22-9-66,31-66,59c0,13-4,24-9,24c-11,0-11,296,1,335c5,17,11,84,14,150c6,157,14,182,64,195c21,6,58,21,83,35l45,25l15-37c8-21,13-40,12-41c-2-2-20,1-39,8c-20,6-44,10-53,8c-10-2,3-9,29-17c59-17,82-10,72,21c-34,106-35,112-16,95C798,2327,818,2320,833,2320z M1061,1533c-12-20-14-14-5,12c4,9,9,14,11,11C1070,1554,1067,1543,1061,1533z" />
                    </g>
                </svg>

                <svg version="1.0" class="h-64 w-auto" viewBox="0 0 260 280" xmlns="http://www.w3.org/2000/svg">
                    <g transform="translate(0.000000,280.000000) scale(0.100000,-0.100000)">
                        <path :class="['muscle-base', getMuscleClass('back')]" d="M1740,2573c-29-11-60-47-60-70c0-14-4-33-10-43c-7-13-6-19,5-24c11-4,15,2,16,22c1,15,2,34,3,43c3,55,101,82,130,37c26-43,27-84,3-114c-18-23-18-27-4-21c19,7,21-9,7-53c-8-24-8-24-9-2c-1,12-5,22-11,22c-12,0-2-29,18-53c9-10,33-28,54-39c39-22,49-38,23-38c-8,0-15-4-15-10c0-14,11-12,34,5c21,16,47,20,45,8c-3-20,2-33,12-33c8,0,8,5-1,15c-7,8-8,15-2,15c30,0,49-90,57-272c2-37,6-71,9-76c7-12,0-309-9-344c-4-15-13-29-22-32c-8-3-11-11-7-18c5-8,2-9-9-5c-9,3-16,3-16-1c3-19-2-33-10-28c-5,4-8,14-7,24c2,9-2,20-8,24c-8,5-7,8,2,8c10,0,10,5,1,21c-6,12-8,36-4,56c6,32,2,59-26,183c-13,54-14,122-3,170c7,34,8,34,15,10c4-14,7-56,8-95c0-45,9-93,23-133c19-53,20-68,10-94c-16-44-8-46,13-2c16,35,16,38-5,87c-16,37-24,80-28,147c-8,138-6,168,12,195c19,29,21,61,4,71c-6,4-8,3-5-3c8-12-31-125-70-204c-22-43-25-55-11-42c17,15,18,15,17-3c-1-10-4-30-8-44c-5-16-3-31,5-40c15-18,21-112,10-150l-7-25l15,25c15,24,16,19,14-77c-2-55,0-99,5-96c4,2,7-1,7-6c0-6-4-11-9-11s-12-21-16-47c-4-27-18-83-32-126c-13-44-21-87-18-100c5-17,4-19-4-7c-6,8-11,25-11,38c0,12-5,22-10,22c-13,0-3-47,16-77c34-55,35-163,1-228c-10-19-10-19-18,0c-5,14-8,15-8,4c-1-8,3-19,9-25s-1-36-17-82c-25-71-26-74-9-109c11-23,22-33,31-29c31,12,23-14-9-29c-40-19-81-12-72,12c3,8,6,29,7,46c0,28,2,29,10,12c7-15,7-12,2,10c-14,54-9,357,7,390c16,35,22,97,8,89c-6-4-8-17-5-30c4-22-7-53-17-44c-7,8-16,350-10,376c5,19,11,21,43,17c30-4,43,0,69,22c18,15,32,31,32,37s-16-4-35-21c-39-34-52-37-89-20c-22,10-26,19-29,68l-3,56l-2-58c-2-52-5-58-28-67c-40-16-54-12-85,21c-16,17-29,27-29,22c0-6,12-23,26-38c22-24,31-27,71-22l45,5l-4-93c-1-51,0-91,5-88c4,2,7-6,7-19c0-19-2-20-11-8c-7,11-8,4-3-23c8-48-5-169-17-161c-6,3-9,13-8,22c3,36-2,47-12,23c-7-18-4-34,12-68c17-35,21-60,19-131c-1-48-1-93,0-99c8-83-2-161-22-180c-17-15-18-15-12,15c4,19-2,54-15,95c-21,62-20,93,3,109c7,5,4,8-6,8c-9,0-18-8-21-17c-3-14-7-11-17,12c-15,34-18,132-7,219c6,43,4,71-8,105c-28,85-46,185-52,294c-6,105-1,129,17,85l9-23v22c1,12-3,24-8,27c-11,7-2,94,12,121c6,11,11,22,10,25c-15,85-15,84,1,71c17-14,22-2,7,15c-14,15-81,188-81,209c0,14-3,16-11,8s-5-24,10-56c20-44,29-136,14-150c-4-4-6-31-4-60c1-32-6-75-19-111c-24-70-25-96-5-122c8-10,15-30,16-44c1-20,2-21,6-5c3,10-3,34-12,51c-17,31-17,35,4,95c12,35,21,90,22,123c0,34,3,79,8,101l7,40l9-30c12-41,14-123,4-160c-17-63-29-142-30-202c-1-35-6-63-11-63c-4,0-8,6-8,13c0,8-4,7-10-3s-8-2-4,28c3,25,1,42-6,42c-5,0-10-19-10-41c0-40,19-68,45-69c6,0,3,5-5,10c-9,6-10,10-3,10c21,0,24-19,4-29c-25-14-32-14-28,0c1,6-5,14-13,16c-13,4-13,3,0-7c12-9,12-11,1-8c-8,2-16,15-18,28s-8,28-13,35c-7,9-11,122-11,379c0,22,6,64,12,95c7,31,11,70,10,87c-3,44,16,111,34,117c10,4,12,1,8-10s-2-14,5-9c7,4,12,14,12,22c0,19,19,18,42-3c14-13,21-14,30-5s7,12-11,12c-20,0-21,2-11,15c7,8,17,12,23,8c5-3,7-1,4,4c-4,6,6,16,23,23c34,14,63,54,57,78c-3,11-5,9-6-7c-1-30-9-24-21,19c-8,28-7,31,8,25c14-5,14-4,5,6c-20,20-46,20-38,1c4-9,9-35,12-58c5-40,4-42-42-68c-26-14-56-26-66-26s-30-10-45-23c-24-21-28-34-36-113c-5-49-12-127-17-174c-11-111-5-368,9-417c23-77,80-116,93-65c3,10,5,4,6-13c0-16,14-79,30-139c27-99,28-114,19-175c-12-79-6-166,15-212c9-19,25-66,37-106c23-78,20-96-20-116c-36-18-34-31,7-49c49-21,142-22,183-2c37,19,37,45,0,54c-39,9-38,56,6,179c33,91,38,116,35,176c-7,174-2,220,45,383c3,9,9,10,22,3c29-15,68,42,82,119c13,73,11,370-3,445c-5,28-10,77-11,110c-2,33-6,69-9,80c-8,22-56,55-81,55c-8,0-36,14-62,31c-44,31-46,33-39,68c4,20,7,46,7,58c0,13,4,20,9,17s9,2,9,10s-5,18-10,21c-6,4-10,14-9,23C1860,2545,1796,2593,1740,2573z M1570,1469c0-13-28-18-33-6c-3,7,3,13,14,13S1570,1473,1570,1469z" />
                    </g>
                </svg>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-3">This Week</h3>
            <div class="flex gap-2 overflow-x-auto no-scrollbar snap-x">
                <div v-for="dayObj in upcomingDays" :key="dayObj.fullDate" 
                     @click="openScheduleModal(dayObj)"
                     class="snap-start flex-shrink-0 w-20 glass rounded-2xl p-3 flex flex-col items-center border border-white/5 relative group active:scale-95 transition-transform">
                    
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">{{ dayObj.dayName }}</span>
                    <span class="text-xs font-bold text-slate-300 mb-2">{{ dayObj.dateNum }}</span>
                    
                    <div v-if="getScheduleForDay(dayObj.dayName)" class="flex flex-col items-center">
                        <i :data-lucide="getScheduleForDay(dayObj.dayName).icon_name" class="w-5 h-5 text-blue-400 mb-1"></i>
                        <span class="text-[8px] font-bold text-center leading-tight truncate w-full text-blue-400">{{ getScheduleForDay(dayObj.dayName).name }}</span>
                    </div>
                    
                    <div v-else class="w-8 h-8 rounded-full border border-dashed border-slate-700 flex items-center justify-center">
                        <i data-lucide="plus" class="w-3 h-3 text-slate-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Protocols</h3>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button v-for="routine in routines" :key="routine.id" @click="previewRoutine(routine)" class="glass p-6 rounded-3xl text-left hover:border-blue-500/50 transition-all active:scale-95 group relative overflow-hidden">
                <div @click.stop="editRoutine(routine)" class="absolute top-3 right-3 p-2 bg-slate-950/50 rounded-full text-slate-500 hover:text-white hover:bg-blue-600 transition-all z-10">
                    <i data-lucide="pencil" class="w-3 h-3"></i>
                </div>

                <i :data-lucide="routine.icon_name" class="w-6 h-6 text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
                <div class="font-black text-xl italic truncate pr-4">{{ routine.name }}</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">{{ routine.exercise_order?.length || 0 }} Exercises</div>
            </button>
            
            <button @click="resetBuilder" class="glass p-6 rounded-3xl text-left hover:border-green-500/50 transition-all active:scale-95 group border-dashed border-slate-700">
                <i data-lucide="plus-circle" class="w-6 h-6 text-green-500 mb-3 group-hover:scale-110 transition-transform"></i>
                <div class="font-black text-xl italic text-slate-400">NEW</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Workout / Exercise</div>
            </button>
        </div>

        <div class="glass rounded-[2.5rem] p-8 shadow-2xl">
            <div class="flex items-center gap-2 mb-6 opacity-60">
                <i data-lucide="history" class="w-4 h-4 text-slate-400"></i>
                <h3 class="text-xs font-black uppercase tracking-widest">Recent Sessions</h3>
            </div>
            
            <div v-if="recentSessions.length === 0" class="text-center py-4 text-slate-600 text-xs italic">
                No recent activity found.
            </div>

            <div class="space-y-4">
                <div v-for="session in recentSessions" :key="session.id" class="flex justify-between items-center border-b border-white/5 pb-4 last:border-0">
                    <div>
                        <div class="font-black text-sm uppercase italic text-slate-200">{{ session.name }}</div>
                        <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-wider">{{ session.date }} â€¢ {{ session.volume }} sets</div>
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-green-500 text-xs">COMPLETED</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="view === 'builder'" class="flex-1 flex flex-col">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black italic uppercase">{{ newRoutine.id ? 'Edit Protocol' : 'Builder' }}</h2>
            <button @click="view = 'dashboard'" class="text-slate-400 hover:text-white font-bold text-xs uppercase">Cancel</button>
        </header>

        <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-white/5">
            <button @click="builderTab = 'routine'" :class="builderTab === 'routine' ? 'bg-blue-600 text-white' : 'text-slate-500'" class="flex-1 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all">Routine</button>
            <button @click="builderTab = 'exercise'" :class="builderTab === 'exercise' ? 'bg-blue-600 text-white' : 'text-slate-500'" class="flex-1 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all">Exercise</button>
        </div>

        <div v-if="builderTab === 'routine'" class="space-y-4 flex-1 overflow-y-auto pb-32">
            <input v-model="newRoutine.name" placeholder="Routine Name (e.g. Back Day)" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-600 focus:border-blue-500 outline-none">
            
            <div class="grid grid-cols-6 gap-2 bg-slate-900/50 p-4 rounded-xl border border-white/5">
                <button v-for="icon in iconLibrary" :key="icon" @click="newRoutine.icon = icon" :class="newRoutine.icon === icon ? 'text-blue-500 bg-blue-500/10' : 'text-slate-600'" class="p-2 rounded-lg flex justify-center hover:bg-white/5 transition-all">
                    <i :data-lucide="icon" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold uppercase text-slate-500">Select Exercises</p>
                
                <input type="text" v-model="exerciseSearch" placeholder="Filter exercises..." class="w-full bg-slate-950/50 border border-white/5 rounded-xl p-3 text-xs font-bold text-white outline-none focus:border-blue-500 mb-2 placeholder-slate-600">

                <div v-if="filteredExercises.length === 0" class="text-center py-4 text-slate-600 text-xs italic">
                    No matching exercises found.
                </div>
                <div v-for="ex in filteredExercises" :key="ex.id" @click="toggleExerciseInRoutine(ex.id)" :class="newRoutine.exercises.includes(ex.id) ? 'border-blue-500 bg-blue-500/10' : 'border-white/5 bg-slate-900/50'" class="p-3 rounded-xl border flex justify-between items-center transition-all cursor-pointer">
                    <div class="flex items-center gap-3">
                        <i :data-lucide="ex.icon_name || 'dumbbell'" class="w-4 h-4 text-slate-500"></i>
                        <span class="text-xs font-bold text-white">{{ ex.name }}</span>
                    </div>
                    <i v-if="newRoutine.exercises.includes(ex.id)" data-lucide="check" class="w-4 h-4 text-blue-500"></i>
                </div>
            </div>

            <button @click="saveRoutine" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-sm uppercase shadow-lg active:scale-95 transition-all mt-6">
                {{ newRoutine.id ? 'Update Protocol' : 'Save Protocol' }}
            </button>
            
            <button v-if="newRoutine.id" @click="deleteRoutine" class="w-full bg-slate-900 border border-red-900/30 text-red-500 py-4 rounded-2xl font-black text-sm uppercase shadow-lg active:scale-95 transition-all mt-2">
                Delete Protocol
            </button>
        </div>

        <div v-if="builderTab === 'exercise'" class="space-y-4">
            <input v-model="newExercise.name" placeholder="Exercise Name" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-600 focus:border-blue-500 outline-none">
            <input v-model="newExercise.group" placeholder="Muscle Group (e.g. Chest)" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-600 focus:border-blue-500 outline-none">
            
            <p class="text-[10px] font-bold uppercase text-slate-500 mt-4">Select Category Icon</p>
            <div class="grid grid-cols-6 gap-2 bg-slate-900/50 p-4 rounded-xl border border-white/5">
                <button v-for="icon in iconLibrary" :key="icon" @click="newExercise.icon = icon" :class="newExercise.icon === icon ? 'text-blue-500 bg-blue-500/10' : 'text-slate-600'" class="p-2 rounded-lg flex justify-center hover:bg-white/5 transition-all">
                    <i :data-lucide="icon" class="w-5 h-5"></i>
                </button>
            </div>

            <button @click="saveExercise" class="w-full bg-green-600 py-4 rounded-2xl font-black text-sm uppercase shadow-lg active:scale-95 transition-all mt-6">Add to Library</button>
        </div>
    </div>

    <transition name="modal">
        <div v-if="previewModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="previewModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 border border-blue-500/20">
                        <i :data-lucide="previewModal.icon_name" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black italic uppercase">{{ previewModal.name }}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{{ previewModal.exercises.length }} Movements</p>
                    </div>
                </div>

                <div class="space-y-2 mb-8 max-h-64 overflow-y-auto">
                    <div v-for="(exId, idx) in previewModal.exercise_order" :key="idx" class="flex items-center gap-3 p-3 bg-slate-950/50 rounded-xl border border-white/5">
                        <span class="text-xs font-mono text-slate-600">0{{idx+1}}</span>
                        <span class="text-sm font-bold text-slate-300">{{ getExerciseName(exId) }}</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="previewModal = null" class="py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
                    <button @click="startActiveSession(previewModal)" class="py-3 rounded-xl bg-blue-600 text-white font-black text-xs uppercase shadow-lg shadow-blue-900/20">Start Session</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="scheduleModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="scheduleModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <h2 class="text-xl font-black italic uppercase mb-2">Schedule Protocol</h2>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-6">For {{ scheduleModal.dayName }} {{ scheduleModal.dateNum }}</p>

                <div class="space-y-2 max-h-64 overflow-y-auto mb-6">
                    <button @click="saveSchedule(null)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 text-slate-500 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">
                        Rest Day (Clear)
                    </button>
                    <button v-for="routine in routines" :key="routine.id" @click="saveSchedule(routine)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                        <i :data-lucide="routine.icon_name" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-white font-bold text-sm uppercase italic">{{ routine.name }}</span>
                    </button>
                </div>
                
                <button @click="scheduleModal = null" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Close</button>
            </div>
        </div>
    </transition>

    <div v-if="view === 'active_session'" class="flex-1 flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span class="text-[10px] text-red-500 font-black uppercase tracking-widest">LIVE</span>
                </div>
                <h2 class="text-2xl font-black italic uppercase">{{ activeRoutine.name }}</h2>
            </div>
            <div class="font-mono text-xl font-bold text-slate-400">{{ formatTimer(sessionTimer) }}</div>
        </div>

        <div class="flex-1 space-y-6 mb-24 overflow-y-auto">
            <div v-for="(exercise, exIndex) in activeRoutine.data" :key="exIndex" class="glass p-5 rounded-3xl border border-white/10">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <i :data-lucide="exercise.icon || 'dumbbell'" class="w-5 h-5 text-blue-500"></i>
                        <h3 class="font-black text-lg italic text-blue-400">{{ exercise.name }}</h3>
                    </div>
                    <span v-if="exercise.isPR" class="bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded text-[8px] font-black uppercase tracking-widest border border-yellow-500/50 animate-pulse">NEW PR!</span>
                </div>
                
                <div class="grid grid-cols-12 gap-2 text-[8px] text-slate-500 font-black uppercase tracking-widest mb-2 text-center">
                    <div class="col-span-2">Set</div>
                    <div class="col-span-4">lbs</div>
                    <div class="col-span-4">Reps</div>
                    <div class="col-span-2">Done</div>
                </div>

                <div v-for="(set, setIndex) in exercise.sets" :key="setIndex" class="grid grid-cols-12 gap-2 mb-2 items-center">
                    <div class="col-span-2 flex justify-center">
                        <div class="w-6 h-6 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-400">{{ setIndex + 1 }}</div>
                    </div>
                    <div class="col-span-4">
                        <input type="number" 
                               v-model="set.weight" 
                               @input="checkPR(exercise, set.weight)"
                               class="w-full bg-slate-900 rounded-lg p-2 text-center font-bold text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                               :class="{'pr-active': set.weight > (exercise.personalRecord || 0)}"
                               placeholder="-">
                    </div>
                    <div class="col-span-4"><input type="number" v-model="set.reps" class="w-full bg-slate-900 rounded-lg p-2 text-center font-bold text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="-"></div>
                    <div class="col-span-2 flex justify-center"><input type="checkbox" v-model="set.done" class="custom-checkbox"></div>
                </div>
                <button @click="addSet(exIndex)" class="w-full py-2 mt-2 border border-dashed border-slate-700 rounded-xl text-[10px] text-slate-500 font-black uppercase tracking-widest hover:border-blue-500 hover:text-blue-500">+ Add Set</button>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 p-6 safe-area-bottom z-[50]">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button @click="toggleRestTimer" :class="restTimerRunning ? 'bg-red-500/20 text-red-500 border-red-500/50 timer-active' : 'bg-slate-800 text-slate-400 border-transparent'" class="h-12 w-12 rounded-2xl border flex items-center justify-center transition-all">
                        <i data-lucide="timer" class="w-6 h-6"></i>
                    </button>
                    <div v-if="restTimerRunning" class="text-2xl font-black font-mono text-white">{{ formatTimer(restTimer) }}</div>
                </div>
                <label class="flex items-center gap-3 cursor-pointer">
                    <span class="text-[10px] font-black uppercase tracking-widest text-right"><span class="block text-slate-500">Inventory</span><span :class="stackTaken ? 'text-purple-400' : 'text-slate-600'">Stack Taken?</span></span>
                    <div class="relative"><input type="checkbox" v-model="stackTaken" class="sr-only peer"><div class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div></div>
                </label>
            </div>
            <button @click="finishSession" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">FINISH WORKOUT</button>
        </div>
    </div>

    <nav v-if="view === 'dashboard'" class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
        <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
        <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
        <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
        <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
    </nav>

</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient(
        'https://mvoyrchefjcpjkdtezmz.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ'
    );

    const ICONS = ['dumbbell', 'biceps-flexed', 'weight', 'disc', 'anchor', 'sword', 'shield', 'arrow-up-circle', 'arrow-down-circle', 'move', 'layers', 'columns-2', 'footprints', 'bike', 'waves', 'zap', 'activity', 'trophy'];

    createApp({
        data() { 
            return { 
                loading: true, 
                loadingText: 'Syncing Protocols',
                session: null,
                view: 'dashboard', 
                builderTab: 'routine',
                toast: { visible: false, title: '', message: '' },
                logoutModal: false,
                
                routines: [], 
                libraryExercises: [], 
                schedule: [], 
                recentSessions: [],
                rawLogs: [], 
                iconLibrary: ICONS,
                daysOfWeek: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                
                muscleHeatmap: { 
                    'chest': {color: 'fill-blue-500', lastTrained: null}, 
                    'back': {color: 'fill-blue-500', lastTrained: null}, 
                    'legs': {color: 'fill-blue-500', lastTrained: null}, 
                    'arms': {color: 'fill-blue-500', lastTrained: null}, 
                    'shoulders': {color: 'fill-blue-500', lastTrained: null},
                    'core': {color: 'fill-blue-500', lastTrained: null}
                },

                scheduleModal: null, 
                previewModal: null,

                newRoutine: { id: null, name: '', icon: 'activity', exercises: [] },
                newExercise: { name: '', group: '', icon: 'dumbbell' },
                exerciseSearch: '',

                activeRoutine: { name: '', data: [] },
                stackTaken: false,
                sessionTimer: 0, 
                sessionInterval: null,
                restTimer: 0, 
                restTimerRunning: false, 
                restInterval: null,
                personalRecords: {} 
            } 
        },
        computed: {
            upcomingDays() {
                const days = [];
                for(let i=0; i<7; i++) {
                    const d = new Date(); 
                    d.setDate(d.getDate() + i);
                    days.push({ 
                        dateNum: d.getDate(), 
                        dayName: d.toLocaleDateString('en-US', {weekday:'short'}), 
                        fullDate: d.toISOString().split('T')[0] 
                    });
                }
                return days;
            },
            filteredExercises() {
                if (!this.exerciseSearch) return this.libraryExercises;
                const search = this.exerciseSearch.toLowerCase();
                return this.libraryExercises.filter(ex => ex.name.toLowerCase().includes(search));
            }
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            this.session = session;
            
            await Promise.all([
                this.fetchRoutines(), 
                this.fetchExercises(), 
                this.fetchSchedule(), 
                this.fetchHistory()
            ]);
            
            this.calculateHeatmap();
            this.loading = false;
            this.$nextTick(() => lucide.createIcons());
        },
        updated() { this.$nextTick(() => lucide.createIcons()); },
        methods: {
            getMuscleClass(group) {
                return this.muscleHeatmap[group]?.color || 'fill-blue-500';
            },
            async confirmLogout() { 
                await _client.auth.signOut(); 
                window.location.href = 'index.html'; 
            },
            showToast(title, message) { 
                this.toast = { visible: true, title, message }; 
                setTimeout(() => this.toast.visible = false, 3000); 
            },
            
            async fetchRoutines() { 
                const { data } = await _client.from('routines').select('*').order('created_at'); 
                this.routines = data || []; 
            },
            async fetchExercises() { 
                const { data } = await _client.from('exercises').select('*').order('name'); 
                this.libraryExercises = data || []; 
            },
            async fetchSchedule() { 
                const { data } = await _client.from('schedule').select('*, routines(name, icon_name)'); 
                this.schedule = data || []; 
            },
            async fetchHistory() {
                const { data: rawData } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false }).limit(300);
                this.rawLogs = rawData || [];

                if (!this.rawLogs.length) { 
                    this.recentSessions = []; 
                    return; 
                }
                
                const sessions = []; 
                let currentSession = null;
                
                this.rawLogs.forEach((log) => {
                    const logTime = new Date(log.created_at).getTime();
                    
                    if(log.sets_data) {
                        log.sets_data.forEach(s => {
                            if(s.weight > (this.personalRecords[log.exercise_name] || 0)) {
                                this.personalRecords[log.exercise_name] = s.weight;
                            }
                        });
                    }

                    if (!currentSession) {
                        currentSession = { 
                            id: log.id, 
                            startTime: logTime, 
                            name: log.protocol_name || (log.exercise_name.includes('Recovery') ? 'Recovery Session' : 'Training Session'), 
                            date: new Date(log.created_at).toLocaleDateString(), 
                            volume: 1 
                        };
                    } else {
                        const diffMins = Math.abs(currentSession.startTime - logTime) / (1000 * 60);
                        if (diffMins < 60) {
                            currentSession.volume++;
                        } else { 
                            sessions.push(currentSession); 
                            currentSession = { 
                                id: log.id, 
                                startTime: logTime, 
                                name: log.protocol_name || (log.exercise_name.includes('Recovery') ? 'Recovery Session' : 'Training Session'), 
                                date: new Date(log.created_at).toLocaleDateString(), 
                                volume: 1 
                            }; 
                        }
                    }
                });
                
                if (currentSession) sessions.push(currentSession);
                this.recentSessions = sessions.slice(0, 5);
            },

            calculateHeatmap() {
                const now = new Date().getTime();
                const oneDay = 1000 * 60 * 60 * 24;

                for(let m in this.muscleHeatmap) this.muscleHeatmap[m].lastTrained = null;

                this.rawLogs.forEach(log => {
                    const exDef = this.libraryExercises.find(e => e.name === log.exercise_name);
                    if(exDef && exDef.muscle_group) {
                        let groupKey = exDef.muscle_group.toLowerCase();
                        if(['quads', 'hamstrings', 'glutes', 'calves'].includes(groupKey)) groupKey = 'legs';
                        if(['lats', 'traps', 'lower back'].includes(groupKey)) groupKey = 'back';
                        if(['biceps', 'triceps', 'forearms'].includes(groupKey)) groupKey = 'arms';

                        if(this.muscleHeatmap[groupKey]) {
                             const logTime = new Date(log.created_at).getTime();
                             if(!this.muscleHeatmap[groupKey].lastTrained || logTime > this.muscleHeatmap[groupKey].lastTrained) {
                                 this.muscleHeatmap[groupKey].lastTrained = logTime;
                             }
                        }
                    }
                });

                for(let m in this.muscleHeatmap) {
                    if(this.muscleHeatmap[m].lastTrained) {
                        const daysSince = (now - this.muscleHeatmap[m].lastTrained) / oneDay;
                        if(daysSince < 2) this.muscleHeatmap[m].color = 'fill-red-500 animate-pulse'; 
                        else if(daysSince < 4) this.muscleHeatmap[m].color = 'fill-orange-500';
                        else this.muscleHeatmap[m].color = 'fill-blue-500';
                    } else {
                         this.muscleHeatmap[m].color = 'fill-blue-500';
                    }
                }
            },

            async generateAIWorkout() {
                this.loading = true;
                this.loadingText = "Analyzing Biometrics...";
                
                try {
                    const { data, error } = await _client.functions.invoke('ai-workout-generator');
                    if(error) throw error;
                    
                    if(data && data.routine) {
                        this.showToast("AI Generated", "Gap Filler Protocol Created");
                        await this.fetchRoutines();
                    }
                } catch (e) {
                    console.error(e);
                    setTimeout(async () => {
                        const fillerExercises = this.libraryExercises.slice(0, 3).map(e => e.id);
                        if(fillerExercises.length) {
                            await _client.from('routines').insert([{ name: 'AI Gap Filler', icon_name: 'zap', exercise_order: fillerExercises, user_id: this.session.user.id }]);
                            await this.fetchRoutines();
                            this.showToast("AI Generated", "Gap Filler Protocol Created");
                        } else {
                            this.showToast("Error", "Create exercises first");
                        }
                        this.loading = false;
                    }, 1500);
                    return; 
                }
                this.loading = false;
            },

            getScheduleForDay(dayName) { 
                const entry = this.schedule.find(s => s.day_of_week === dayName); 
                return entry ? { name: entry.routines.name, icon_name: entry.routines.icon_name } : null; 
            },
            openScheduleModal(dayObj) { this.scheduleModal = dayObj; },
            async saveSchedule(routine) {
                if (!this.scheduleModal) return;
                const day = this.scheduleModal.dayName; 
                if (routine) await _client.from('schedule').upsert({ user_id: this.session.user.id, day_of_week: day, routine_id: routine.id }, { onConflict: 'user_id, day_of_week' });
                else await _client.from('schedule').delete().eq('user_id', this.session.user.id).eq('day_of_week', day);
                this.scheduleModal = null; 
                this.fetchSchedule(); 
                this.showToast('Schedule Updated', routine ? `${routine.name} set` : 'Rest day assigned');
            },

            resetBuilder() { 
                this.newRoutine = { id: null, name: '', icon: 'activity', exercises: [] }; 
                this.builderTab = 'routine'; 
                this.exerciseSearch = ''; 
                this.view = 'builder'; 
            },
            editRoutine(routine) { 
                this.newRoutine = { 
                    id: routine.id, 
                    name: routine.name, 
                    icon: routine.icon_name, 
                    exercises: [...(routine.exercise_order || [])] 
                }; 
                this.builderTab = 'routine'; 
                this.exerciseSearch = ''; 
                this.view = 'builder'; 
            },
            toggleExerciseInRoutine(id) { 
                const idx = this.newRoutine.exercises.indexOf(id); 
                if (idx > -1) this.newRoutine.exercises.splice(idx, 1); 
                else this.newRoutine.exercises.push(id); 
            },
            
            async saveExercise() {
                if(!this.newExercise.name) return;
                const muscleGroup = this.newExercise.group.toLowerCase();
                const payload = { 
                    name: this.newExercise.name, 
                    muscle_group: muscleGroup, 
                    icon_name: this.newExercise.icon || 'dumbbell', 
                    user_id: this.session.user.id 
                };
                await _client.from('exercises').insert([payload]);
                this.newExercise = { name: '', group: '', icon: 'dumbbell' }; 
                await this.fetchExercises();
                this.showToast("Library Updated", "Exercise added.");
            },
            async saveRoutine() {
                if(!this.newRoutine.name) return;
                const payload = { 
                    name: this.newRoutine.name, 
                    icon_name: this.newRoutine.icon, 
                    exercise_order: this.newRoutine.exercises, 
                    user_id: this.session.user.id 
                };
                if (this.newRoutine.id) { 
                    await _client.from('routines').update(payload).eq('id', this.newRoutine.id); 
                    this.showToast('Protocol Updated', 'Routine saved'); 
                } else { 
                    await _client.from('routines').insert([payload]); 
                    this.showToast('Protocol Created', 'New workout available'); 
                }
                this.fetchRoutines(); 
                this.view = 'dashboard';
            },
            async deleteRoutine() {
                if(confirm("Delete this protocol?")) {
                    await _client.from('routines').delete().eq('id', this.newRoutine.id);
                    this.fetchRoutines();
                    this.view = 'dashboard';
                    this.showToast('Deleted', 'Protocol removed');
                }
            },

            getExerciseName(id) { 
                const ex = this.libraryExercises.find(e => e.id === id); 
                return ex ? ex.name : 'Unknown Exercise'; 
            },
            previewRoutine(routine) { 
                this.previewModal = { ...routine, exercises: routine.exercise_order || [] }; 
            },
            startActiveSession(routine) {
                this.previewModal = null; 
                this.view = 'active_session';
                
                const exercises = (routine.exercise_order || []).map(id => {
                    const exDef = this.libraryExercises.find(e => e.id === id);
                    const pr = exDef ? (this.personalRecords[exDef.name] || 0) : 0;
                    return { 
                        name: exDef ? exDef.name : 'Exercise', 
                        icon: exDef ? exDef.icon_name : 'dumbbell', 
                        personalRecord: pr, 
                        isPR: false, 
                        sets: [{weight:0, reps:0, done:false}, {weight:0, reps:0, done:false}, {weight:0, reps:0, done:false}] 
                    };
                });
                
                this.activeRoutine = { name: routine.name, data: exercises };
                this.sessionTimer = 0; 
                this.sessionInterval = setInterval(() => { this.sessionTimer++ }, 1000);
            },
            checkPR(exercise, weight) {
                if(weight > exercise.personalRecord) exercise.isPR = true;
                else exercise.isPR = false;
            },
            addSet(exIndex) { 
                const prev = this.activeRoutine.data[exIndex].sets.slice(-1)[0]; 
                this.activeRoutine.data[exIndex].sets.push({ weight: prev?.weight||0, reps: prev?.reps||0, done: false }); 
            },
            toggleRestTimer() { 
                this.restTimerRunning = !this.restTimerRunning; 
                if(this.restTimerRunning) { 
                    this.restTimer = 0; 
                    this.restInterval = setInterval(() => this.restTimer++, 1000); 
                } else clearInterval(this.restInterval); 
            },
            formatTimer(s) { 
                return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; 
            },
            
            async finishSession() {
                if(!confirm("Finish Workout?")) return;
                clearInterval(this.sessionInterval);
                this.loading = true;
                this.loadingText = "Analyzing Performance...";
                
                const logs = this.activeRoutine.data.map(ex => ({ 
                    user_id: this.session.user.id, 
                    exercise_name: ex.name, 
                    protocol_name: this.activeRoutine.name, 
                    sets_data: ex.sets.filter(s => s.done), 
                    created_at: new Date().toISOString() 
                })).filter(l => l.sets_data.length);

                if(logs.length) await _client.from('workout_logs').insert(logs);
                
                if(this.stackTaken) {
                    const { data: inv } = await _client.from('inventory').select('*');
                    const updates = inv.map(i => _client.from('inventory').update({servings_left: Math.max(0, i.servings_left - 1)}).eq('id', i.id));
                    await Promise.all(updates);
                }

                await this.fetchHistory(); 
                this.calculateHeatmap(); 
                this.view = 'dashboard'; 
                this.loading = false;
                this.showToast("Victory", "Session archived.");
            }
        }
    }).mount('#app');
</script>
</body>
</html>
