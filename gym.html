<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#020617">
    
    <title>Performance | Constellation</title>

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Layout */
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-solid { background: #020617; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* DYNAMIC ISLAND FIX: Adds safe area + 20px breathing room */
        .pt-safe-offset { padding-top: calc(env(safe-area-inset-top) + 20px); }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }

        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* POLISH: Smooth View Transitions */
        .view-enter-active, .view-leave-active { transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-enter-from, .view-leave-to { opacity: 0; transform: scale(0.98); }

        /* Inputs */
        .custom-checkbox { appearance: none; background-color: #1e293b; width: 1.5rem; height: 1.5rem; border-radius: 0.5rem; display: grid; place-content: center; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .custom-checkbox::before { content: ""; width: 0.75rem; height: 0.75rem; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .failure-checkbox { appearance: none; width: 1.2rem; height: 1.2rem; background-color: #334155; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>') no-repeat center / contain; mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>') no-repeat center / contain; transition: all 0.2s; }
        .failure-checkbox:checked { background-color: #ef4444; filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.8)); }

        /* Cards */
        .exercise-card { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform, opacity, filter; }
        .exercise-blurred { opacity: 0.3; filter: grayscale(100%); transform: scale(0.96); pointer-events: none; }
        .exercise-active { opacity: 1; filter: none; transform: scale(1); border-color: rgba(59, 130, 246, 0.4); background: rgba(30, 41, 59, 0.6); box-shadow: 0 0 40px -10px rgba(59, 130, 246, 0.15); }

        /* Wheel */
        .picker-container { height: 200px; position: relative; mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); display: flex; }
        .wheel-col { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; text-align: center; }
        .wheel-item { height: 50px; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: #64748b; transition: all 0.2s; }
        .wheel-item-active { color: #3b82f6; font-size: 2rem; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .wheel-highlight { position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%); border-top: 1px solid rgba(59, 130, 246, 0.3); border-bottom: 1px solid rgba(59, 130, 246, 0.3); pointer-events: none; background: rgba(59, 130, 246, 0.05); z-index: 10; }

        /* Reactive Muscle Classes */
        .muscle-base { fill: #1e293b; stroke: rgba(255, 255, 255, 0.1); stroke-width: 1px; transition: all 0.6s ease; }
        .st0 { fill: #1e293b; stroke: rgba(255, 255, 255, 0.1); stroke-width: 1px; transition: all 0.6s ease; }
        
        .muscle-fresh { fill: #3b82f6 !important; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); }
        .muscle-fresh path { fill: #3b82f6 !important; }
        
        .muscle-tired { fill: #f97316 !important; }
        .muscle-tired path { fill: #f97316 !important; }
        
        .muscle-recov { fill: #ef4444 !important; }
        .muscle-recov path { fill: #ef4444 !important; }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(100%); }
        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950">
<div id="app" v-cloak class="h-[100dvh] w-screen flex flex-col overflow-hidden">
    
    <div v-if="loading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">{{ loadingText }}</p>
        </div>
    </div>

    <transition name="toast">
        <div v-if="toast.visible" class="fixed top-6 left-6 right-6 glass p-4 rounded-2xl shadow-2xl z-[250] flex items-center gap-4 border-l-4 border-blue-500">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <div>
                <h4 class="text-xs font-black italic text-white uppercase">{{ toast.title }}</h4>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <transition name="view" mode="out-in">
        
        <div v-if="view === 'dashboard'" class="flex flex-col h-full w-full">
            <div class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 pt-safe-offset">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-black italic text-blue-500 uppercase">Performance</h1>
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Progressive Overload</p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generateAIWorkout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-purple-400 hover:text-purple-300"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                        <button @click="confirmLogout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </header>

                <div class="glass p-6 rounded-[2.5rem] mb-8 border-t-4 border-t-blue-500 shadow-xl relative overflow-hidden">
                    <div class="absolute inset-0 bg-blue-900/10 blur-3xl pointer-events-none"></div>
                    <div class="flex items-center justify-between mb-6 relative z-10">
                        <div class="flex items-center gap-2 opacity-80">
                            <i data-lucide="flame" class="w-4 h-4 text-blue-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest">System Status</h3>
                        </div>
                        <div class="flex gap-3 text-[8px] font-bold uppercase tracking-wider">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Recov</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Ready</span>
                        </div>
                    </div>
                    <div class="flex justify-center relative z-10 px-2">
                        <heatmap-svg :statuses="muscleHeatmap"></heatmap-svg>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-3">This Week</h3>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar snap-x">
                        <div v-for="dayObj in upcomingDays" :key="dayObj.fullDate" @click="openScheduleModal(dayObj)" class="snap-start flex-shrink-0 w-20 glass rounded-2xl p-3 flex flex-col items-center border border-white/5 relative group active:scale-95 transition-transform">
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">{{ dayObj.dayName }}</span>
                            <span class="text-xs font-bold text-slate-300 mb-2">{{ dayObj.dateNum }}</span>
                            <div v-if="getScheduleForDay(dayObj.dayName)" class="flex flex-col items-center">
                                <i :data-lucide="getScheduleForDay(dayObj.dayName).icon_name" class="w-5 h-5 text-blue-400 mb-1"></i>
                                <span class="text-[8px] font-bold text-center leading-none whitespace-normal break-words w-full text-blue-400">{{ getScheduleForDay(dayObj.dayName).name }}</span>
                            </div>
                            <div v-else class="w-8 h-8 rounded-full border border-dashed border-slate-700 flex items-center justify-center">
                                <i data-lucide="plus" class="w-3 h-3 text-slate-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Protocols</h3>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button v-for="routine in routines" :key="routine.id" @click="previewRoutine(routine)" class="glass p-6 rounded-3xl text-left hover:border-blue-500/50 transition-all active:scale-95 group relative overflow-hidden">
                        <a :href="'builder.html?edit=' + routine.id" @click.stop class="absolute top-3 right-3 p-2 bg-slate-950/50 rounded-full text-slate-500 hover:text-white hover:bg-blue-600 transition-all z-10">
                            <i data-lucide="pencil" class="w-3 h-3"></i>
                        </a>
                        <i :data-lucide="routine.icon_name" class="w-6 h-6 text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <div class="font-black text-lg italic leading-tight mb-1 pr-6 break-words">{{ routine.name }}</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">{{ routine.exercise_order?.length || 0 }} Exercises</div>
                    </button>
                    <a href="builder.html" class="glass p-6 rounded-3xl text-left hover:border-green-500/50 transition-all active:scale-95 group border-dashed border-slate-700">
                        <i data-lucide="plus-circle" class="w-6 h-6 text-green-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <div class="font-black text-xl italic text-slate-400">NEW</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Workout / Exercise</div>
                    </a>
                </div>

                <div class="glass rounded-[2.5rem] p-8 shadow-2xl pb-24">
                    <div class="flex items-center gap-2 mb-6 opacity-60">
                        <i data-lucide="history" class="w-4 h-4 text-slate-400"></i>
                        <h3 class="text-xs font-black uppercase tracking-widest">Recent Sessions</h3>
                    </div>
                    <div v-if="recentSessions.length === 0" class="text-center py-4 text-slate-600 text-xs italic">No recent activity found.</div>
                    <div class="space-y-4">
                        <div v-for="session in recentSessions" :key="session.id" class="flex justify-between items-center border-b border-white/5 pb-4 last:border-0">
                            <div>
                                <div class="font-black text-sm uppercase italic text-slate-200">{{ session.name }}</div>
                                <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-wider">
                                    {{ session.date }} • {{ session.exerciseCount }} Exercises • {{ session.volume }} Sets
                                </div>
                            </div>
                            <div class="text-right"><span class="block font-black text-green-500 text-xs">COMPLETED</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
                <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
                <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
                <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
                <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
            </nav>
        </div>

        <div v-else-if="view === 'active_session'" class="flex flex-col h-full w-full bg-slate-950">
            
            <div class="glass-solid p-4 pt-safe-top z-30 shadow-2xl flex-none">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                            <span class="text-[10px] text-red-500 font-black uppercase tracking-widest">LIVE</span>
                        </div>
                        <h2 class="text-xl font-black italic uppercase leading-none">{{ activeRoutine.name }}</h2>
                    </div>
                    <div class="font-mono text-2xl font-bold text-slate-300 tracking-tight">{{ formatTimer(sessionTimer) }}</div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-6 scroll-smooth" id="session-container">
                <div v-for="(group, groupIdx) in activeRoutine.data" 
                     :key="groupIdx" 
                     :id="'cluster-' + groupIdx"
                     @click="activeExerciseIdx = groupIdx"
                     class="exercise-card rounded-3xl border border-white/5 relative p-1"
                     :class="activeExerciseIdx === groupIdx ? 'exercise-active' : 'exercise-blurred'">
                    
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center border border-white/10 shadow-lg">
                                    <i :data-lucide="group.exercises[0].icon || 'dumbbell'" class="w-5 h-5 text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-lg italic text-white leading-none mb-1">
                                        <span v-for="(ex, i) in group.exercises" :key="i">
                                            {{ ex.name }}<span v-if="i < group.exercises.length - 1" class="text-slate-500"> + </span>
                                            <button @click.stop="openSwapModal(groupIdx, i)" class="ml-1 text-slate-600 hover:text-blue-400 transition-colors"><i data-lucide="refresh-cw" class="w-3 h-3 inline"></i></button>
                                        </span>
                                    </h3>
                                    <div class="flex gap-2">
                                        <span class="text-[9px] font-bold uppercase text-slate-500 bg-slate-900 px-2 py-0.5 rounded tracking-wider">{{ isBodyWeight(group.exercises[0].weightType) ? 'Bodyweight' : (group.exercises[0].weightType === 'per_side' ? 'Per Side' : 'Total') }}</span>
                                        <span v-if="group.exercises[0].personalRecord > 0" class="text-[9px] font-bold uppercase text-yellow-500 bg-yellow-500/10 px-2 py-0.5 rounded tracking-wider border border-yellow-500/20">PR: {{ group.exercises[0].personalRecord }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-[10px] font-black text-slate-700 bg-slate-900 px-2 py-1 rounded-lg">#{{ groupIdx + 1 }}</div>
                        </div>
                        
                        <div class="grid grid-cols-12 gap-2 text-[8px] text-slate-500 font-black uppercase tracking-widest mb-2 text-center">
                            <div class="col-span-1">#</div>
                            <div class="col-span-1">Ex</div>
                            <div class="col-span-4">lbs</div>
                            <div class="col-span-3">Reps</div>
                            <div class="col-span-2">Done</div>
                            <div class="col-span-1"><i data-lucide="skull" class="w-3 h-3 mx-auto"></i></div>
                        </div>

                        <template v-for="(n, i) in getMaxSets(group)" :key="i">
                            <div v-for="(ex, exIdx) in group.exercises" :key="ex.id + '-' + i" 
                                 class="grid grid-cols-12 gap-2 mb-2 items-center relative" 
                                 :class="{'mt-3 pt-3 border-t border-white/5': i > 0 && exIdx === 0}">
                                
                                <div class="col-span-1 flex justify-center">
                                    <div class="w-5 h-5 rounded-full bg-slate-800 flex items-center justify-center text-[9px] font-bold text-slate-500">{{ i + 1 }}</div>
                                </div>
                                
                                <div class="col-span-1 flex justify-center">
                                    <i :data-lucide="ex.icon || 'dumbbell'" class="w-3 h-3 text-slate-600"></i>
                                </div>

                                <div class="col-span-4" v-if="ex.sets[i]">
                                    <button v-if="!isBodyWeight(ex.weightType)" @click="openDualPicker(ex.sets[i], ex.weightType)" class="w-full bg-slate-950/50 border border-white/5 rounded-lg p-2.5 text-center font-bold text-sm text-white focus:ring-1 focus:ring-blue-500 transition-all hover:bg-slate-900 relative active:scale-95">
                                        <span v-if="ex.sets[i].weight !== ''">{{ ex.sets[i].weight }}</span>
                                        <span v-else class="text-slate-700">{{ ex.sets[i].prevWeight || '-' }}</span>
                                    </button>
                                    <div v-else class="w-full bg-slate-900/30 border border-white/5 rounded-lg p-2.5 text-center font-black text-[10px] text-slate-600 tracking-wider cursor-not-allowed">
                                        BW
                                    </div>
                                </div>

                                <div class="col-span-3" v-if="ex.sets[i]">
                                    <button @click="openDualPicker(ex.sets[i], ex.weightType)" class="w-full bg-slate-950/50 border border-white/5 rounded-lg p-2.5 text-center font-bold text-sm text-white focus:ring-1 focus:ring-blue-500 transition-all hover:bg-slate-900 relative active:scale-95">
                                        <span v-if="ex.sets[i].reps">{{ ex.sets[i].reps }}</span>
                                        <span v-else class="text-slate-700">{{ ex.sets[i].prevReps || '-' }}</span>
                                    </button>
                                </div>

                                <div class="col-span-2 flex justify-center" v-if="ex.sets[i]">
                                    <input type="checkbox" v-model="ex.sets[i].done" @change="haptic" class="custom-checkbox">
                                </div>
                                <div class="col-span-1 flex justify-center" v-if="ex.sets[i]">
                                    <input type="checkbox" v-model="ex.sets[i].failure" @change="haptic" class="failure-checkbox">
                                </div>
                            </div>
                        </template>
                        
                        <div v-if="activeExerciseIdx === groupIdx" class="flex gap-2 mt-4">
                             <button @click.stop="addSetToGroup(groupIdx)" class="flex-1 py-3 border border-dashed border-slate-700 rounded-xl text-[10px] text-slate-500 font-black uppercase tracking-widest hover:border-blue-500 hover:text-blue-500">+ Set</button>
                        </div>
                    </div>
                </div>
                <div class="h-10"></div>
            </div>

            <div class="glass flex-none p-4 pb-safe-bottom z-30">
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button @click="prevExercise" :disabled="activeExerciseIdx === 0" class="col-span-1 h-12 rounded-2xl bg-slate-800/80 flex items-center justify-center text-slate-400 disabled:opacity-30 disabled:cursor-not-allowed active:scale-95 transition-all">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    
                    <button v-if="activeExerciseIdx < activeRoutine.data.length - 1" @click="nextExercise" class="col-span-2 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-black uppercase tracking-wider text-sm shadow-lg shadow-blue-900/20 active:scale-95 transition-all">
                        Next
                    </button>
                    <button v-else @click="finishModal = true" class="col-span-2 h-12 bg-green-600 rounded-2xl flex items-center justify-center text-white font-black uppercase tracking-wider text-sm shadow-lg shadow-green-900/20 active:scale-95 transition-all">
                        Finish
                    </button>

                    <button @click="toggleRestTimer" :class="restTimerRunning ? 'bg-red-500/20 border-red-500/50' : 'bg-slate-800/80 text-slate-400 border-transparent'" class="col-span-1 h-12 rounded-2xl flex items-center justify-center transition-all relative active:scale-95 border group">
                        <span v-if="restTimerRunning" class="absolute inset-0 rounded-2xl bg-red-500/20 animate-pulse z-0"></span>
                        <span v-if="restTimerRunning" class="relative z-10 font-mono font-black text-lg text-white drop-shadow-md">{{ formatTimer(restTimer) }}</span>
                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 z-10 relative"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>
                    </button>
                </div>
                <button @click="exitModal = true" class="w-full py-2 text-[10px] text-slate-500 font-black uppercase hover:text-white transition-colors">Exit Workout</button>
            </div>
        </div>
    </transition>


    <transition name="modal">
        <div v-if="previewModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="previewModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 border border-blue-500/20">
                        <i :data-lucide="previewModal.icon_name" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black italic uppercase">{{ previewModal.name }}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{{ previewModal.exercises.length }} Movements</p>
                    </div>
                </div>
                <div class="space-y-2 mb-8 max-h-64 overflow-y-auto">
                    <div v-for="(exId, idx) in previewModal.exercise_order" :key="idx" class="flex items-center gap-3 p-3 bg-slate-950/50 rounded-xl border border-white/5">
                        <span class="text-xs font-mono text-slate-600">0{{idx+1}}</span>
                        <span class="text-sm font-bold text-slate-300">{{ getExerciseName(exId) }}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="previewModal = null" class="py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
                    <button @click="startActiveSession(previewModal)" class="py-3 rounded-xl bg-blue-600 text-white font-black text-xs uppercase shadow-lg shadow-blue-900/20">Start Session</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="scheduleModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="scheduleModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <h2 class="text-xl font-black italic uppercase mb-2">Schedule Protocol</h2>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-6">For {{ scheduleModal.dayName }} {{ scheduleModal.dateNum }}</p>
                <div class="space-y-2 max-h-64 overflow-y-auto mb-6">
                    <button @click="saveSchedule(null)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 text-slate-500 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">Rest Day (Clear)</button>
                    <button v-for="routine in routines" :key="routine.id" @click="saveSchedule(routine)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                        <i :data-lucide="routine.icon_name" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-white font-bold text-sm uppercase italic">{{ routine.name }}</span>
                    </button>
                </div>
                <button @click="scheduleModal = null" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Close</button>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="finishModal" class="fixed inset-0 z-[300] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="finishModal = false"></div>
            <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-green-500/20 shadow-2xl">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20 mb-4 shadow-[0_0_20px_rgba(34,197,94,0.2)]">
                        <i data-lucide="trophy" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-black italic uppercase text-center text-white">Session Complete</h2>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">{{ activeRoutine.name }} • {{ formatTimer(sessionTimer) }}</p>
                </div>
                
                <label class="flex items-center gap-3 p-4 bg-slate-900/50 rounded-xl mb-6 cursor-pointer border border-white/5">
                    <div class="relative"><input type="checkbox" v-model="stackTaken" @change="haptic" class="sr-only peer"><div class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div></div>
                    <span class="text-[10px] font-black uppercase tracking-widest flex-1"><span class="block text-slate-400">Inventory</span><span :class="stackTaken ? 'text-purple-400' : 'text-slate-600'">Log Stack Consumption?</span></span>
                </label>

                <div class="space-y-3">
                    <button @click="confirmFinishSession" class="w-full py-4 rounded-xl bg-green-600 text-white font-black text-sm uppercase shadow-lg shadow-green-900/20 hover:bg-green-500 transition-all active:scale-95">Save Workout</button>
                    <button @click="finishModal = false" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">Resume Training</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="exitModal" class="fixed inset-0 z-[300] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="exitModal = false"></div>
            <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-red-500/20 shadow-2xl">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20 mb-4">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-xl font-black italic uppercase text-center text-white">Exit Session?</h2>
                    <p class="text-xs text-slate-500 font-bold text-center mt-2">Unsaved progress will be permanently lost.</p>
                </div>
                <div class="space-y-3">
                    <button @click="confirmFinishSession" class="w-full py-3 rounded-xl bg-slate-800 text-green-500 font-black text-xs uppercase hover:bg-slate-700">Save & Finish</button>
                    <button @click="discardSession" class="w-full py-3 rounded-xl bg-red-600 text-white font-black text-xs uppercase shadow-lg shadow-red-900/20 hover:bg-red-500">Discard Data</button>
                    <button @click="exitModal = false" class="w-full py-2 text-[10px] text-slate-500 font-black uppercase hover:text-white">Cancel</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="pickerModal.visible" class="fixed inset-0 z-[400] flex items-end justify-center">
            <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" @click="saveDualPicker"></div>
            <div class="glass-solid w-full border-t border-blue-500/30 rounded-t-3xl p-6 relative pb-safe-bottom bg-slate-900">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black uppercase italic text-blue-500">Edit Set</h3>
                    <button @click="saveDualPicker" class="text-xs font-bold uppercase text-white bg-blue-600 px-6 py-2 rounded-lg shadow-lg shadow-blue-900/20">Set</button>
                </div>
                
                <div class="grid grid-cols-2 text-[10px] font-black uppercase text-slate-500 tracking-widest text-center mb-2">
                    <div>{{ isBodyWeight(pickerModal.targetWeightType) ? 'Weight' : 'Weight (lbs)' }}</div>
                    <div>Reps</div>
                </div>

                <div class="picker-container">
                    
                    <div v-if="!isBodyWeight(pickerModal.targetWeightType)" class="wheel-col no-scrollbar" ref="weightWheel" @scroll="handleWeightScroll">
                        <div class="h-[75px]"></div>
                        <div v-for="w in pickerModal.weightValues" :key="'w-'+w" class="wheel-item" :class="{'wheel-item-active': pickerModal.weightVal === w}">{{ w }}</div>
                        <div class="h-[75px]"></div>
                    </div>
                    <div v-else class="wheel-col flex items-center justify-center">
                        <span class="text-3xl font-black text-slate-700 select-none">BW</span>
                    </div>

                    <div class="wheel-col no-scrollbar" ref="repsWheel" @scroll="handleRepsScroll">
                        <div class="h-[75px]"></div>
                        <div v-for="r in pickerModal.repsValues" :key="'r-'+r" class="wheel-item" :class="{'wheel-item-active': pickerModal.repsVal === r}">{{ r }}</div>
                        <div class="h-[75px]"></div>
                    </div>

                    <div class="wheel-highlight"></div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="swapModal.visible" class="fixed inset-0 z-[350] flex items-end justify-center sm:items-center p-4">
             <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="swapModal.visible = false"></div>
             <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl h-[70vh] flex flex-col">
                <h3 class="text-lg font-black uppercase italic text-white mb-2">Swap Exercise</h3>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-4">Targeting: {{ swapModal.targetMuscle }}</p>
                <div class="flex-1 overflow-y-auto space-y-2 no-scrollbar">
                    <button v-for="ex in swapModal.options" :key="ex.id" @click="selectSwap(ex)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                         <i :data-lucide="ex.icon_name || 'dumbbell'" class="w-5 h-5 text-blue-500"></i>
                         <span class="text-white font-bold text-sm uppercase italic">{{ ex.name }}</span>
                    </button>
                </div>
                <button @click="swapModal.visible = false" class="mt-4 w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
             </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, defineComponent } = Vue;
    const _client = supabase.createClient(
        'https://mvoyrchefjcpjkdtezmz.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ'
    );

    // --- SEPARATE SVG COMPONENT ---
    const HeatmapSvg = defineComponent({
        props: ['statuses'],
        methods: {
            getClass(muscleGroup) {
                const key = muscleGroup.toLowerCase();
                const status = this.statuses[key] ? this.statuses[key].status : 'fresh';
                return `muscle-${status}`;
            },
            getAnim(muscleGroup) {
                 const key = muscleGroup.toLowerCase();
                 return this.statuses[key] && this.statuses[key].status === 'recov' ? 'animate-pulse' : '';
            }
        },
        template: `
        <svg version="1.1" id="bodyMapSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 792" style="enable-background:new 0 0 612 792; height: 400px; width: auto;" xml:space="preserve">
            <g id="Base"><path class="muscle-base" d="M345.07,444.37c0.16,0.04,0.31,0.08,0.47,0.12c-0.03-0.1-0.05-0.19-0.08-0.29c-0.24,0.09-0.48,0.19-0.39-0.29c-0.22-3.72-0.8-7.45-0.6-11.15c0.54-10.44,1.34-20.87,2.18-31.29c0.18-2.26-0.32-3.23-2.69-2.81c-0.97,5.29-1.71,10.53-2.93,15.66c-1.97,8.23-2.51,16.22,1.72,24C343.74,440.17,344.1,442.38,345.07,444.37z M153.57,189.86c5.06,0.99,8.77-1.15,12.07-4.81c2.3-2.55,5.07-4.67,7.5-7.11c0.92-0.92,1.96-2.17,2.08-3.36c1.26-12.1,2.25-24.22,3.51-36.31c0.74-7.09-0.53-13.41-5.81-18.55c-1.45-1.41-2.59-3.61-4.31-4.2c-7.18-2.47-14.37-3.94-22.23-2.24c-6.31,1.36-11.05,3.85-13.97,9.6c-1.13,2.22-3.23,4.38-3.29,6.62c-0.26,9.62-1.38,19.26,0.71,28.87c1.09,5.03,1.35,10.24,2.18,15.34c0.22,1.36,0.87,2.88,1.81,3.84c2.98,3.03,6.31,5.71,9.28,8.74C145.88,189.1,148.96,190.56,153.57,189.86z M453.37,177.25c-0.68,2.58-1.36,5.16-2.03,7.75c0.32,0.12,0.64,0.23,0.95,0.35c1.65-2.49,3.38-4.92,4.94-7.47c2.02-3.31,3.13-8.01,6.04-9.7c2.92-1.69,7.58-0.22,11.45-0.52c2.75-0.21,4.12,0.93,5.34,3.21c3.05,5.72,6.35,11.31,9.55,16.95c0.25-0.08,0.5-0.16,0.75-0.24c-0.94-4.84-1.88-9.67-2.82-14.51c0.4-0.11,0.8-0.23,1.19-0.34c0.78,1.29,1.56,2.59,2.77,4.59c0.57-4,1.02-7.27,1.51-10.54c1.74-11.46,3.74-22.9,2.87-34.57c-0.08-1.14,0.06-2.43-0.45-3.37c-3.62-6.77-7.18-13.17-15.97-15.06c-8.31-1.79-16.22-1.02-23.51,2.29c-3.53,1.6-5.84,6.17-8.3,9.68c-1.09,1.55-1.52,3.78-1.66,5.75c-0.93,12.59,0.89,24.96,3.09,37.3c0.42,2.36,0.81,4.72,1.33,7.77c1.01-1.86,1.58-2.91,2.15-3.95c0.31,0.05,0.63,0.1,0.94,0.14C453.51,174.09,453.51,175.4,453.37,177.25z M581.57,422.85c0.44-2.56,2.5-2.69,4.23-2.22c0.93,0.25,1.79,1.78,2.13,2.9c0.56,1.85,0.51,3.88,1.02,5.75c1.78,6.41,1.13,12.35-3.52,17.36c-3.51,3.78-1.5,7.72-0.65,11.88c2.45-2.58,5.76-5.08,6.43-8.16c1.44-6.62,3.4-13.21,2.37-20.35c-1.46-10.08-1.93-20.31-2.82-30.42c-5.77-0.78-5.64-0.71-8.07,3.83c-3.7,6.92-6.96,13.88-6.88,22.01c0.04,3.81-0.48,7.63-0.75,11.47c3.77,0.02,3.77,0.02,4.28-2.69 C580.03,430.6,580.72,427,581.57,422.85z M361.3,435.63c1.06,0.55,2.12,1.1,3.6,1.87c0.13-1.53,0.26-2.21,0.23-2.87c-0.48-10.56-1.17-20.99-6.77-30.53c-3.04-5.18-2.6-5.44-9.12-4.45c-0.54,8.06-0.96,16.18-1.66,24.28c-0.69,8.01-1.31,15.87,1.34,23.79c1.47,4.4,4.39,7.16,7.16,10.53c2.13-4.88,1.19-8.8-1.66-12.36c-4.17-5.21-4.63-11.04-3.04-17.26c0.4-1.56,0.47-3.23,1.09-4.68c0.54-1.26,1.47-2.98,2.55-3.26c2.25-0.58,3.53,1.03,3.94,3.25C359.67,427.67,360.39,431.39,361.3,435.63z M227.49,695.79c-1.25-2.89-2.9-5.69-3.69-8.7c-1.85-7.07-3.29-14.25-4.88-21.29c-4.84,0-9.33,0-14.12,0c4.42,13.36,5.68,27.55,15.34,38.91c3.2-1.4,6.6-2.89,10.25-4.49C229.36,698.65,228.55,697.43,227.49,695.79z M101,686.9c2.01-7.01,4.03-14.02,6.09-21.19c-4.81,0-9.25,0-13.6,0c-3.88,11.55-3.74,24.27-12.05,34.39c3.12,1.4,5.89,2.73,8.74,3.85c0.62,0.24,2.01-0.03,2.27-0.5C95.33,698.15,98.06,692.77,101,686.9z M411.91,699.72c0.67,0.28,1.35,0.56,2.64,1.09c0-10.83,0-21.06,0-30.11c-3.81,7.48-8.09,15.89-12.46,24.46C405.03,696.52,408.25,698,411.91,699.72z M139.3,209.97c0.52,1.76,1.24,3.48,1.53,5.28c0.56,3.53,2.41,5.18,6.24,4.68c-0.08-0.65-0.08-1.32-0.25-1.94c-3.05-10.67-6.04-21.36-9.25-31.98c-0.5-1.66-2.01-3.01-3.05-4.51c-0.33,0.13-0.67,0.26-1,0.38c0.23,3.95-0.03,8.02,0.8,11.84C135.46,199.06,137.44,204.22,139.3,209.97z M524.75,677.35c-1.06-2.62-2.12-5.24-3-7.44c0,9.97,0,20.27,0,31.08c4.62-2.23,8.51-4.1,12.41-5.97C531.02,689.13,528,683.48,524.75,677.35z M594.36,413.33c0.06,10.37,3.87,20.64,0.75,31.18c0.89-0.96,1.56-1.96,1.96-3.07c1.3-3.55,2.54-7.13,3.72-10.72c0.35-1.07,0.76-2.28,0.58-3.33c-1.64-9.6-3.41-19.19-5.14-28.74c-2.54-0.52-3.21,0.38-2.91,2.71C593.81,405.12,594.01,408.91,594.36,413.33z"/></g>
            <g id="Back" :class="[getClass('Back'), getAnim('Back')]"><path class="muscle-base" d="M416.95,295.88c1.19,2.35,2.13,4.87,3.6,7.03c5.81,8.55,11.78,17,17.71,25.48 c6.92,9.89,13.89,19.74,20.74,29.67c0.57,0.82,0.41,2.14,0.58,3.22c-0.92-0.61-2.12-1.02-2.72-1.86 c-7.12-10.02-14.14-20.12-21.19-30.18c-4.46-6.36-8.94-12.7-13.41-19.05c-0.45,1.35-0.33,2.42-0.08,3.47 c1.99,8.53,3.54,17.06,2.47,25.91c-0.35,2.93-0.01,5.97,0.22,8.95c0.35,4.54,1.62,9.15-1.93,13.27c3.55-1.6,6.66-3.52,9.95-5.01 c1.2-0.54,3.15-0.56,4.26,0.07c5.81,3.25,11.5,6.73,17.15,10.26c1.32,0.82,2.43,2.08,3.42,3.3c3.97,4.9,7.85,9.86,11.92,15 c1.62-2.01,2.99-3.86,4.5-5.57c5.19-5.9,9.31-12.84,16.94-16.31c3.64-1.65,7.07-3.87,10.36-6.15c2.15-1.49,3.9-1.45,5.98-0.12 c3.11,2,6.29,3.89,8.67,5.35c-0.39-4.01-1.04-8.2-1.13-12.4c-0.1-4.93,0.19-9.87,0.48-14.8c0.3-5.14,0.69-10.27,1.25-15.39 c0.36-3.26,1.1-6.48,1.67-9.72c-10.71,14.28-20.78,28.68-30.87,43.06c-1.58,2.26-3.18,4.51-4.9,6.66 c-0.46,0.58-1.41,0.76-2.14,1.13c-0.02-0.9-0.08-1.8-0.02-2.69c0.02-0.29,0.36-0.57,0.56-0.85c11.85-16.67,23.55-33.44,35.62-49.96 c5.97-8.17,8.51-17.72,12.06-26.88c0.51-1.32,0.45-2.86,0.69-4.57c-1.23,0-2.13-0.03-3.02,0.01c-10.11,0.45-20.21,0.97-30.33,1.32 c-2.08,0.07-3.28,0.79-4.34,2.57c-6.29,10.56-12.76,21.02-19.01,31.6c-0.99,1.67-1.65,3.81-1.66,5.74 c-0.09,18.28-0.02,36.57,0.01,54.85c0,0.8,0.09,1.64-0.13,2.39c-0.11,0.39-0.79,0.88-1.2,0.86c-0.39-0.01-1-0.57-1.08-0.98 c-0.18-0.89-0.11-1.83-0.11-2.75c0.02-18.63,0.06-37.26,0.02-55.89c0-1.42-0.25-3.04-0.96-4.23c-6.4-10.76-12.89-21.47-19.46-32.13 c-0.54-0.88-1.86-1.74-2.87-1.81c-8.26-0.59-16.52-0.98-24.79-1.44c-3.17-0.17-6.34-0.36-9.86-0.55 C410.8,283.23,415.13,288.89,416.95,295.88z M488.42,280.6c1.13-2.12,2.55-4.14,3.35-6.38c5.62-15.68,11.08-31.41,16.69-47.1 c0.46-1.29,1.46-2.51,2.48-3.47c3.55-3.3,7.23-6.46,10.86-9.68c-10.13-0.2-19.85,0.34-29.58,0.95c-0.74,0.05-1.51,0.5-2.18,0.9 c-5.02,3.03-9.92,6.27-15.06,9.07c-3.03,1.65-4.28,3.65-3.94,7.09c0.14,1.42-0.79,2.94-1.24,4.42c-0.41-1.51-1.29-3.08-1.14-4.53 c0.39-3.6-1.02-5.64-4.18-7.3c-4.88-2.56-9.47-5.65-14.26-8.39c-1.24-0.71-2.73-1.25-4.14-1.36c-8.37-0.62-16.75-1.1-25.13-1.61 c-0.58-0.04-1.17,0.09-2.01,0.15c3.52,3.56,6.76,6.8,9.94,10.1c0.86,0.89,1.84,1.84,2.24,2.95c4.95,13.6,9.79,27.23,14.7,40.84 c1.25,3.45,2.27,7.07,4.09,10.2c5.38,9.23,11.1,18.25,16.71,27.35c0.43,0.7,0.96,1.33,1.82,2.51c0-16.81,0-32.89,0-48.96 c0-0.92-0.13-1.87,0.08-2.75c0.12-0.5,0.8-0.86,1.23-1.28c0.36,0.39,0.92,0.73,1.03,1.17c0.19,0.76,0.12,1.6,0.12,2.4 c0.01,15.64,0.02,31.28,0.02,46.92c0,1.09,0,2.18,0,3.27c0.21,0.05,0.43,0.1,0.64,0.15C477.1,299.17,482.62,290.09,488.42,280.6z M415.4,239.33c-2.33,1.86-4.74,3.64-6.96,5.63c-0.73,0.65-1.47,1.88-1.37,2.75c0.94,8.42,2.06,16.83,3.16,25.48 c11.81,0.63,23.51,1.26,35.83,1.92c-5.79-15.96-11.37-31.32-17.08-47.05C424.42,231.86,420.11,235.45,415.4,239.33z M527.63,241.81 c-5.47-4.46-10.94-8.93-16.61-13.54c-5.56,15.7-10.98,31-16.55,46.74c12.14-0.56,23.66-1.09,35.23-1.62 c0.9-6.46,1.44-12.76,2.73-18.91C533.54,249.2,533.37,244.86,527.63,241.81z M473.78,170.13c-0.86,0.09-1.71,0.17-2.52,0.25 c0,18.01,0,35.73,0,53.97c3.25-1.98,6.2-3.52,8.86-5.45c6.58-4.76,13.56-7.84,21.97-7.19c3.86,0.3,7.79-0.29,11.69-0.5 c0.9-0.05,1.8-0.23,3.64-0.48c-7.14-3.17-13.25-6.07-19.52-8.58c-3.12-1.25-5.06-3.28-6.6-6.12c-4.26-7.87-8.69-15.65-12.97-23.51 C477.42,170.86,476.44,169.69,473.78,170.13z M459.08,179.47c-3.68,6.23-7.24,12.54-11.13,18.63c-1.02,1.59-2.93,2.85-4.7,3.66 c-6.44,2.95-12.99,5.65-19.5,8.44c6.26,1.05,12.41,1.66,18.56,1.68c4.57,0.01,8.46,1.24,12.23,3.77c4.42,2.97,9.1,5.54,13.78,8.35 c0-18.26,0-36.02,0-53.61c-2.95-0.96-4.59,0.04-5.69,2.57C461.71,175.07,460.44,177.01,459.08,179.47z"/>
            <path class="muscle-base" d="M177.43,200.84c-1.23-0.89-2.46-1.79-3.8-2.76c-2.06,6.96-4.05,13.67-6.13,20.66 c11.98-2.24,23.26-4.36,35.43-6.64C193.99,208.17,185.94,204.62,177.43,200.84z M112.08,208.69c-2.44,1.06-4.89,2.12-7.99,3.46 c12.27,2.24,23.64,4.33,35.3,6.46c-2.21-7.23-4.31-14.11-6.37-20.85C126.94,203.25,119.24,204.91,112.08,208.69z"/></g>
            <g id="Calves" :class="[getClass('Calves'), getAnim('Calves')]"><path class="muscle-base" d="M515.92,575.83c0.37,3.54,1.01,7.08,1.05,10.63c0.06,6.25,1.84,11.14,7.79,14.34c3.73,2.01,6.9,5.08,10.62,7.9 c0.76-7.04,1.49-13.42,2.12-19.82c0.13-1.35,0.11-2.79-0.22-4.09c-2.92-11.58-5.9-23.14-8.93-34.68c-0.27-1.03-0.78-2.41-1.59-2.82 c-4.45-2.28-9.02-4.31-14.03-6.66C513.8,552.56,514.82,563.88,515.92,575.83z M422.72,548.93c0.17-2.6,0.33-5.2,0.53-8.31 c-5.03,2.39-9.59,4.48-14.04,6.77c-0.7,0.36-1.1,1.62-1.34,2.54c-2.56,9.64-4.9,19.35-7.64,28.93c-1.22,4.27-1.85,8.4-1.22,12.83 c0.78,5.47,1.16,11,1.77,17.02c5.43-4.17,10.42-7.84,15.18-11.78c1.15-0.95,2.07-2.74,2.24-4.23 C419.77,578.33,421.16,563.94,422.72,548.93z M513.91,578.55c-1.19-12.04-2.37-24.07-3.61-36.61c-2.95,2.51-5.51,4.63-8,6.83 c-0.55,0.49-1.06,1.24-1.22,1.95c-2.83,12.43-5.61,24.86-8.37,37.31c-0.17,0.76-0.35,1.63-0.14,2.33 c2.17,7.22,4.41,14.42,6.63,21.6c5.25-5.11,10.48-10.08,15.52-15.23c0.7-0.72,0.78-2.33,0.68-3.49 C515.02,588.54,514.46,583.86,513.91,578.55z M421.89,581.23c-0.43,3.99-0.93,7.98-1.24,11.98c-0.09,1.16-0.03,2.76,0.66,3.48 c4.9,5.12,9.99,10.06,15.34,15.38c2.22-7.26,4.38-14.11,6.37-21.01c0.33-1.13,0.08-2.51-0.18-3.72c-2.34-11-5.26-21.9-6.93-32.99 c-0.99-6.58-6.1-8.35-10.1-12.47C424.47,555.29,423.21,567.95,421.89,581.23z M528.61,671.39c0.62-3.04,1.5-6.05,1.81-9.12 c1.6-16.13,3.06-32.28,4.52-48.42c0.07-0.83,0.02-2.07-0.49-2.48c-5.14-4.13-10.38-8.13-15.72-12.26 c-0.24,0.65-0.38,0.85-0.37,1.04c0.74,19.42,1.07,38.87,2.48,58.24c0.45,6.11,3.82,12,5.88,18.08c0.76-0.39,0.92-0.42,0.93-0.49 C527.95,674.64,528.23,673.29,528.61,671.39z M402.65,629.73c2.03,15.58,1.35,31.53,6.23,47.11c1.74-4.56,3.4-8.71,4.9-12.91 c0.69-1.93,1.44-3.95,1.53-5.95c0.87-18.37,1.61-36.74,2.38-55.11c0.05-1.1,0.01-2.21,0.01-4.17c-5.34,4.16-10.17,7.77-14.78,11.65 c-0.99,0.83-1.67,2.66-1.61,3.99C401.54,619.27,402.14,624.18,402.65,629.73z M505.68,635.77c2.55,12.46,5.11,24.92,7.66,37.38 c0.39,0.04,0.77,0.07,1.16,0.11c1.19-6.19,3.29-12.36,3.39-18.56c0.18-11.93-0.75-23.88-1.24-35.82 c-0.26-6.28-0.55-12.55-0.81-18.23c-4.76,4.42-9.64,8.91-14.44,13.48c-0.41,0.39-0.47,1.41-0.32,2.06 C502.52,622.54,504.03,628.87,505.68,635.77z M432.4,624.23c0.83-2.73,1.72-5.44,2.44-8.19c0.19-0.72,0.13-1.87-0.32-2.33 c-4.56-4.64-9.22-9.18-14.08-13.98c-0.1,0.77-0.21,1.29-0.23,1.82c-0.8,18.61-1.93,37.22-2.18,55.84 c-0.07,5.16,2.44,10.36,3.76,15.54c0.34-0.06,0.68-0.13,1.02-0.19C425.95,656.75,429.1,640.77,432.4,624.23z M183.78,601.65 c5.38,14.42,10.48,28.92,12.59,44.35c0.6-17.47,0.61-34.83,0.56-52.18c0-1.47-0.29-2.99-0.75-4.38 c-3.07-9.25-6.21-18.48-9.36-27.71c-0.3-0.88-0.79-1.7-1.57-3.34c-1.13,9.85-1.81,18.8-3.28,27.62 C181.07,591.37,182.6,596.12,183.78,601.65z M125.37,607.72c1.16-3.96,2.1-8.01,3.55-11.86c1.23-3.27,1.18-6.39,0.55-9.73 c-1.17-6.2-2.13-12.44-3.14-18.66c-0.48-2.94-0.87-5.88-1.31-8.83c-3.44,8.89-6.25,17.73-8.91,26.62c-0.78,2.61-1.6,5.35-1.58,8.03 c0.12,15.27,0.48,30.53,0.78,45.8c0.02,0.95,0.12,1.9,0.25,3.65C118.93,630.67,122.06,619.45,125.37,607.72z"/></g>
        </svg>
        `
    });

    createApp({
        components: {
            'heatmap-svg': HeatmapSvg
        },
        data() { 
            return { 
                loading: true, 
                loadingText: 'Syncing Protocols',
                session: null,
                view: 'dashboard', 
                toast: { visible: false, title: '', message: '' },
                isFinishing: false,
                
                // Modals
                scheduleModal: null, 
                previewModal: null,
                finishModal: false,
                exitModal: false,
                
                // Dual Picker State
                pickerModal: {
                    visible: false,
                    targetSet: null,
                    weightValues: [],
                    repsValues: [],
                    weightVal: 0,
                    repsVal: 0,
                    targetWeightType: 'combined'
                },
                
                swapModal: { visible: false, targetMuscle: '', options: [], groupIdx: null, exIdx: null },

                // Data
                routines: [], 
                libraryExercises: [], 
                schedule: [], 
                recentSessions: [],
                rawLogs: [], 
                
                muscleHeatmap: { 'chest': {status: 'fresh'}, 'back': {status: 'fresh'}, 'legs': {status: 'fresh'}, 'arms': {status: 'fresh'}, 'shoulders': {status: 'fresh'}, 'core': {status: 'fresh'}, 'quads': {status: 'fresh'}, 'hamstrings': {status: 'fresh'}, 'glutes': {status: 'fresh'}, 'calves': {status: 'fresh'}, 'biceps': {status: 'fresh'}, 'triceps': {status: 'fresh'}, 'forearms': {status: 'fresh'}, 'hips': {status: 'fresh'} },

                // Active Session
                activeRoutine: { name: '', data: [] }, 
                activeExerciseIdx: 0,
                stackTaken: false,
                sessionTimer: 0, 
                sessionStartTime: null,
                sessionInterval: null,
                restTimer: 0, 
                restTimerRunning: false, 
                restInterval: null,
                personalRecords: {} 
            } 
        },
        computed: {
            upcomingDays() {
                const days = [];
                for(let i=0; i<7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() + i);
                    days.push({ dateNum: d.getDate(), dayName: d.toLocaleDateString('en-US', {weekday:'short'}), fullDate: d.toLocaleDateString('en-CA') });
                }
                return days;
            }
        },
        watch: {
            activeRoutine: { handler() { this.saveSessionState(); }, deep: true },
            stackTaken() { this.saveSessionState(); },
            activeExerciseIdx(newVal) {
                this.$nextTick(() => {
                    const el = document.getElementById('cluster-' + newVal);
                    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            }
        },
        async mounted() {
            const { data: { session }, error } = await _client.auth.getSession();
            if (error || !session) { window.location.href = 'index.html'; return; }
            this.session = session;
            
            try {
                await Promise.all([this.fetchRoutines(), this.fetchExercises(), this.fetchSchedule()]);
                await this.fetchHistory(); 
                this.restoreSessionState();
            } catch (err) {
                console.error("Initialization error:", err);
                this.showToast("Sync Error", "Could not load data. Pull to refresh.");
            } finally {
                this.loading = false;
                this.$nextTick(() => { 
                    lucide.createIcons(); 
                });
            }
        },
        updated() { 
            this.$nextTick(() => { 
                lucide.createIcons(); 
            }); 
        },
        methods: {
            haptic() {
                if (navigator.vibrate) navigator.vibrate(10);
            },
            isBodyWeight(type) { 
                if(type === true) return true;
                if(!type) return false;
                const t = type.toString().toLowerCase();
                return t === 'bodyweight' || t === 'body_weight' || t === 'bw' || t === 'true'; 
            },
            // --- DUAL PICKER LOGIC ---
            openDualPicker(setObj, weightType) {
                this.haptic();
                this.pickerModal.targetSet = setObj;
                this.pickerModal.targetWeightType = weightType;
                
                if(this.pickerModal.weightValues.length === 0) {
                      for(let i=0; i<=500; i+=2.5) this.pickerModal.weightValues.push(i);
                      for(let i=0; i<=100; i++) this.pickerModal.repsValues.push(i);
                }
                
                let w = parseFloat(setObj.weight);
                if(isNaN(w)) w = parseFloat(setObj.prevWeight) || 0;
                let r = parseInt(setObj.reps);
                if(isNaN(r)) r = parseInt(setObj.prevReps) || 0;

                this.pickerModal.weightVal = w;
                this.pickerModal.repsVal = r;
                this.pickerModal.visible = true;

                this.$nextTick(() => {
                    const itemHeight = 50;
                    if(!this.isBodyWeight(weightType)) {
                        const wIndex = this.pickerModal.weightValues.indexOf(w);
                        if(wIndex > -1 && this.$refs.weightWheel) this.$refs.weightWheel.scrollTop = wIndex * itemHeight;
                    }
                    const rIndex = this.pickerModal.repsValues.indexOf(r);
                    if(rIndex > -1 && this.$refs.repsWheel) this.$refs.repsWheel.scrollTop = rIndex * itemHeight;
                });
            },
            handleWeightScroll(e) {
                const itemHeight = 50;
                const index = Math.round(e.target.scrollTop / itemHeight);
                const val = this.pickerModal.weightValues[index];
                if (val !== undefined && val !== this.pickerModal.weightVal) {
                    this.pickerModal.weightVal = val;
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            },
            handleRepsScroll(e) {
                const itemHeight = 50;
                const index = Math.round(e.target.scrollTop / itemHeight);
                const val = this.pickerModal.repsValues[index];
                if (val !== undefined && val !== this.pickerModal.repsVal) {
                    this.pickerModal.repsVal = val;
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            },
            saveDualPicker() {
                this.haptic();
                if(this.pickerModal.targetSet) {
                    if(this.isBodyWeight(this.pickerModal.targetWeightType)) {
                        this.pickerModal.targetSet.weight = ''; 
                    } else {
                        this.pickerModal.targetSet.weight = this.pickerModal.weightVal;
                    }
                    this.pickerModal.targetSet.reps = this.pickerModal.repsVal;
                }
                this.pickerModal.visible = false;
            },

            // --- STOPWATCH LOGIC ---
            startSessionTimer() {
                if (this.sessionInterval) clearInterval(this.sessionInterval);
                if (!this.sessionStartTime) this.sessionStartTime = Date.now();
                const tick = () => {
                    const now = Date.now();
                    const seconds = Math.floor((now - this.sessionStartTime) / 1000);
                    this.sessionTimer = seconds > 0 ? seconds : 0;
                };
                tick();
                this.sessionInterval = setInterval(tick, 1000);
            },

            // --- NAVIGATION ---
            nextExercise() { if(this.activeExerciseIdx < this.activeRoutine.data.length - 1) this.activeExerciseIdx++; },
            prevExercise() { if(this.activeExerciseIdx > 0) this.activeExerciseIdx--; },

            saveSessionState() {
                if (this.view !== 'active_session' || !this.activeRoutine.name || this.isFinishing) return;
                const state = { activeRoutine: this.activeRoutine, sessionStartTime: this.sessionStartTime, activeExerciseIdx: this.activeExerciseIdx, stackTaken: this.stackTaken };
                localStorage.setItem('constellation_active_session', JSON.stringify(state));
            },
            restoreSessionState() {
                const savedSession = localStorage.getItem('constellation_active_session');
                if (savedSession) {
                    try {
                        const parsed = JSON.parse(savedSession);
                        this.activeRoutine = parsed.activeRoutine;
                        this.sessionStartTime = parsed.sessionStartTime;
                        this.activeExerciseIdx = parsed.activeExerciseIdx || 0;
                        this.stackTaken = parsed.stackTaken || false;
                        this.view = 'active_session';
                        this.startSessionTimer();
                        this.showToast("Session Restored", "Resumed previous workout.");
                    } catch (e) {
                        localStorage.removeItem('constellation_active_session');
                    }
                }
            },
            
            // --- SWAP LOGIC ---
            openSwapModal(groupIdx, exIdx) {
                this.haptic();
                const group = this.activeRoutine.data[groupIdx];
                const currentEx = group.exercises[exIdx];
                const libraryEntry = this.libraryExercises.find(e => e.name === currentEx.name);
                const targetMuscle = libraryEntry ? libraryEntry.muscle_group : null;
                
                if(targetMuscle) {
                    this.swapModal.targetMuscle = targetMuscle;
                    this.swapModal.options = this.libraryExercises.filter(e => e.muscle_group === targetMuscle);
                } else {
                    this.swapModal.targetMuscle = 'All';
                    this.swapModal.options = this.libraryExercises;
                }
                this.swapModal.groupIdx = groupIdx;
                this.swapModal.exIdx = exIdx;
                this.swapModal.visible = true;
            },
            async selectSwap(newExDef) {
                this.haptic();
                const { groupIdx, exIdx } = this.swapModal;
                const group = this.activeRoutine.data[groupIdx];
                const pr = (this.personalRecords[newExDef.name] || 0);
                const newEx = {
                    id: newExDef.id, name: newExDef.name, icon: newExDef.icon_name, weightType: (newExDef.is_bodyweight ? 'bodyweight' : 'combined'), personalRecord: pr,
                    isLinked: group.exercises[exIdx].isLinked, sets: []
                };
                const { data: lastLog } = await _client.from('workout_logs').select('sets_data').eq('exercise_name', newEx.name).order('created_at', { ascending: false }).limit(1).single();
                if(lastLog && lastLog.sets_data) {
                    newEx.sets = lastLog.sets_data.map(s => ({ weight: '', prevWeight: s.weight, reps: '', prevReps: s.reps, done: false, failure: false }));
                }
                const targetSets = group.exercises[exIdx].sets.length;
                while(newEx.sets.length < targetSets) newEx.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false });
                group.exercises[exIdx] = newEx;
                this.swapModal.visible = false;
                this.showToast('Swapped', `Now doing ${newEx.name}`);
            },

            // --- STANDARD LOGIC ---
            discardSession() {
                localStorage.removeItem('constellation_active_session');
                clearInterval(this.sessionInterval);
                this.finishModal = false;
                this.exitModal = false;
                this.view = 'dashboard';
            },
            async confirmLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },
            showToast(title, message) { this.toast = { visible: true, title, message }; setTimeout(() => this.toast.visible = false, 3000); },
            async fetchRoutines() { const { data } = await _client.from('routines').select('*').order('created_at'); this.routines = data || []; },
            async fetchExercises() { const { data } = await _client.from('exercises').select('*').order('name'); this.libraryExercises = data || []; },
            async fetchSchedule() { const { data } = await _client.from('schedule').select('*, routines(name, icon_name)').eq('user_id', this.session.user.id); this.schedule = data || []; },
            
            async fetchHistory() {
                const { data: rawData } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false }).limit(300);
                this.rawLogs = rawData || [];
                // Update PRs
                this.rawLogs.forEach(log => {
                    if(log.sets_data) {
                        log.sets_data.forEach(s => {
                            const w = parseFloat(s.weight) || 0;
                            if(w > (this.personalRecords[log.exercise_name] || 0)) this.personalRecords[log.exercise_name] = w;
                        });
                    }
                });
                this.calculateHeatmapData();
                if (!this.rawLogs.length) { this.recentSessions = []; return; }
                
                const sessions = []; let currentSession = null;
                const pushSession = (s) => {
                    s.exerciseCount = s.exercises.size;
                    delete s.exercises;
                    sessions.push(s);
                };

                this.rawLogs.forEach((log) => {
                    const logTime = new Date(log.created_at).getTime();
                    if (!currentSession) {
                        currentSession = { 
                            id: log.id, startTime: logTime, 
                            name: log.protocol_name || 'Training Session', 
                            date: new Date(log.created_at).toLocaleDateString(), 
                            volume: 1, 
                            exercises: new Set([log.exercise_name]) 
                        };
                        if(log.sets_data) currentSession.volume = log.sets_data.length;
                    } else {
                        const diffMins = Math.abs(currentSession.startTime - logTime) / (1000 * 60);
                        if (diffMins < 60) {
                            currentSession.volume += (log.sets_data ? log.sets_data.length : 1);
                            currentSession.exercises.add(log.exercise_name);
                        } else { 
                            pushSession(currentSession); 
                            currentSession = { 
                                id: log.id, startTime: logTime, 
                                name: log.protocol_name || 'Training Session', 
                                date: new Date(log.created_at).toLocaleDateString(), 
                                volume: (log.sets_data ? log.sets_data.length : 1), 
                                exercises: new Set([log.exercise_name]) 
                            }; 
                        }
                    }
                });
                if (currentSession) pushSession(currentSession);
                this.recentSessions = sessions.slice(0, 5);
            },
            calculateHeatmapData() {
                const now = new Date().getTime();
                const oneDay = 1000 * 60 * 60 * 24;
                for(let m in this.muscleHeatmap) { this.muscleHeatmap[m].lastTrained = null; this.muscleHeatmap[m].status = 'fresh'; }
                this.rawLogs.forEach(log => {
                    const exDef = this.libraryExercises.find(e => e.name === log.exercise_name);
                    if(exDef && exDef.muscle_group) {
                        let groupKey = exDef.muscle_group.toLowerCase();
                        if(this.muscleHeatmap[groupKey]) {
                             const logTime = new Date(log.created_at).getTime();
                             if(!this.muscleHeatmap[groupKey].lastTrained || logTime > this.muscleHeatmap[groupKey].lastTrained) this.muscleHeatmap[groupKey].lastTrained = logTime;
                        }
                    }
                });
                for(let m in this.muscleHeatmap) {
                    if(this.muscleHeatmap[m].lastTrained) {
                        const daysSince = (now - this.muscleHeatmap[m].lastTrained) / oneDay;
                        if(daysSince < 2) this.muscleHeatmap[m].status = 'recov';
                        else if(daysSince < 4) this.muscleHeatmap[m].status = 'tired';
                        else this.muscleHeatmap[m].status = 'fresh';
                    }
                }
            },
            
            async generateAIWorkout() {
                this.loading = true; this.loadingText = "Analyzing Biometrics...";
                setTimeout(async () => {
                    const fillerExercises = this.libraryExercises.slice(0, 3).map(e => e.id);
                    if(fillerExercises.length) {
                        await _client.from('routines').insert([{ name: 'AI Gap Filler', icon_name: 'zap', exercise_order: fillerExercises, user_id: this.session.user.id }]);
                        await this.fetchRoutines();
                        this.showToast("AI Generated", "Gap Filler Protocol Created");
                    }
                    this.loading = false;
                }, 1000);
            },
            getScheduleForDay(dayName) { const entry = this.schedule.find(s => s.day_of_week === dayName); return entry ? { name: entry.routines.name, icon_name: entry.routines.icon_name } : null; },
            openScheduleModal(dayObj) { this.scheduleModal = dayObj; },
            async saveSchedule(routine) {
                if (!this.scheduleModal) return;
                const day = this.scheduleModal.dayName; 
                if (routine) await _client.from('schedule').upsert({ user_id: this.session.user.id, day_of_week: day, routine_id: routine.id }, { onConflict: 'user_id, day_of_week' });
                else await _client.from('schedule').delete().eq('user_id', this.session.user.id).eq('day_of_week', day);
                this.scheduleModal = null; this.fetchSchedule(); this.showToast('Schedule Updated', routine ? `${routine.name} set` : 'Rest day assigned');
            },
            previewRoutine(routine) { this.previewModal = { ...routine, exercises: routine.exercise_order || [] }; },
            getExerciseName(id) { const ex = this.libraryExercises.find(e => e.id === id); return ex ? ex.name : 'Unknown Exercise'; },
            async startActiveSession(routine) {
                this.previewModal = null; this.loading = true; this.loadingText = "Constructing Session...";
                const draftRoutine = { name: routine.name, data: [] };
                const flatExercises = (routine.exercise_order || []).map((id, index) => {
                    const exDef = this.libraryExercises.find(e => e.id === id);
                    const pr = exDef ? (this.personalRecords[exDef.name] || 0) : 0;
                    return { 
                        id: id, 
                        name: exDef ? exDef.name : 'Exercise', 
                        icon: exDef ? exDef.icon_name : 'dumbbell', 
                        weightType: (exDef && exDef.is_bodyweight) ? 'bodyweight' : 'combined',
                        personalRecord: pr, 
                        isLinked: (routine.supersets || []).includes(index), 
                        sets: [{weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}] 
                    };
                });
                const clusters = [];
                flatExercises.forEach((ex) => {
                    if (ex.isLinked && clusters.length > 0) clusters[clusters.length - 1].exercises.push(ex);
                    else clusters.push({ type: 'cluster', exercises: [ex] });
                });
                draftRoutine.data = clusters;
                for (let group of draftRoutine.data) {
                    for (let ex of group.exercises) {
                        const { data: lastLog } = await _client.from('workout_logs').select('sets_data').eq('exercise_name', ex.name).order('created_at', { ascending: false }).limit(1).single();
                        if(lastLog && lastLog.sets_data) ex.sets = lastLog.sets_data.map(s => ({ weight: '', prevWeight: s.weight, reps: '', prevReps: s.reps, done: false, failure: false }));
                        while(ex.sets.length < 3) ex.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false });
                    }
                    const maxSets = Math.max(...group.exercises.map(e => e.sets.length));
                    group.exercises.forEach(ex => { while(ex.sets.length < maxSets) ex.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false }); });
                }
                this.activeRoutine = draftRoutine; this.activeExerciseIdx = 0; this.view = 'active_session';
                this.$nextTick(() => { window.scrollTo(0,0); const container = document.getElementById('session-container'); if(container) container.scrollTop = 0; });
                this.sessionStartTime = Date.now();
                this.startSessionTimer();
                this.loading = false;
            },
            getMaxSets(group) { if(!group || !group.exercises) return 0; return Math.max(...group.exercises.map(e => e.sets.length)); },
            addSetToGroup(groupIdx) {
                const group = this.activeRoutine.data[groupIdx];
                group.exercises.forEach(ex => { const prev = ex.sets.slice(-1)[0]; ex.sets.push({ weight: '', prevWeight: prev?.prevWeight||'', reps: '', prevReps: prev?.prevReps||'', done: false, failure: false }); });
            },
            toggleRestTimer() { 
                this.haptic();
                this.restTimerRunning = !this.restTimerRunning; 
                if(this.restTimerRunning) { 
                    this.restTimer = 0; 
                    this.restInterval = setInterval(() => this.restTimer++, 1000); 
                } else clearInterval(this.restInterval); 
            },
            formatTimer(s) { if(s < 0) s = 0; return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; },
            async confirmFinishSession() {
                try {
                    // FIX: Lock session state immediately to prevent zombie save
                    this.isFinishing = true; 
                    localStorage.removeItem('constellation_active_session');
                    clearInterval(this.sessionInterval); 
                    
                    this.finishModal = false; 
                    this.exitModal = false; 
                    this.loading = true; 
                    this.loadingText = "Analyzing Performance...";
                    
                    const flatLogs = [];
                    this.activeRoutine.data.forEach(group => {
                        group.exercises.forEach(ex => {
                            const validSets = ex.sets.filter(s => s.done);
                            if (validSets.length > 0) flatLogs.push({ user_id: this.session.user.id, exercise_name: ex.name, protocol_name: this.activeRoutine.name, sets_data: validSets, duration_seconds: this.sessionTimer, created_at: new Date().toISOString() });
                        });
                    });
                    
                    if(flatLogs.length) await _client.from('workout_logs').insert(flatLogs);
                    
                    if(this.stackTaken) {
                        const { data: inv } = await _client.from('inventory').select('*');
                        if(inv && inv.length) {
                            const updates = inv.map(i => _client.from('inventory').update({servings_left: Math.max(0, i.servings_left - 1)}).eq('id', i.id));
                            await Promise.all(updates);
                        }
                    }
                    
                    await this.fetchHistory(); 
                    this.showToast("Victory", "Session archived.");
                } catch(e) {
                    console.error("Save Error:", e);
                    this.showToast("Notice", "Workout saved locally (Sync failed)");
                } finally {
                    this.activeRoutine = { name: '', data: [] }; // Clear data ref
                    this.view = 'dashboard'; 
                    this.loading = false; 
                    // Keep isFinishing true for a moment to prevent late watcher triggers
                    setTimeout(() => { this.isFinishing = false; }, 500);
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
