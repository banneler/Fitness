<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <title>Performance | Constellation</title>

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        [v-cloak] { display: none !important; }
        /* CHANGED: Removed overscroll-behavior-y: none to match Today.html behavior */
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Layout */
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .pt-safe-offset { padding-top: calc(env(safe-area-inset-top) + 20px); }
        /* RESTORED: Matches Today.html to handle Home Indicator padding */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Muscle Heatmap Colors */
        .muscle-base { fill: #1e293b; stroke: rgba(255, 255, 255, 0.1); stroke-width: 1px; transition: all 0.6s ease; }
        .muscle-fresh { fill: #3b82f6 !important; filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5)); }
        .muscle-fresh path { fill: #3b82f6 !important; }
        .muscle-tired { fill: #f97316 !important; }
        .muscle-tired path { fill: #f97316 !important; }
        .muscle-recov { fill: #ef4444 !important; }
        .muscle-recov path { fill: #ef4444 !important; }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(100%); }
        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
        
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
    </style>
</head>
<body class="font-sans antialiased bg-slate-950">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32 pt-safe-offset">
    
    <div v-if="loading" class="fixed inset-0 bg-slate-950 z-[1000] flex items-center justify-center">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">{{ loadingText }}</p>
        </div>
    </div>

    <transition name="toast">
        <div v-if="toast.visible" class="fixed top-6 left-6 right-6 glass p-4 rounded-2xl shadow-2xl z-[250] flex items-center gap-4 border-l-4 border-blue-500">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <div>
                <h4 class="text-xs font-black italic text-white uppercase">{{ toast.title }}</h4>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">{{ toast.message }}</p>
            </div>
        </div>
    </transition>

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-black italic text-blue-500 uppercase">Performance</h1>
            <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Progressive Overload</p>
        </div>
        <div class="flex gap-2">
            <button @click="generateAIWorkout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-purple-400 hover:text-purple-300"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
            <button @click="confirmLogout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </header>

    <div class="glass p-6 rounded-[2.5rem] mb-8 border-t-4 border-t-blue-500 shadow-xl relative overflow-hidden">
        <div class="absolute inset-0 bg-blue-900/10 blur-3xl pointer-events-none"></div>
        <div class="flex items-center justify-between mb-6 relative z-10">
            <div class="flex items-center gap-2 opacity-80">
                <i data-lucide="flame" class="w-4 h-4 text-blue-400"></i>
                <h3 class="text-xs font-black uppercase tracking-widest">System Status</h3>
            </div>
            <div class="flex gap-3 text-[8px] font-bold uppercase tracking-wider">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Recov</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Ready</span>
            </div>
        </div>
        <div class="flex justify-center relative z-10 px-2">
            <heatmap-svg :statuses="muscleHeatmap"></heatmap-svg>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-3">This Week</h3>
        <div class="flex gap-2 overflow-x-auto no-scrollbar snap-x">
            <div v-for="dayObj in upcomingDays" :key="dayObj.fullDate" @click="openScheduleModal(dayObj)" class="snap-start flex-shrink-0 w-20 glass rounded-2xl p-3 flex flex-col items-center border border-white/5 relative group active:scale-95 transition-transform">
                <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">{{ dayObj.dayName }}</span>
                <span class="text-xs font-bold text-slate-300 mb-2">{{ dayObj.dateNum }}</span>
                <div v-if="getScheduleForDay(dayObj.dayName)" class="flex flex-col items-center">
                    <i :data-lucide="getScheduleForDay(dayObj.dayName).icon_name" class="w-5 h-5 text-blue-400 mb-1"></i>
                    <span class="text-[8px] font-bold text-center leading-none whitespace-normal break-words w-full text-blue-400">{{ getScheduleForDay(dayObj.dayName).name }}</span>
                </div>
                <div v-else class="w-8 h-8 rounded-full border border-dashed border-slate-700 flex items-center justify-center"><i data-lucide="plus" class="w-3 h-3 text-slate-600"></i></div>
            </div>
        </div>
    </div>

    <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Protocols</h3>
    <div class="grid grid-cols-2 gap-4 mb-8">
        <button v-for="routine in routines" :key="routine.id" @click="previewRoutine(routine)" class="glass p-6 rounded-3xl text-left hover:border-blue-500/50 transition-all active:scale-95 group relative overflow-hidden">
            <a :href="'builder.html?edit=' + routine.id" @click.stop class="absolute top-3 right-3 p-2 bg-slate-950/50 rounded-full text-slate-500 hover:text-white hover:bg-blue-600 transition-all z-10"><i data-lucide="pencil" class="w-3 h-3"></i></a>
            <i :data-lucide="routine.icon_name" class="w-6 h-6 text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
            <div class="font-black text-lg italic leading-tight mb-1 pr-6 break-words">{{ routine.name }}</div>
            <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">{{ routine.exercise_order?.length || 0 }} Exercises</div>
        </button>
        <a href="builder.html" class="glass p-6 rounded-3xl text-left hover:border-green-500/50 transition-all active:scale-95 group border-dashed border-slate-700">
            <i data-lucide="plus-circle" class="w-6 h-6 text-green-500 mb-3 group-hover:scale-110 transition-transform"></i>
            <div class="font-black text-xl italic text-slate-400">NEW</div>
            <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Workout / Exercise</div>
        </a>
    </div>

    <div class="glass rounded-[2.5rem] p-8 shadow-2xl pb-8">
        <div class="flex items-center gap-2 mb-6 opacity-60"><i data-lucide="history" class="w-4 h-4 text-slate-400"></i><h3 class="text-xs font-black uppercase tracking-widest">Recent Sessions</h3></div>
        <div v-if="recentSessions.length === 0" class="text-center py-4 text-slate-600 text-xs italic">No recent activity found.</div>
        <div class="space-y-4">
            <div v-for="session in recentSessions" :key="session.id" class="flex justify-between items-center border-b border-white/5 pb-4 last:border-0">
                <div>
                    <div class="font-black text-sm uppercase italic text-slate-200">{{ session.name }}</div>
                    <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-wider">{{ session.date }} • {{ session.exerciseCount }} Exercises • {{ session.volume }} Sets</div>
                </div>
                <div class="text-right"><span class="block font-black text-green-500 text-xs">COMPLETED</span></div>
            </div>
        </div>
    </div>
        
    <div v-if="resumeSessionName" class="fixed bottom-24 left-6 right-6 z-[90]">
        <a href="workout.html" class="flex items-center justify-between bg-blue-600/90 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-white/10 shadow-blue-900/20 active:scale-95 transition-all">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                <div>
                    <div class="text-[10px] font-black uppercase tracking-widest text-blue-200">Session in Progress</div>
                    <div class="text-sm font-bold text-white italic">{{ resumeSessionName }}</div>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-white"></i>
        </a>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
        <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
        <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
        <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
        <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
    </nav>

    <transition name="modal">
        <div v-if="previewModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="previewModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 border border-blue-500/20"><i :data-lucide="previewModal.icon_name" class="w-6 h-6"></i></div>
                    <div>
                        <h2 class="text-xl font-black italic uppercase">{{ previewModal.name }}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{{ previewModal.exercises.length }} Movements</p>
                    </div>
                </div>
                <div class="space-y-2 mb-8 max-h-64 overflow-y-auto">
                    <div v-for="(exId, idx) in previewModal.exercise_order" :key="idx" class="flex items-center gap-3 p-3 bg-slate-950/50 rounded-xl border border-white/5">
                        <span class="text-xs font-mono text-slate-600">0{{idx+1}}</span>
                        <span class="text-sm font-bold text-slate-300">{{ getExerciseName(exId) }}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="previewModal = null" class="py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Cancel</button>
                    <button @click="prepAndLaunchSession(previewModal)" class="py-3 rounded-xl bg-blue-600 text-white font-black text-xs uppercase shadow-lg shadow-blue-900/20">Start Session</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="scheduleModal" class="fixed inset-0 z-[200] flex items-end justify-center sm:items-center p-4">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="scheduleModal = null"></div>
            <div class="glass w-full max-w-md rounded-3xl p-6 relative border border-blue-500/20 shadow-2xl">
                <h2 class="text-xl font-black italic uppercase mb-2">Schedule Protocol</h2>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-6">For {{ scheduleModal.dayName }} {{ scheduleModal.dateNum }}</p>
                <div class="space-y-2 max-h-64 overflow-y-auto mb-6">
                    <button @click="saveSchedule(null)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 text-slate-500 font-bold text-xs uppercase hover:bg-slate-800 transition-colors">Rest Day (Clear)</button>
                    <button v-for="routine in routines" :key="routine.id" @click="saveSchedule(routine)" class="w-full text-left p-4 rounded-xl border border-white/5 bg-slate-900/50 hover:bg-blue-600/10 hover:border-blue-500/50 transition-all flex items-center gap-4">
                        <i :data-lucide="routine.icon_name" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-white font-bold text-sm uppercase italic">{{ routine.name }}</span>
                    </button>
                </div>
                <button @click="scheduleModal = null" class="w-full py-3 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Close</button>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp, defineComponent } = Vue;
    const _client = supabase.createClient('https://mvoyrchefjcpjkdtezmz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ');

    const HeatmapSvg = defineComponent({
        props: ['statuses'],
        methods: {
            getClass(muscleGroup) { return `muscle-${this.statuses[muscleGroup.toLowerCase()]?.status || 'fresh'}`; },
            getAnim(muscleGroup) { return this.statuses[muscleGroup.toLowerCase()]?.status === 'recov' ? 'animate-pulse' : ''; }
        },
        template: `
         <svg version="1.1" id="bodyMapSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 130 612 590" style="enable-background:new 0 0 612 792; height: 400px; width: auto;" xml:space="preserve">
            <g id="Base"><path class="muscle-base" d="` + 
            `M345.07,444.37c0.16,0.04,0.31,0.08,0.47,0.12c-0.03-0.1-0.05-0.19-0.08-0.29c-0.24,0.09-0.48,0.19-0.39-0.29c-0.22-3.72-0.8-7.45-0.6-11.15c0.54-10.44,1.34-20.87,2.18-31.29c0.18-2.26-0.32-3.23-2.69-2.81c-0.97,5.29-1.71,10.53-2.93,15.66c-1.97,8.23-2.51,16.22,1.72,24C343.74,440.17,344.1,442.38,345.07,444.37z M153.57,189.86c5.06,0.99,8.77-1.15,12.07-4.81c2.3-2.55,5.07-4.67,7.5-7.11c0.92-0.92,1.96-2.17,2.08-3.36c1.26-12.1,2.25-24.22,3.51-36.31c0.74-7.09-0.53-13.41-5.81-18.55c-1.45-1.41-2.59-3.61-4.31-4.2c-7.18-2.47-14.37-3.94-22.23-2.24c-6.31,1.36-11.05,3.85-13.97,9.6c-1.13,2.22-3.23,4.38-3.29,6.62c-0.26,9.62-1.38,19.26,0.71,28.87c1.09,5.03,1.35,10.24,2.18,15.34c0.22,1.36,0.87,2.88,1.81,3.84c2.98,3.03,6.31,5.71,9.28,8.74C145.88,189.1,148.96,190.56,153.57,189.86z M453.37,177.25c-0.68,2.58-1.36,5.16-2.03,7.75c0.32,0.12,0.64,0.23,0.95,0.35c1.65-2.49,3.38-4.92,4.94-7.47c2.02-3.31,3.13-8.01,6.04-9.7c2.92-1.69,7.58-0.22,11.45-0.52c2.75-0.21,4.12,0.93,5.34,3.21c3.05,5.72,6.35,11.31,9.55,16.95c0.25-0.08,0.5-0.16,0.75-0.24c-0.94-4.84-1.88-9.67-2.82-14.51c0.4-0.11,0.8-0.23,1.19-0.34c0.78,1.29,1.56,2.59,2.77,4.59c0.57-4,1.02-7.27,1.51-10.54c1.74-11.46,3.74-22.9,2.87-34.57c-0.08-1.14,0.06-2.43-0.45-3.37c-3.62-6.77-7.18-13.17-15.97-15.06c-8.31-1.79-16.22-1.02-23.51,2.29c-3.53,1.6-5.84,6.17-8.3,9.68c-1.09,1.55-1.52,3.78-1.66,5.75c-0.93,12.59,0.89,24.96,3.09,37.3c0.42,2.36,0.81,4.72,1.33,7.77c1.01-1.86,1.58-2.91,2.15-3.95c0.31,0.05,0.63,0.1,0.94,0.14C453.51,174.09,453.51,175.4,453.37,177.25z M581.57,422.85c0.44-2.56,2.5-2.69,4.23-2.22c0.93,0.25,1.79,1.78,2.13,2.9c0.56,1.85,0.51,3.88,1.02,5.75c1.78,6.41,1.13,12.35-3.52,17.36c-3.51,3.78-1.5,7.72-0.65,11.88c2.45-2.58,5.76-5.08,6.43-8.16c1.44-6.62,3.4-13.21,2.37-20.35c-1.46-10.08-1.93-20.31-2.82-30.42c-5.77-0.78-5.64-0.71-8.07,3.83c-3.7,6.92-6.96,13.88-6.88,22.01c0.04,3.81-0.48,7.63-0.75,11.47c3.77,0.02,3.77,0.02,4.28-2.69C580.03,430.6,580.72,427,581.57,422.85z M361.3,435.63c1.06,0.55,2.12,1.1,3.6,1.87c0.13-1.53,0.26-2.21,0.23-2.87c-0.48-10.56-1.17-20.99-6.77-30.53c-3.04-5.18-2.6-5.44-9.12-4.45c-0.54,8.06-0.96,16.18-1.66,24.28c-0.69,8.01-1.31,15.87,1.34,23.79c1.47,4.4,4.39,7.16,7.16,10.53c2.13-4.88,1.19-8.8-1.66-12.36c-4.17-5.21-4.63-11.04-3.04-17.26c0.4-1.56,0.47-3.23,1.09-4.68c0.54-1.26,1.47-2.98,2.55-3.26c2.25-0.58,3.53,1.03,3.94,3.25C359.67,427.67,360.39,431.39,361.3,435.63z M227.49,695.79c-1.25-2.89-2.9-5.69-3.69-8.7c-1.85-7.07-3.29-14.25-4.88-21.29c-4.84,0-9.33,0-14.12,0c4.42,13.36,5.68,27.55,15.34,38.91c3.2-1.4,6.6-2.89,10.25-4.49C229.36,698.65,228.55,697.43,227.49,695.79z M101,686.9c2.01-7.01,4.03-14.02,6.09-21.19c-4.81,0-9.25,0-13.6,0c-3.88,11.55-3.74,24.27-12.05,34.39c3.12,1.4,5.89,2.73,8.74,3.85c0.62,0.24,2.01-0.03,2.27-0.5C95.33,698.15,98.06,692.77,101,686.9z M411.91,699.72c0.67,0.28,1.35,0.56,2.64,1.09c0-10.83,0-21.06,0-30.11c-3.81,7.48-8.09,15.89-12.46,24.46C405.03,696.52,408.25,698,411.91,699.72z M139.3,209.97c0.52,1.76,1.24,3.48,1.53,5.28c0.56,3.53,2.41,5.18,6.24,4.68c-0.08-0.65-0.08-1.32-0.25-1.94c-3.05-10.67-6.04-21.36-9.25-31.98c-0.5-1.66-2.01-3.01-3.05-4.51c-0.33,0.13-0.67,0.26-1,0.38c0.23,3.95-0.03,8.02,0.8,11.84C135.46,199.06,137.44,204.22,139.3,209.97z M524.75,677.35c-1.06-2.62-2.12-5.24-3-7.44c0,9.97,0,20.27,0,31.08c4.62-2.23,8.51-4.1,12.41-5.97C531.02,689.13,528,683.48,524.75,677.35z M594.36,413.33c0.06,10.37,3.87,20.64,0.75,31.18c0.89-0.96,1.56-1.96,1.96-3.07c1.3-3.55,2.54-7.13,3.72-10.72c0.35-1.07,0.76-2.28,0.58-3.33c-1.64-9.6-3.41-19.19-5.14-28.74c-2.54-0.52-3.21,0.38-2.91,2.71C593.81,405.12,594.01,408.91,594.36,413.33z` + 
            `"/>
            <path class="muscle-base" d="M156.41,223.02c3.17-11.49,6.26-22.65,9.32-33.72c-8.33,4.57-16.25,4.81-24.64-0.4c3.26,11.55,6.41,22.72,9.73,34.48C148.83,223.08,157.81,223.02,156.41,223.02z"/>
            </g>
            <g id="Chest" :class="[getClass('Chest'), getAnim('Chest')]"><path class="muscle-base" d="` + 
            `M112.33,218.18c-6.59,9.96-13.05,20.02-19.42,30.12c-0.54,0.85-0.64,2.53-0.16,3.38 c4.12,7.3,7.88,14.91,12.9,21.56c2.45,3.25,7.26,4.82,11.16,6.84c1.4,0.73,3.33,0.97,4.92,0.75c8.07-1.12,16.11-2.5,24.18-3.67 c1.07-0.16,5.49,0.63,6.62,0.84c-0.03,0.42,7.88-0.82,8.71-0.71c4.89,0.66,9.87,1.08,14.61,2.34c7.84,2.09,15.14,1.6,21.97-2.91 c1.46-0.96,2.98-2.17,3.84-3.63c4.19-7.13,8.22-14.36,12.13-21.64c0.5-0.93,0.45-2.67-0.11-3.57 c-6.15-9.84-12.47-19.58-18.68-29.38c-0.9-1.43-1.69-1.97-3.55-1.59c-10.69,2.15-27.18,4.85-37.9,6.83 C152.82,223.88,114.32,215.18,112.33,218.18z` + 
            `"/></g>
            <g id="Biceps" :class="[getClass('Biceps'), getAnim('Biceps')]"><path class="muscle-base" d="` + 
            `M57.81,318.24c0.27,2.01,0.53,4.03,0.92,6.94c6.64-6.45,12.73-12.31,18.73-18.26c0.86-0.85,1.3-2.15,1.86-3.28 c2.58-5.26,4.93-10.64,7.76-15.76c3.13-5.66,4.66-11.66,5.2-18.01c0.21-2.4,0.29-4.89,1-7.16c1.4-4.46-1.39-7.27-3.33-10.93 c-7.06,4.44-13.65,8.82-20.48,12.8c-4.21,2.45-7.62,5.25-9.11,10.11c-1.26,4.12-3.32,8.03-4.25,12.21 C53.79,297.23,55.92,307.46,57.81,318.24z M223.36,255.55c-2.13-1.26-4.25-2.51-6.45-3.81c-2.47,3.52-4.5,6.57-3.65,10.75 c1.35,6.62,1.74,13.53,3.91,19.84c2.34,6.78,6.32,12.98,9.49,19.48c4.78,9.77,13.95,15.25,21.59,23.1 c2-12.96,5.07-24.96,3.06-37.57c-1.13-7.07-5.14-12.65-7.82-18.92c-0.19-0.45-0.87-0.72-1.35-1.02 C236.03,229.91,259.67,223.36,255.55z` + 
            `"/></g>
            <g id="Triceps" :class="[getClass('Triceps'), getAnim('Triceps')]"><path class="muscle-base" d="` + 
            `M368.7,325.14c-0.11,2.34-0.21,4.68-0.36,7.97c5.83-4.97,10.96-9.31,16.05-13.7c1.47-1.27,3.16-2.45,4.17-4.04 c4.86-7.65,9.39-15.51,14.29-23.14c4.4-6.84,6.22-13.81,4.35-22.05c-1.61-7.1-1.87-14.5-2.77-22.17 c-6.24,4.21-12.01,8.35-18.03,12.1c-10.13,6.33-13.61,16.55-15.06,27.27C369.69,299.64,369.53,312.11,368.7,325.14z M568.88,290.99 c-0.54-3.38-0.68-6.89-1.7-10.12c-3.56-11.37-10.17-20.3-21.24-25.56c-2.67-1.27-4.99-3.27-7.5-4.89 c-0.82-0.53-1.71-0.93-2.82-1.53c-1.18,9.27-2.08,18.19-3.56,27.02c-0.63,3.77-0.06,6.86,1.67,10.15 c8.24,15.7,16.4,31.42,31.38,42.08c1.8,1.28,3.44,2.76,5.69,4.58C570.16,318.46,569.55,305.04,568.88,290.99z` + 
            `"/></g>
            <g id="Core" :class="[getClass('Core'), getAnim('Core')]"><path class="muscle-base" d="` + 
            `M149.2,279.01c-1.03,0.28-2.05,0.67-3.1,0.82c-5.23,0.77-10.6,0.95-15.66,2.31 c-7.63,2.05-14.44,1.36-21.33-2.66c-3.11-1.82-5.61-3.62-7.26-6.82c-1.6-3.1-3.6-6-5.96-9.87c-0.76,5.51-1.52,9.9-1.92,14.32 c-0.17,1.94,0,4.09,0.68,5.91c2.68,7.21,5.45,14.4,8.51,21.45c3.62,8.35,5.53,16.96,5.19,26.06c-0.2,5.39-0.29,10.78-0.63,16.16 c-0.44,6.84,1.82,12.12,7.85,15.79c1.99,1.21,4.14,2.95,5.07,4.97c5.76,12.51,11.38,25.1,16.64,37.82 c2.79,6.75,6.06,13.1,10.78,18.68c1.79,2.11,8.95,3.02,10.59,0.96c2.57-3.23,5.31-6.5,7-10.19c5.11-11.16,9.85-22.5,14.54-33.85 c3.72-8.99,7.76-17.65,16.36-23.21c0.99-0.64,1.91-2.15,1.97-3.31c0.3-5.72,0.6-11.48,0.33-17.19c-0.54-11.34-0.42-22.5,4.72-33.03 c1.86-3.81,3.31-7.83,4.87-11.78c1.6-4.05,4.18-8.08,4.41-12.21c0.29-5.47-1.29-11.05-2.16-17.3c-0.82,1.28-1.34,1.87-1.62,2.55 c-3.39,8.14-8.49,14.52-17.36,17.09c-0.43,0.12-0.78,0.53-1.21,0.64c-1.2,0.32-2.48,0.94-3.62,0.77 c-8.75-1.29-17.47-2.71-26.19-4.2C159.91,279.55,149.22,278.59,149.2,279.01z` + 
            `"/></g>
            <g id="Shoulders" :class="[getClass('Shoulders'), getAnim('Shoulders')]"><path class="muscle-base" d="` + 
            `M65.54,246.9c-0.45,5.76-0.89,11.52-1.39,17.94c4.96-3.18,9.08-6.39,13.67-8.64 c8.13-3.99,13.99-9.84,18.37-17.78c4.14-7.51,9.28-14.48,14.47-22.43c-7.32-0.88-14-1.75-20.7-2.41c-0.98-0.1-2.16,0.68-3.08,1.3 c-4.26,2.92-8.49,5.91-12.68,8.94c-0.99,0.72-2.05,1.57-2.61,2.61C68.29,232.63,65.11,238.9,65.54,246.9z M240.82,244.93 c-0.44-12.2-5.19-21.44-16.5-27.49c-5.16-2.76-9.76-4.51-15.47-3.23c-2.9,0.65-5.89,0.9-8.83,1.37c-1.04,0.17-2.06,0.45-3.18,0.69 c6.79,10.76,13.31,21.15,19.93,31.48c0.7,1.09,1.91,1.94,3.05,2.66c6.78,4.3,13.6,8.53,20.42,12.76c0.72,0.45,1.54,0.74,2.61,1.24 C242.16,257.86,241.52,251.7,240.82,244.93z M393.69,252.11c11.45-8.63,22.89-17.26,34.47-25.98c-2.59-2.4-4.88-4.06-6.56-6.2 c-3.83-4.85-8.77-6.69-14.72-6.13c-1.51,0.14-3.18,0.43-4.43,1.21c-4.68,2.91-9.23,6.04-13.79,9.14c-0.72,0.49-1.43,1.18-1.85,1.93 c-5.9,10.75-5.89,22.59-6.45,34.9C384.93,257.94,389.1,255.16,393.69,252.11z M559.1,255.07c-0.09-1.72-0.13-3.44-0.28-5.16 c-0.38-4.22-0.12-8.65-1.37-12.6c-2.27-7.22-5.38-14.11-13.15-17.48c-2.58-1.12-4.71-3.27-7.17-4.71 c-3.96-2.32-8.72-2.02-12.09-0.11c-4.65,2.64-8.29,7.04-13.09,11.33c15.88,12.01,31.35,23.7,46.82,35.4 c0.31-0.25,0.62-0.51,0.93-0.76C559.51,259.21,559.33,257.45,559.1,255.07z` + 
            `"/></g>
        </svg>
        `
    });

    createApp({
        components: { 'heatmap-svg': HeatmapSvg },
        data() { return { loading: true, loadingText: 'Loading Data', routines: [], libraryExercises: [], schedule: [], recentSessions: [], rawLogs: [], muscleHeatmap: { 'chest': {status: 'fresh'}, 'back': {status: 'fresh'}, 'legs': {status: 'fresh'}, 'arms': {status: 'fresh'}, 'shoulders': {status: 'fresh'}, 'core': {status: 'fresh'}, 'quads': {status: 'fresh'}, 'hamstrings': {status: 'fresh'}, 'glutes': {status: 'fresh'}, 'calves': {status: 'fresh'}, 'biceps': {status: 'fresh'}, 'triceps': {status: 'fresh'}, 'forearms': {status: 'fresh'}, 'hips': {status: 'fresh'} }, scheduleModal: null, previewModal: null, toast: { visible: false, title: '', message: '' }, session: null, resumeSessionName: null } },
        computed: {
            upcomingDays() {
                const days = [];
                for(let i=0; i<7; i++) { const d = new Date(); d.setDate(d.getDate() + i); days.push({ dateNum: d.getDate(), dayName: d.toLocaleDateString('en-US', {weekday:'short'}), fullDate: d.toLocaleDateString('en-CA') }); }
                return days;
            }
        },
        async mounted() {
            const { data: { session }, error } = await _client.auth.getSession();
            if (error || !session) { window.location.href = 'index.html'; return; }
            this.session = session;
            
            // Check for active session for banner
            const saved = localStorage.getItem('constellation_active_session');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.activeRoutine && parsed.activeRoutine.name) {
                        this.resumeSessionName = parsed.activeRoutine.name;
                    }
                } catch (e) { localStorage.removeItem('constellation_active_session'); }
            }

            try {
                await Promise.all([this.fetchRoutines(), this.fetchExercises(), this.fetchSchedule()]);
                await this.fetchHistory(); 
            } catch (err) { console.error(err); } 
            finally { this.loading = false; this.$nextTick(() => lucide.createIcons()); }
        },
        methods: {
            async confirmLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },
            async fetchRoutines() { const { data } = await _client.from('routines').select('*').order('created_at'); this.routines = data || []; },
            async fetchExercises() { const { data } = await _client.from('exercises').select('*').order('name'); this.libraryExercises = data || []; },
            async fetchSchedule() { const { data } = await _client.from('schedule').select('*, routines(name, icon_name)').eq('user_id', this.session.user.id); this.schedule = data || []; },
            async fetchHistory() {
                const { data: rawData } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false }).limit(300);
                this.rawLogs = rawData || [];
                const now = new Date().getTime(); const oneDay = 1000 * 60 * 60 * 24;
                for(let m in this.muscleHeatmap) { this.muscleHeatmap[m].lastTrained = null; this.muscleHeatmap[m].status = 'fresh'; }
                this.rawLogs.forEach(log => {
                    const exDef = this.libraryExercises.find(e => e.name === log.exercise_name);
                    if(exDef && exDef.muscle_group) {
                        let groupKey = exDef.muscle_group.toLowerCase();
                        if(this.muscleHeatmap[groupKey]) {
                             const logTime = new Date(log.created_at).getTime();
                             if(!this.muscleHeatmap[groupKey].lastTrained || logTime > this.muscleHeatmap[groupKey].lastTrained) this.muscleHeatmap[groupKey].lastTrained = logTime;
                        }
                    }
                });
                for(let m in this.muscleHeatmap) {
                    if(this.muscleHeatmap[m].lastTrained) {
                        const daysSince = (now - this.muscleHeatmap[m].lastTrained) / oneDay;
                        if(daysSince < 2) this.muscleHeatmap[m].status = 'recov';
                        else if(daysSince < 4) this.muscleHeatmap[m].status = 'tired';
                        else this.muscleHeatmap[m].status = 'fresh';
                    }
                }
                if (!this.rawLogs.length) { this.recentSessions = []; return; }
                const sessions = []; let currentSession = null;
                const pushSession = (s) => { s.exerciseCount = s.exercises.size; delete s.exercises; sessions.push(s); };
                this.rawLogs.forEach((log) => {
                    const logTime = new Date(log.created_at).getTime();
                    if (!currentSession) {
                        currentSession = { id: log.id, startTime: logTime, name: log.protocol_name || 'Training Session', date: new Date(log.created_at).toLocaleDateString(), volume: (log.sets_data ? log.sets_data.length : 1), exercises: new Set([log.exercise_name]) };
                    } else {
                        const diffMins = Math.abs(currentSession.startTime - logTime) / (1000 * 60);
                        if (diffMins < 60) { currentSession.volume += (log.sets_data ? log.sets_data.length : 1); currentSession.exercises.add(log.exercise_name); } 
                        else { pushSession(currentSession); currentSession = { id: log.id, startTime: logTime, name: log.protocol_name || 'Training Session', date: new Date(log.created_at).toLocaleDateString(), volume: (log.sets_data ? log.sets_data.length : 1), exercises: new Set([log.exercise_name]) }; }
                    }
                });
                if (currentSession) pushSession(currentSession);
                this.recentSessions = sessions.slice(0, 5);
            },
            async generateAIWorkout() {
                this.loading = true; this.loadingText = "Analyzing Biometrics...";
                setTimeout(async () => {
                    const fillerExercises = this.libraryExercises.slice(0, 3).map(e => e.id);
                    if(fillerExercises.length) {
                        await _client.from('routines').insert([{ name: 'AI Gap Filler', icon_name: 'zap', exercise_order: fillerExercises, user_id: this.session.user.id }]);
                        await this.fetchRoutines();
                        this.toast = { visible: true, title: 'AI Generated', message: 'Gap Filler Protocol Created' }; setTimeout(() => this.toast.visible = false, 3000);
                    }
                    this.loading = false;
                }, 1000);
            },
            getScheduleForDay(dayName) { const entry = this.schedule.find(s => s.day_of_week === dayName); return entry ? { name: entry.routines.name, icon_name: entry.routines.icon_name } : null; },
            openScheduleModal(dayObj) { this.scheduleModal = dayObj; },
            async saveSchedule(routine) {
                if (!this.scheduleModal) return;
                const day = this.scheduleModal.dayName; 
                if (routine) await _client.from('schedule').upsert({ user_id: this.session.user.id, day_of_week: day, routine_id: routine.id }, { onConflict: 'user_id, day_of_week' });
                else await _client.from('schedule').delete().eq('user_id', this.session.user.id).eq('day_of_week', day);
                this.scheduleModal = null; this.fetchSchedule();
            },
            previewRoutine(routine) { this.previewModal = { ...routine, exercises: routine.exercise_order || [] }; },
            getExerciseName(id) { const ex = this.libraryExercises.find(e => e.id === id); return ex ? ex.name : 'Unknown Exercise'; },
            
            // --- THE REDIRECT LOGIC ---
            async prepAndLaunchSession(routine) {
                this.loading = true; this.loadingText = "Initializing...";
                const personalRecords = {};
                this.rawLogs.forEach(l => {
                     if(l.sets_data) l.sets_data.forEach(s => { const w = parseFloat(s.weight)||0; if(w > (personalRecords[l.exercise_name]||0)) personalRecords[l.exercise_name] = w; });
                });

                const draftRoutine = { name: routine.name, data: [] };
                const flatExercises = (routine.exercise_order || []).map((id, index) => {
                    const exDef = this.libraryExercises.find(e => e.id === id);
                    const pr = exDef ? (personalRecords[exDef.name] || 0) : 0;
                    return { 
                        id: id, name: exDef ? exDef.name : 'Exercise', icon: exDef ? exDef.icon_name : 'dumbbell', 
                        weightType: (exDef && exDef.is_bodyweight) ? 'bodyweight' : 'combined',
                        personalRecord: pr, isLinked: (routine.supersets || []).includes(index), 
                        sets: [{weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}, {weight:'', prevWeight:'', reps:'', prevReps:'', done:false, failure:false}] 
                    };
                });
                
                const clusters = [];
                flatExercises.forEach((ex) => {
                    if (ex.isLinked && clusters.length > 0) clusters[clusters.length - 1].exercises.push(ex);
                    else clusters.push({ type: 'cluster', exercises: [ex] });
                });
                draftRoutine.data = clusters;

                for (let group of draftRoutine.data) {
                    for (let ex of group.exercises) {
                        const { data: lastLog } = await _client.from('workout_logs').select('sets_data').eq('exercise_name', ex.name).order('created_at', { ascending: false }).limit(1).single();
                        if(lastLog && lastLog.sets_data) ex.sets = lastLog.sets_data.map(s => ({ weight: '', prevWeight: s.weight, reps: '', prevReps: s.reps, done: false, failure: false }));
                        while(ex.sets.length < 3) ex.sets.push({ weight: '', prevWeight: '', reps: '', prevReps: '', done: false, failure: false });
                    }
                }

                const state = { activeRoutine: draftRoutine, sessionStartTime: Date.now(), activeExerciseIdx: 0, stackTaken: false };
                localStorage.setItem('constellation_active_session', JSON.stringify(state));
                
                window.location.href = 'workout.html';
            }
        }
    }).mount('#app');
</script>
</body>
</html>
