<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tracker | Constellation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 999; display: flex; align-items: center; justify-content: center; }

        .toggle-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .toggle-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; }

        .bar-grow { transform-origin: bottom; animation: grow 1s ease-out forwards; transform: scaleY(0); }
        @keyframes grow { to { transform: scaleY(1); } }
        
        .matrix-cell { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.02); }
        .matrix-active { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa; }
    </style>
</head>
<body class="font-sans antialiased text-slate-200">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32">
    
    <div v-if="initialLoading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">Compiling Performance Intelligence</p>
        </div>
    </div>

    <div v-else>
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black italic text-purple-500 uppercase tracking-tighter">Tracker</h1>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Growth & Biometrics</p>
            </div>
            <div class="flex items-center gap-3">
                <div v-if="streak > 0" class="glass px-3 py-1 rounded-full flex items-center gap-2 border-orange-500/20">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 fill-orange-500"></i>
                    <span class="text-lg font-black text-white italic">{{ streak }}</span>
                </div>
                <button @click="handleLogout" class="w-12 h-12 glass rounded-2xl flex items-center justify-center text-slate-400 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="flex p-1 bg-slate-900 rounded-xl mb-8 border border-white/5">
            <button @click="view = 'intel'" :class="view === 'intel' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">Intelligence</button>
            <button @click="view = 'motion'" :class="view === 'motion' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">Motion</button>
        </div>

        <main>
            <div v-if="view === 'intel'" class="space-y-6">
                
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 mb-4 ml-1">Activity Matrix (30D)</h3>
                    <div class="grid grid-cols-6 gap-2">
                        <div v-for="day in activityMatrix" :key="day.date" class="matrix-cell" :class="{'matrix-active': day.active}">
                            <i v-if="day.active" :data-lucide="day.icon" class="w-4 h-4"></i>
                            <span v-else class="text-[6px] font-black text-slate-800">{{ day.dayNum }}</span>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Fuel Composite</h3>
                        <span class="text-[8px] font-black text-blue-400 uppercase tracking-widest">Target: {{targets.protein}}g PRO</span>
                    </div>
                    <div class="h-44 w-full relative">
                        <div class="absolute w-full border-t border-blue-500/50 border-dashed z-10 pointer-events-none" :style="{ bottom: (targets.protein * 0.7) + 'px' }"></div>
                        
                        <svg class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <g v-for="(day, index) in weeklyMacrosFull" :key="index" :transform="`translate(${index * 42 + 5}, 0)`">
                                <rect :y="150 - day.p" width="28" :height="day.p" :fill="day.active ? '#3b82f6' : '#1e293b'" rx="2" class="bar-grow" />
                                <rect :y="150 - day.p - day.c" width="28" :height="day.c" :fill="day.active ? '#10b981' : '#334155'" rx="2" class="bar-grow" />
                                <rect :y="150 - day.p - day.c - day.f" width="28" :height="day.f" :fill="day.active ? '#f59e0b' : '#475569'" rx="2" class="bar-grow" />
                                <text x="14" y="165" text-anchor="middle" font-size="8" fill="#64748b" font-weight="black" class="uppercase">{{ day.label }}</text>
                            </g>
                        </svg>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl space-y-8">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 ml-1">Growth Metrics</h3>
                    <div v-for="metric in ['waist', 'chest', 'arms', 'thigh']" :key="metric" class="space-y-2">
                        <div class="flex justify-between items-end px-1">
                            <span class="text-xs font-black uppercase italic">{{ metric }}</span>
                            <span class="text-[10px] font-bold text-slate-500">{{ getLatestMetric(metric) }} in</span>
                        </div>
                        <div class="h-16 w-full bg-slate-950/40 rounded-xl border border-white/5 overflow-hidden">
                            <svg class="w-full h-full" viewBox="0 0 300 60" preserveAspectRatio="none">
                                <polyline :points="getMetricPath(metric)" fill="none" stroke="#60a5fa" stroke-width="2" />
                            </svg>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl border-t-4 border-t-emerald-500">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-300 mb-6">Archive Measurements</h3>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div v-for="m in ['waist', 'chest', 'arms', 'thigh']" :key="m" class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">{{ m }} (in)</span>
                            <input type="number" step="0.1" v-model="bodyMetrics[m]" class="bg-transparent border-none text-xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                    </div>
                    <button @click="saveBodyMetrics" class="w-full py-5 rounded-2xl bg-emerald-600 text-white font-black text-xs uppercase shadow-lg active:scale-95 transition-all">Submit to Registry</button>
                </section>
            </div>

            <div v-if="view === 'motion'" class="space-y-4">
                <section class="glass p-6 rounded-[2.5rem] border-t-4 border-t-orange-500 shadow-2xl">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-6">Performance Registry</h3>
                    <div v-for="session in recentWorkouts" :key="session.id" class="bg-slate-950/40 p-5 rounded-3xl border border-white/5 mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-black italic text-slate-200 uppercase leading-none mb-1">{{ session.protocol_name }}</h4>
                                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">{{ session.date }}</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-xl font-black text-blue-400 leading-none">{{ session.tonnage.toLocaleString() }}</span>
                                <span class="text-[7px] font-black text-slate-600 uppercase tracking-widest">LBS Tonnage</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="timer" class="w-3 h-3 text-slate-500"></i>
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">{{ formatTUL(session.tul) }} Load Time</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-3 h-3 text-slate-500"></i>
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">{{ session.setCount }} Sets</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
            <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
            <a href="gym.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
            <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
            <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
        </nav>
    </div>
</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient('https://mvoyrchefjcpjkdtezmz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ');

    createApp({
        data() {
            return {
                initialLoading: true, view: 'intel', session: null,
                weightHistory: [], weeklyLogs: [], rawWorkouts: [], bodyHistory: [],
                bodyMetrics: { waist: null, chest: null, arms: null, thigh: null },
                targets: { protein: 180, cals: 2500 },
                streak: 0, chartPath: '', chartFillPath: '', lastPoint: {x:0, y:0}
            }
        },
        computed: {
            currentWeight() { return this.weightHistory.length ? this.weightHistory[this.weightHistory.length-1].weight : '--'; },
            activityMatrix() {
                const days = [];
                const now = new Date();
                for(let i=29; i>=0; i--) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    const ds = d.toISOString().split('T')[0];
                    const workout = this.rawWorkouts.find(w => w.created_at.startsWith(ds));
                    days.push({
                        date: ds,
                        dayNum: d.getDate(),
                        active: !!workout,
                        icon: workout?.protocol_icon || 'zap'
                    });
                }
                return days;
            },
            recentWorkouts() {
                const sessions = [];
                let currentSession = null;
                [...this.rawWorkouts].forEach(log => {
                    const logTime = new Date(log.created_at).getTime();
                    const tonnage = (log.sets_data || []).reduce((acc, s) => acc + (s.weight * s.reps), 0);
                    // Approximate Time Under Load (4s per rep average)
                    const tul = (log.sets_data || []).reduce((acc, s) => acc + (s.reps * 4), 0);

                    if(!currentSession || Math.abs(currentSession.startTime - logTime) > 3600000) {
                        currentSession = { 
                            id: log.id, protocol_name: log.protocol_name || 'Generic Session', 
                            startTime: logTime, date: new Date(log.created_at).toLocaleDateString(), 
                            setCount: 0, tonnage: 0, tul: 0, exercises: new Set() 
                        };
                        sessions.push(currentSession);
                    }
                    currentSession.setCount += (log.sets_data?.length || 0);
                    currentSession.tonnage += tonnage;
                    currentSession.tul += tul;
                    currentSession.exercises.add(log.exercise_name);
                });
                return sessions.slice(0, 10);
            },
            weeklyMacrosFull() {
                const days = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const ds = d.toISOString().split('T')[0];
                    const logs = this.weeklyLogs.filter(l => l.created_at.startsWith(ds));
                    const p = logs.reduce((sum, l) => sum + (l.protein || 0), 0);
                    const c = logs.reduce((sum, l) => sum + (l.carbs || 0), 0);
                    const f = logs.reduce((sum, l) => sum + (l.fat || 0), 0);
                    const total = p + c + f || 1;
                    const scale = 140 / Math.max(total, 400);
                    days.push({ label: d.toLocaleDateString('en-US', {weekday:'narrow'}), p: p*scale, c: c*scale, f: f*scale, active: p >= this.targets.protein });
                }
                return days;
            }
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            this.session = session;
            await Promise.all([this.fetchWeight(), this.fetchWeeklyLogs(), this.fetchWorkouts(), this.fetchTargets(), this.fetchBodyHistory()]);
            this.initialLoading = false;
            this.$nextTick(() => lucide.createIcons());
        },
        methods: {
            async handleLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },
            async fetchTargets() {
                const { data } = await _client.from('daily_metrics').select('target_protein, target_calories').order('created_at', { ascending: false }).limit(1);
                if(data?.[0]) { this.targets.protein = data[0].target_protein; this.targets.cals = data[0].target_calories; }
            },
            async fetchBodyHistory() {
                const { data } = await _client.from('body_metrics').select('*').order('created_at', { ascending: true });
                this.bodyHistory = data || [];
            },
            getLatestMetric(m) { 
                const valid = this.bodyHistory.filter(h => h[m]);
                return valid.length ? valid[valid.length-1][m] : '--'; 
            },
            getMetricPath(m) {
                const data = this.bodyHistory.filter(h => h[m]);
                if(data.length < 2) return "";
                const vals = data.map(d => d[m]);
                const min = Math.min(...vals) - 0.5;
                const max = Math.max(...vals) + 0.5;
                return data.map((d, i) => `${(i/(data.length-1))*300},${60 - ((d[m]-min)/(max-min || 1)*60)}`).join(' ');
            },
            async saveBodyMetrics() {
                const { error } = await _client.from('body_metrics').insert([{
                    user_id: this.session.user.id,
                    waist: parseFloat(this.bodyMetrics.waist),
                    chest: parseFloat(this.bodyMetrics.chest),
                    arms: parseFloat(this.bodyMetrics.arms),
                    thigh: parseFloat(this.bodyMetrics.thigh)
                }]);
                if(!error) { this.bodyMetrics = {waist:null, chest:null, arms:null, thigh:null}; this.fetchBodyHistory(); }
            },
            async fetchWeight() {
                const { data } = await _client.from('daily_metrics').select('*').order('created_at', { ascending: true }).limit(30);
                if (data?.length) { this.weightHistory = data; this.calculateGraph(data); }
            },
            calculateGraph(data) {
                const weights = data.map(d => d.weight).filter(w => w);
                const min = Math.min(...weights) - 1;
                const max = Math.max(...weights) + 1;
                const points = weights.map((w, i) => ({ x: (i/(weights.length-1))*300, y: 150 - ((w-min)/(max-min || 1)*150) }));
                this.chartPath = points.map(p => `${p.x},${p.y}`).join(' ');
                this.chartFillPath = `0,150 ${this.chartPath} 300,150`;
                this.lastPoint = points[points.length-1];
            },
            async fetchWeeklyLogs() {
                const { data } = await _client.from('food_logs').select('*').gte('created_at', new Date(Date.now() - 7*86400000).toISOString());
                this.weeklyLogs = data || [];
            },
            async fetchWorkouts() {
                const { data } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false });
                this.rawWorkouts = data || [];
                this.calculateStreak(data);
            },
            calculateStreak(logs) {
                const dates = [...new Set(logs.map(l => l.created_at.split('T')[0]))].sort().reverse();
                let s = 0; let today = new Date().toISOString().split('T')[0];
                if(dates.includes(today)) {
                    s++; let d = new Date(Date.now()-86400000);
                    while(dates.includes(d.toISOString().split('T')[0])) { s++; d.setDate(d.getDate()-1); }
                }
                this.streak = s;
            },
            formatTUL(s) { return `${Math.floor(s/60)}m ${s%60}s`; }
        }
    }).mount('#app');
</script>
</body>
</html>
