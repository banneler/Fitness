<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Tracker | Constellation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 999; display: flex; align-items: center; justify-content: center; }

        .toggle-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .toggle-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; }

        @keyframes pulse-orange {
            0%, 100% { filter: drop-shadow(0 0 5px #f97316); }
            50% { filter: drop-shadow(0 0 15px #f97316); }
        }
        .streak-fire { animation: pulse-orange 2s infinite; }
        
        .bar-grow { transform-origin: bottom; animation: grow 1s ease-out forwards; transform: scaleY(0); }
        @keyframes grow { to { transform: scaleY(1); } }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="font-sans antialiased text-slate-200">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32">
    
    <div v-if="initialLoading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-purple-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">Compiling Performance Data</p>
        </div>
    </div>

    <div v-else>
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black italic text-purple-500 uppercase tracking-tighter">Tracker</h1>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Intelligence & Progress</p>
            </div>
            <div class="flex items-center gap-3">
                <div v-if="streak > 0" class="glass px-3 py-1 rounded-full flex items-center gap-2 border-orange-500/20">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 streak-fire fill-orange-500"></i>
                    <span class="text-lg font-black text-white italic">{{ streak }}</span>
                </div>
                <button @click="logoutModal = true" class="w-12 h-12 glass rounded-2xl flex items-center justify-center border border-white/5 shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="flex p-1 bg-slate-900 rounded-xl mb-8 border border-white/5">
            <button @click="view = 'intel'" :class="view === 'intel' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">
                Intelligence
            </button>
            <button @click="view = 'motion'" :class="view === 'motion' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">
                Motion
            </button>
        </div>

        <main>
            <div v-if="view === 'intel'" class="space-y-6">
                
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl overflow-hidden relative border-t-4 border-t-blue-500">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest">30-Day Weight</h3>
                        </div>
                        <div class="text-right">
                            <span class="block text-[8px] text-slate-500 uppercase font-black tracking-widest">CURRENT</span>
                            <span class="text-2xl font-black italic text-white">{{ currentWeight }} <span class="text-sm text-slate-500 not-italic">lbs</span></span>
                        </div>
                    </div>
                    
                    <div class="h-40 w-full relative">
                        <svg v-if="chartPath" class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.4"/>
                                    <stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <polygon :points="chartFillPath" fill="url(#chartGradient)" />
                            <polyline :points="chartPath" fill="none" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" />
                            <circle :cx="lastPoint.x" :cy="lastPoint.y" r="4" fill="#fff" stroke="#3b82f6" stroke-width="2" />
                        </svg>
                        <div v-else class="w-full h-full flex items-center justify-center border border-white/5 rounded-xl bg-slate-950/20">
                            <span class="text-[10px] text-slate-500 italic uppercase">Insufficient Data</span>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="target" class="w-4 h-4 text-green-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">Neural Targets</h3>
                        </div>
                        <button @click="showTargetModal = true" class="text-[8px] font-black uppercase bg-white/5 px-3 py-1.5 rounded-lg border border-white/10 text-slate-400 hover:text-white transition-colors">Adjust Goals</button>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1">PROTEIN</span>
                            <span class="text-xl font-black italic">{{ targets.protein }}g</span>
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1">CALORIES</span>
                            <span class="text-xl font-black italic">{{ targets.cals }}</span>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl">
                    <div class="flex items-center gap-2 mb-6 opacity-60">
                        <i data-lucide="edit-3" class="w-4 h-4 text-purple-400"></i>
                        <h3 class="text-xs font-black uppercase tracking-widest">Biometric Log</h3>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div v-for="field in [{id:'weight', label:'Weight', unit:'lbs'}, {id:'sleep', label:'Sleep', unit:'hrs'}, {id:'hr', label:'R-HR', unit:'bpm'}]" :key="field.id" class="bg-slate-950/50 p-3 rounded-2xl border border-white/5 text-center">
                            <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">{{ field.label }}</span>
                            <input type="number" v-model="biometrics[field.id]" class="bg-transparent border-none text-lg font-black w-full text-center p-0 focus:ring-0">
                        </div>
                    </div>
                    <button @click="saveBiometrics" class="w-full py-4 rounded-2xl bg-purple-600 text-white font-black text-xs uppercase shadow-lg shadow-purple-900/20 active:scale-95 transition-all">Submit Biometrics</button>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-2xl">
                    <div class="flex items-center gap-2 mb-6 opacity-60">
                        <i data-lucide="pie-chart" class="w-4 h-4 text-orange-400"></i>
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">Daily Fuel Consistency</h3>
                    </div>
                    <div class="h-40 w-full">
                        <svg class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <g v-for="(day, index) in weeklyMacros" :key="index" :transform="`translate(${index * 42 + 10}, 0)`">
                                <rect :y="150 - day.protHeight" width="28" :height="day.protHeight" :fill="day.hit ? '#3b82f6' : '#1e293b'" rx="2" class="bar-grow" />
                                <text x="14" y="165" text-anchor="middle" font-size="8" fill="#64748b" font-weight="bold" class="uppercase">{{ day.label }}</text>
                            </g>
                        </svg>
                    </div>
                </section>
            </div>

            <div v-if="view === 'motion'" class="space-y-4">
                <section class="glass p-6 rounded-[2.5rem] border-t-4 border-t-orange-500 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="activity" class="w-4 h-4 text-orange-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest">Performance Sessions</h3>
                        </div>
                    </div>
                    
                    <div v-if="!recentWorkouts.length" class="text-center py-8 text-slate-600 italic text-xs">No motion data detected in the local sector.</div>
                    
                    <div v-else class="space-y-4">
                        <div v-for="session in recentWorkouts" :key="session.id" class="bg-slate-950/40 p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <span class="block font-black text-slate-200 uppercase text-sm italic tracking-tight">{{ session.protocol_name }}</span>
                                    <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">{{ session.date }}</span>
                                </div>
                                <div class="bg-blue-600/20 px-3 py-1 rounded-xl text-[9px] font-black text-blue-400 border border-blue-500/20 uppercase">
                                    {{ session.setCount }} Total Sets
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="ex in session.exercises" :key="ex" class="text-[7px] font-black uppercase px-2 py-0.5 bg-white/5 rounded border border-white/5 text-slate-400">
                                    {{ ex }}
                                </span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <transition name="modal">
            <div v-if="logoutModal" class="fixed inset-0 z-[300] flex items-end justify-center p-4">
                <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="logoutModal = false"></div>
                <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-white/10 shadow-2xl">
                    <h2 class="text-xl font-black italic uppercase text-center mb-2 text-white">System Logout</h2>
                    <div class="grid grid-cols-2 gap-3 mt-8">
                        <button @click="logoutModal = false" class="py-4 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Stay</button>
                        <button @click="handleLogout" class="py-4 rounded-xl bg-red-600 text-white font-black text-xs uppercase shadow-lg shadow-red-900/20">Disconnect</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showTargetModal" class="fixed inset-0 z-[300] flex items-end justify-center p-4">
                <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="showTargetModal = false"></div>
                <div class="glass w-full max-w-sm rounded-3xl p-8 relative border border-white/10 shadow-2xl">
                    <h2 class="text-xl font-black italic uppercase text-white mb-6">Authorize Goals</h2>
                    <div class="space-y-4 mb-8">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1">PROTEIN TARGET (g)</span>
                            <input type="number" v-model="targets.protein" class="bg-transparent border-none text-2xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1">CALORIE TARGET</span>
                            <input type="number" v-model="targets.cals" class="bg-transparent border-none text-2xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                    </div>
                    <button @click="saveTargets" class="w-full py-5 rounded-2xl bg-blue-600 text-white font-black text-sm uppercase shadow-lg shadow-blue-900/20 active:scale-95 transition-all">Update Neural Memory</button>
                </div>
            </div>
        </transition>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
            <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
            <a href="gym.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
            <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
            <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
        </nav>
    </div>
</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient('https://mvoyrchefjcpjkdtezmz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ');

    createApp({
        data() {
            return {
                initialLoading: true, logoutModal: false, showTargetModal: false,
                view: 'intel', session: null, streak: 0,
                weightHistory: [], weeklyLogs: [], rawWorkouts: [],
                biometrics: { weight: null, sleep: null, hr: null },
                targets: { protein: 180, cals: 2500 },
                chartPath: '', chartFillPath: '', lastPoint: {x:0, y:0}, startDate: ''
            }
        },
        computed: {
            currentWeight() { 
                return this.weightHistory.length ? this.weightHistory[this.weightHistory.length-1].weight : '--'; 
            },
            recentWorkouts() {
                // SESSION GROUPING LOGIC: Groups logs within 1 hour into a single "Session"
                const sessions = [];
                let currentSession = null;
                [...this.rawWorkouts].reverse().forEach(log => {
                    const logTime = new Date(log.created_at).getTime();
                    if(!currentSession || Math.abs(currentSession.startTime - logTime) > 3600000) {
                        currentSession = { 
                            id: log.id, 
                            protocol_name: log.protocol_name || 'Generic Training', 
                            startTime: logTime, 
                            date: new Date(log.created_at).toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'}), 
                            setCount: 0,
                            exercises: new Set()
                        };
                        sessions.push(currentSession);
                    }
                    currentSession.setCount += (log.sets_data?.length || 0);
                    currentSession.exercises.add(log.exercise_name);
                });
                return sessions.reverse().slice(0, 15);
            },
            weeklyMacros() {
                const days = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const logs = this.weeklyLogs.filter(l => l.created_at.startsWith(dateStr));
                    const p = logs.reduce((sum, l) => sum + (l.protein || 0), 0);
                    days.push({
                        label: d.toLocaleDateString('en-US', {weekday:'narrow'}),
                        protHeight: Math.min(135, p * 0.75),
                        hit: p >= this.targets.protein
                    });
                }
                return days;
            }
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            this.session = session;
            await Promise.all([this.fetchWeight(), this.fetchWeeklyLogs(), this.fetchWorkouts(), this.fetchTargets()]);
            this.initialLoading = false;
            this.$nextTick(() => lucide.createIcons());
        },
        methods: {
            async handleLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },
            async fetchTargets() {
                const { data } = await _client.from('daily_metrics')
                    .select('target_protein, target_calories')
                    .order('created_at', { ascending: false })
                    .limit(1);
                if(data?.[0]?.target_protein) {
                    this.targets.protein = data[0].target_protein;
                    this.targets.cals = data[0].target_calories || 2500;
                }
            },
            async saveTargets() {
                const { error } = await _client.from('daily_metrics').insert([{
                    user_id: this.session.user.id,
                    target_protein: this.targets.protein,
                    target_calories: this.targets.cals,
                    weight: this.currentWeight !== '--' ? this.currentWeight : null
                }]);
                if(!error) {
                    this.showTargetModal = false;
                    this.fetchTargets();
                }
            },
            async saveBiometrics() {
                if(!this.biometrics.weight) return;
                const { error } = await _client.from('daily_metrics').insert([{
                    user_id: this.session.user.id,
                    weight: parseFloat(this.biometrics.weight),
                    sleep_quality: parseInt(this.biometrics.sleep),
                    resting_hr: parseInt(this.biometrics.hr),
                    target_protein: this.targets.protein,
                    target_calories: this.targets.cals
                }]);
                if(!error) {
                    this.biometrics = { weight: null, sleep: null, hr: null };
                    await this.fetchWeight();
                }
            },
            async fetchWeight() {
                const { data } = await _client.from('daily_metrics')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(30);
                if (data?.length) {
                    this.weightHistory = data;
                    this.calculateGraph(data);
                }
            },
            calculateGraph(data) {
                if (data.length < 2) return;
                const weights = data.map(d => d.weight).filter(w => w !== null);
                const min = Math.min(...weights) - 1;
                const max = Math.max(...weights) + 1;
                const range = max - min;
                const points = weights.map((w, i) => {
                    const x = (i / (weights.length - 1)) * 300;
                    const y = 150 - ((w - min) / range) * 150;
                    return { x, y };
                });
                this.chartPath = points.map(p => `${p.x},${p.y}`).join(' ');
                this.chartFillPath = `0,150 ${this.chartPath} 300,150`;
                this.lastPoint = points[points.length-1];
                this.startDate = new Date(data[0].created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },
            async fetchWeeklyLogs() {
                const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const { data } = await _client.from('food_logs').select('*').gte('created_at', sevenDaysAgo);
                this.weeklyLogs = data || [];
            },
            async fetchWorkouts() {
                const { data } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false });
                this.rawWorkouts = data || [];
                this.calculateStreak(data);
            },
            calculateStreak(logs) {
                if (!logs || !logs.length) return;
                const uniqueDates = [...new Set(logs.map(l => l.created_at.split('T')[0]))].sort().reverse();
                let streak = 0;
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                if (uniqueDates.includes(today) || uniqueDates.includes(yesterday)) {
                    let checkDate = uniqueDates.includes(today) ? new Date() : new Date(Date.now() - 86400000);
                    while (uniqueDates.includes(checkDate.toISOString().split('T')[0])) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    }
                }
                this.streak = streak;
            }
        }
    }).mount('#app');
</script>
</body>
</html>
