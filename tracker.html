<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tracker | Constellation</title>

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Constellation">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-active { color: #3b82f6; }
        .tab-active i { stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 999; display: flex; align-items: center; justify-content: center; }

        .toggle-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .toggle-inactive { background: rgba(30, 41, 59, 0.5); color: #94a3b8; }

        @keyframes pulse-orange {
            0%, 100% { filter: drop-shadow(0 0 5px #f97316); }
            50% { filter: drop-shadow(0 0 15px #f97316); }
        }
        .streak-fire { animation: pulse-orange 2s infinite; }
        
        .bar-grow { transform-origin: bottom; animation: grow 1s ease-out forwards; transform: scaleY(0); }
        @keyframes grow { to { transform: scaleY(1); } }

        .warning-overlay { mix-blend-mode: multiply; }

        .matrix-cell { aspect-ratio: 1/1; border-radius: 8px; border: 1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.01); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .matrix-active { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); color: #22c55e; }

        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="font-sans antialiased text-slate-200">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32">
    
    <div v-if="initialLoading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-purple-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">Compiling Intelligence</p>
        </div>
    </div>

    <div v-else>
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black italic text-purple-500 uppercase tracking-tighter">Tracker</h1>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Performance Intelligence</p>
            </div>
            <div class="flex items-center gap-3">
                <div v-if="streak > 0" class="glass px-3 py-1 rounded-full flex items-center gap-2 border-orange-500/20">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 streak-fire fill-orange-500"></i>
                    <span class="text-lg font-black text-white italic">{{ streak }}</span>
                </div>
                <button @click="logoutModal = true" class="w-12 h-12 glass rounded-2xl flex items-center justify-center border border-white/5 shadow-lg active:scale-95 transition-all text-slate-400 hover:text-red-500">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="flex p-1 bg-slate-900 rounded-xl mb-8 border border-white/5">
            <button @click="view = 'intel'" :class="view === 'intel' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">Intel</button>
            <button @click="view = 'motion'" :class="view === 'motion' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">Motion</button>
            <button @click="view = 'exercises'" :class="view === 'exercises' ? 'toggle-active' : 'toggle-inactive'" class="toggle-btn flex-1 py-3 rounded-lg text-xs font-black uppercase italic tracking-widest">Analysis</button>
        </div>

        <main>
            <div v-if="view === 'intel'" class="space-y-6">
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl border-t-4 border-t-purple-600 mb-6 bg-gradient-to-br from-purple-900/10 to-transparent">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2">
                            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-[0.2em] text-white">Neural Analyst</h3>
                        </div>
                        <button @click="runAnalysis" :disabled="isAnalyzing" class="px-4 py-2 rounded-xl bg-purple-600/20 border border-purple-500/30 text-purple-400 text-[10px] font-black uppercase italic active:scale-95 transition-all">
                            <span v-if="!isAnalyzing">SYNC LINK</span>
                            <span v-else class="animate-pulse">ANALYZING...</span>
                        </button>
                    </div>

                    <div v-if="analysis" class="space-y-4">
                        <div class="bg-slate-950/50 p-5 rounded-3xl border border-white/5">
                            <p class="text-[10px] text-purple-400 font-black uppercase mb-2 tracking-widest">Executive Briefing</p>
                            <p class="text-sm italic leading-relaxed text-slate-200">{{ analysis.summary }}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                                <p class="text-[8px] text-orange-400 font-black uppercase mb-1">Prediction</p>
                                <p class="text-[10px] font-bold text-slate-300 italic">{{ analysis.prediction }}</p>
                            </div>
                            <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                                <p class="text-[8px] text-emerald-400 font-black uppercase mb-1">Growth Vector</p>
                                <p class="text-[10px] font-bold text-slate-300 italic">{{ analysis.advice }}</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl overflow-hidden relative border-t-4 border-t-blue-500">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">30-Day Weight</h3>
                        </div>
                        <div class="text-right">
                            <span class="block text-[8px] text-slate-500 uppercase font-black tracking-widest">LATEST</span>
                            <span class="text-2xl font-black italic text-white">{{ currentWeight }} <span class="text-sm text-slate-500 not-italic">lbs</span></span>
                        </div>
                    </div>
                    <div class="h-40 w-full relative">
                        <svg v-if="chartPath" class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.4"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <polygon :points="chartFillPath" fill="url(#chartGradient)" />
                            <polyline :points="chartPath" fill="none" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" />
                            <circle :cx="lastPoint.x" :cy="lastPoint.y" r="4" fill="#fff" stroke="#3b82f6" stroke-width="2" />
                        </svg>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="target" class="w-4 h-4 text-green-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">Neural Targets</h3>
                        </div>
                        <button @click="showTargetModal = true" class="text-[8px] font-black uppercase bg-white/5 px-3 py-1.5 rounded-lg border border-white/10 text-slate-400 hover:text-white transition-colors">Adjust Goals</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1 uppercase">Protein Goal</span>
                            <span class="text-xl font-black italic">{{ targets.protein }}g</span>
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1 uppercase">Calorie Goal</span>
                            <span class="text-xl font-black italic">{{ targets.cals }}</span>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex items-center gap-2 opacity-60">
                            <i data-lucide="pie-chart" class="w-4 h-4 text-orange-400"></i>
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">7-Day Fuel Composite</h3>
                        </div>
                        <div class="flex flex-col gap-1 items-end">
                            <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div><span class="text-[6px] text-slate-500 font-black uppercase">Protein</span></div>
                            <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span class="text-[6px] text-slate-500 font-black uppercase">Carbohydrates</span></div>
                            <div class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div><span class="text-[6px] text-slate-500 font-black uppercase">Fat</span></div>
                        </div>
                    </div>
                    <div class="h-44 w-full relative">
                        <svg class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                            <line v-if="targets.protein > 0" 
                                  x1="0" :y1="150 - (targets.protein * chartScale)" 
                                  x2="300" :y2="150 - (targets.protein * chartScale)" 
                                  stroke="#22c55e" stroke-width="2" stroke-dasharray="6 3" />
                            
                            <text v-if="targets.protein > 0" x="295" :y="145 - (targets.protein * chartScale)" text-anchor="end" font-size="6" fill="#22c55e" font-weight="black" class="uppercase">Goal: {{targets.protein}}g</text>

                            <g v-for="(day, index) in weeklyMacrosFull" :key="index" :transform="`translate(${index * 42 + 10}, 0)`">
                                <rect :y="150 - day.p" width="28" :height="day.p" :fill="day.active ? '#3b82f6' : '#1e293b'" rx="2" class="bar-grow" />
                                <rect :y="150 - day.p - day.c" width="28" :height="day.c" :fill="day.active ? '#10b981' : '#334155'" rx="2" class="bar-grow" style="animation-delay:0.1s" />
                                <rect :y="150 - day.p - day.c - day.f" width="28" :height="day.f" :fill="day.active ? '#f59e0b' : '#475569'" rx="2" class="bar-grow" style="animation-delay:0.2s" />
                                <rect v-if="day.isOver" :y="150 - day.p - day.c - day.f" width="28" :height="day.p + day.c + day.f" fill="#ef4444" fill-opacity="0.4" rx="2" class="bar-grow warning-overlay" />
                                <text x="14" y="165" text-anchor="middle" font-size="8" :fill="day.isToday ? '#fff' : '#64748b'" font-weight="black" class="uppercase tracking-tighter">{{ day.label }}</text>
                            </g>
                        </svg>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl space-y-6">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 ml-1">Growth Vectors</h3>
                    <div v-for="metric in ['waist', 'chest', 'arms', 'thigh']" :key="metric" class="space-y-2">
                        <div class="flex justify-between items-end px-1">
                            <span class="text-xs font-black uppercase italic">{{ metric }}</span>
                            <span class="text-[10px] font-bold text-blue-400">{{ getLatestMetric(metric) }} in</span>
                        </div>
                        <div class="h-12 w-full bg-slate-950/40 rounded-xl border border-white/5 overflow-hidden">
                            <svg class="w-full h-full" viewBox="0 0 300 60" preserveAspectRatio="none">
                                <polyline :points="getMetricPath(metric)" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] shadow-xl border-t-4 border-t-emerald-500">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-300 mb-6">Archive Measurements</h3>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div v-for="m in ['waist', 'chest', 'arms', 'thigh']" :key="m" class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[7px] text-slate-500 font-black uppercase block mb-1">{{ m }} (in)</span>
                            <input type="number" step="0.01" v-model="bodyMetrics[m]" class="bg-transparent border-none text-xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                    </div>
                    <button @click="saveBodyMetrics" class="w-full py-5 rounded-2xl bg-emerald-600 text-white font-black text-xs uppercase shadow-lg active:scale-95 transition-all">Submit to Registry</button>
                </section>
            </div>

            <div v-if="view === 'motion'" class="space-y-6">
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 mb-4 ml-1">Activity Spectrum (30D)</h3>
                    <div class="grid grid-cols-6 gap-2">
                        <div v-for="day in activityMatrix" :key="day.date" class="matrix-cell" :class="{'matrix-active': day.active}">
                            <i v-if="day.active" :data-lucide="day.icon" class="w-4 h-4"></i>
                            <span v-else class="text-[6px] font-black text-slate-800">{{ day.dayNum }}</span>
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-[2.5rem] border-t-4 border-t-orange-500 shadow-2xl">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-6">Performance Ledger</h3>
                    <div v-for="session in recentWorkouts" :key="session.id" class="bg-slate-950/40 p-5 rounded-3xl border border-white/5 mb-4 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-black italic text-slate-200 uppercase leading-none mb-1">{{ session.protocol_name }}</h4>
                                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">{{ session.date }}</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-xl font-black text-blue-400 leading-none">{{ session.tonnage.toLocaleString() }}</span>
                                <span class="text-[7px] font-black text-slate-600 uppercase tracking-widest">LBS Tonnage</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="timer" class="w-3 h-3 text-slate-500"></i>
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">{{ formatTUL(session.tul) }} Load</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-3 h-3 text-slate-500"></i>
                                <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">{{ session.setCount }} Sets</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div v-if="view === 'exercises'" class="space-y-6">
                <section class="glass p-6 rounded-[2.5rem] shadow-2xl">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="microscope" class="w-5 h-5 text-pink-500"></i>
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-300">Movement Analysis</h3>
                    </div>
                    
                    <div class="relative mb-6">
                        <input type="text" v-model="mvmtSearch" @input="filterExercises" placeholder="Select Movement..." class="w-full bg-slate-950 border border-slate-800 rounded-2xl py-4 px-6 outline-none font-bold text-sm placeholder-slate-600 focus:ring-1 focus:ring-pink-500/50 transition-all text-white">
                        <div v-if="mvmtSearch && showMvmtList" class="absolute left-0 right-0 mt-2 bg-slate-900 border border-white/10 rounded-2xl overflow-hidden z-20 max-h-48 overflow-y-auto shadow-2xl">
                            <button v-for="ex in filteredExercises" :key="ex.id" @click="selectMovement(ex)" class="w-full text-left px-6 py-4 border-b border-white/5 hover:bg-white/5 text-xs font-bold uppercase transition-colors">
                                {{ ex.name }}
                            </button>
                        </div>
                    </div>

                    <div v-if="selectedMovement" class="space-y-6">
                        <div class="flex justify-between items-center bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-pink-500/10 flex items-center justify-center text-pink-500 border border-pink-500/20">
                                    <i :data-lucide="selectedMovement.icon_name || 'dumbbell'" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-black uppercase italic">{{ selectedMovement.name }}</div>
                                    <div class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">{{ selectedMovement.muscle_group }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black italic text-white">{{ mvmtStats.max1RM }}<span class="text-xs text-slate-500 not-italic">lbs</span></div>
                                <div class="text-[8px] font-black text-slate-500 uppercase tracking-widest">Est. 1RM</div>
                            </div>
                        </div>

                        <div class="flex p-1 bg-slate-950 rounded-lg border border-white/5">
                            <button @click="mvmtChartMode = 'strength'" :class="mvmtChartMode === 'strength' ? 'bg-blue-600 text-white' : 'text-slate-500 hover:text-white'" class="flex-1 py-2 rounded-md text-[9px] font-black uppercase tracking-widest transition-all">Max Strength</button>
                            <button @click="mvmtChartMode = 'volume'" :class="mvmtChartMode === 'volume' ? 'bg-orange-600 text-white' : 'text-slate-500 hover:text-white'" class="flex-1 py-2 rounded-md text-[9px] font-black uppercase tracking-widest transition-all">Volume Load</button>
                        </div>

                        <div class="h-48 w-full relative bg-slate-950/20 rounded-xl border border-white/5">
                            <svg v-if="mvmtChartPath" class="w-full h-full overflow-visible" viewBox="0 0 300 150" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="mvmtGradient" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="0%" :stop-color="mvmtChartMode==='strength'?'#3b82f6':'#f97316'" stop-opacity="0.4"/>
                                        <stop offset="100%" :stop-color="mvmtChartMode==='strength'?'#3b82f6':'#f97316'" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <polygon :points="mvmtFillPath" fill="url(#mvmtGradient)" />
                                <polyline :points="mvmtChartPath" fill="none" :stroke="mvmtChartMode==='strength'?'#3b82f6':'#f97316'" stroke-width="3" stroke-linecap="round" />
                                <circle v-for="p in mvmtPoints" :key="p.x" :cx="p.x" :cy="p.y" r="3" fill="#020617" :stroke="mvmtChartMode==='strength'?'#3b82f6':'#f97316'" stroke-width="2" />
                            </svg>
                            <div v-else class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-600 uppercase font-bold italic">Insufficient Data</div>
                        </div>
                    </div>
                    <div v-else class="text-center py-8 text-slate-600 text-xs italic">Select a movement to analyze data stream.</div>
                </section>
            </div>
        </main>

        <transition name="modal">
            <div v-if="showTargetModal" class="fixed inset-0 z-[300] flex items-end justify-center p-4">
                <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="showTargetModal = false"></div>
                <div class="glass w-full max-sm rounded-3xl p-8 relative border border-white/10 shadow-2xl">
                    <h2 class="text-xl font-black italic uppercase text-white mb-6 tracking-tight">Sync Targets</h2>
                    <div class="space-y-4 mb-8">
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1 uppercase">Protein Target (g)</span>
                            <input type="number" v-model="targets.protein" class="bg-transparent border-none text-2xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                        <div class="bg-slate-950/50 p-4 rounded-2xl border border-white/5">
                            <span class="text-[8px] text-slate-500 font-black block mb-1 uppercase">Calorie Target</span>
                            <input type="number" v-model="targets.cals" class="bg-transparent border-none text-2xl font-black w-full text-white p-0 focus:ring-0">
                        </div>
                    </div>
                    <button @click="saveTargets" class="w-full py-5 rounded-2xl bg-blue-600 text-white font-black text-sm uppercase shadow-lg active:scale-95 transition-all">Authorize Intelligence</button>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="logoutModal" class="fixed inset-0 z-[300] flex items-end justify-center p-4">
                <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" @click="logoutModal = false"></div>
                <div class="glass w-full max-w-sm rounded-3xl p-6 relative border border-white/10 shadow-2xl">
                    <h2 class="text-xl font-black italic uppercase text-center mb-2 text-white">System Logout</h2>
                    <div class="grid grid-cols-2 gap-3 mt-8">
                        <button @click="logoutModal = false" class="py-4 rounded-xl bg-slate-900 text-slate-400 font-bold text-xs uppercase">Abort</button>
                        <button @click="handleLogout" class="py-4 rounded-xl bg-red-600 text-white font-black text-xs uppercase shadow-lg">Disconnect</button>
                    </div>
                </div>
            </div>
        </transition>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
            <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="calendar" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Today</span></a>
            <a href="gym.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="dumbbell" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span></a>
            <a href="kitchen.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all"><i data-lucide="utensils" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span></a>
            <a href="#" class="flex flex-col items-center tab-active text-blue-500"><i data-lucide="line-chart" class="w-6 h-6 mb-1"></i><span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span></a>
        </nav>
    </div>
</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient('https://mvoyrchefjcpjkdtezmz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ');

    createApp({
        data() {
            return {
                initialLoading: true, logoutModal: false, showTargetModal: false,
                view: 'intel', session: null, streak: 0,
                // Add toast state object
                toast: { visible: false, title: '', message: '' },
                weightHistory: [], weeklyLogs: [], rawWorkouts: [], bodyHistory: [],
                bodyMetrics: { waist: null, chest: null, arms: null, thigh: null },
                targets: { protein: 180, cals: 2500 },
                chartPath: '', chartFillPath: '', lastPoint: {x:0, y:0}, startDate: '',
                isAnalyzing: false,
                analysis: null,
                
                // MOVEMENT ANALYSIS
                library: [], mvmtSearch: '', showMvmtList: false, filteredExercises: [],
                selectedMovement: null, mvmtHistory: [], mvmtChartMode: 'strength',
                mvmtChartPath: '', mvmtFillPath: '', mvmtPoints: [], mvmtStats: { max1RM: 0 }
            }
        },
        computed: {
            currentWeight() { return this.weightHistory.length ? this.weightHistory[this.weightHistory.length-1].weight : '--'; },
            globalMaxMacros() {
                const totals = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const ds = d.toLocaleDateString('en-CA'); 
                    const logs = this.weeklyLogs.filter(l => l.created_at.startsWith(ds));
                    totals.push(logs.reduce((sum, l) => sum + (l.protein || 0) + (l.carbs || 0) + (l.fat || 0), 0));
                }
                return Math.max(...totals, 450); 
            },
            chartScale() { return 135 / this.globalMaxMacros; },
            calculateProteinLineY() { return (this.targets.protein * this.chartScale) + 'px'; },
            activityMatrix() {
                const days = [];
                const now = new Date();
                for(let i=29; i>=0; i--) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    const ds = d.toLocaleDateString('en-CA');
                    const workout = this.rawWorkouts.find(w => w.created_at.startsWith(ds));
                    days.push({ date: ds, dayNum: d.getDate(), active: !!workout, icon: workout?.protocol_icon || 'zap' });
                }
                return days;
            },
            recentWorkouts() {
                const sessions = [];
                let currentSession = null;
                [...this.rawWorkouts].forEach(log => {
                    const logTime = new Date(log.created_at).getTime();
                    const tonnage = (log.sets_data || []).reduce((acc, s) => acc + (parseFloat(s.weight || 0) * parseInt(s.reps || 0)), 0);
                    const tul = (log.sets_data || []).reduce((acc, s) => acc + (parseInt(s.reps || 0) * 4), 0);
                    if(!currentSession || Math.abs(currentSession.startTime - logTime) > 3600000) {
                        currentSession = { id: log.id, protocol_name: log.protocol_name || 'Generic Session', startTime: logTime, date: new Date(log.created_at).toLocaleDateString(), setCount: 0, tonnage: 0, tul: 0, exercises: new Set() };
                        sessions.push(currentSession);
                    }
                    currentSession.setCount += (log.sets_data?.length || 0);
                    currentSession.tonnage += tonnage;
                    currentSession.tul += tul;
                    currentSession.exercises.add(log.exercise_name);
                });
                return sessions.slice(0, 10);
            },
            weeklyMacrosFull() {
                const days = [];
                for(let i=6; i>=0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const ds = d.toLocaleDateString('en-CA'); 
                    const logs = this.weeklyLogs.filter(l => l.created_at.startsWith(ds));
                    
                    const p = logs.reduce((sum, l) => sum + (l.protein || 0), 0);
                    const c = logs.reduce((sum, l) => sum + (l.carbs || 0), 0);
                    const f = logs.reduce((sum, l) => sum + (l.fat || 0), 0);
                    const totalCals = logs.reduce((sum, l) => sum + (l.calories || 0), 0);
                    
                    days.push({ 
                        label: d.toLocaleDateString('en-US', {weekday:'narrow'}), 
                        p: p * this.chartScale, 
                        c: c * this.chartScale, 
                        f: f * this.chartScale, 
                        active: p >= this.targets.protein, 
                        isOver: totalCals > this.targets.cals, 
                        isToday: ds === new Date().toLocaleDateString('en-CA') 
                    });
                }
                return days;
            }
        },
        watch: {
            mvmtChartMode() { this.calculateMvmtChart(); }
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            this.session = session;
            await Promise.all([this.fetchWeight(), this.fetchWeeklyLogs(), this.fetchWorkouts(), this.fetchTargets(), this.fetchBodyHistory(), this.fetchLibrary()]);
            
            if (this.bodyHistory.length) {
                const last = this.bodyHistory[this.bodyHistory.length - 1];
                this.bodyMetrics = { waist: last.waist, chest: last.chest, arms: last.arms, thigh: last.thigh };
            }
            this.initialLoading = false;
            this.$nextTick(() => lucide.createIcons());
        },
        updated() { lucide.createIcons(); },
        methods: {
            async handleLogout() { await _client.auth.signOut(); window.location.href = 'index.html'; },

            // ADDED: Missing Toast Method
            showToast(title, message) {
                this.toast = { visible: true, title, message };
                setTimeout(() => this.toast.visible = false, 3000);
            },
            
            async fetchLibrary() {
                const { data } = await _client.from('exercises').select('*').order('name');
                this.library = data || [];
            },
            filterExercises() {
                if(this.mvmtSearch.length < 1) { this.showMvmtList = false; return; }
                const s = this.mvmtSearch.toLowerCase();
                this.filteredExercises = this.library.filter(e => e.name.toLowerCase().includes(s));
                this.showMvmtList = true;
            },
            async selectMovement(ex) {
                this.selectedMovement = ex;
                this.mvmtSearch = ex.name;
                this.showMvmtList = false;
                const { data } = await _client.from('workout_logs').select('*').eq('exercise_name', ex.name).order('created_at', { ascending: true }).limit(30);
                this.mvmtHistory = data || [];
                this.calculateMvmtChart();
            },
            calculateMvmtChart() {
                if(!this.mvmtHistory.length) { this.mvmtChartPath = ''; this.mvmtStats.max1RM = 0; return; }
                const points = this.mvmtHistory.map(log => {
                    let val = 0;
                    if(this.mvmtChartMode === 'strength') {
                        const maxEst = (log.sets_data || []).reduce((max, s) => {
                             const w = parseFloat(s.weight||0); const r = parseInt(s.reps||0);
                             if(w > 0 && r > 0) { const est = w * (1 + r/30); return est > max ? est : max; }
                             return max;
                        }, 0);
                        val = maxEst;
                    } else {
                        val = (log.sets_data || []).reduce((acc, s) => acc + (parseFloat(s.weight||0) * parseInt(s.reps||0)), 0);
                    }
                    return val;
                });
                this.mvmtStats.max1RM = Math.max(0, ...points).toFixed(1);
                if(points.length < 2) { this.mvmtChartPath = `0,75 300,75`; return; }
                const min = Math.min(...points) * 0.9; const max = Math.max(...points) * 1.1; const range = max - min || 1;
                const coords = points.map((val, i) => ({ x: (i / (points.length - 1)) * 300, y: 150 - ((val - min) / range * 130) - 10 }));
                this.mvmtPoints = coords;
                this.mvmtChartPath = coords.map(p => `${p.x},${p.y}`).join(' ');
                this.mvmtFillPath = `0,150 ${this.mvmtChartPath} 300,150`;
            },
            
            async fetchTargets() {
                // FIXED: Removed .neq constraint so it loads your data even if incomplete
                const { data } = await _client.from('daily_metrics')
                    .select('target_protein, target_calories')
                    .eq('user_id', this.session.user.id)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if(data?.[0]) { 
                    this.targets.protein = data[0].target_protein || 180; 
                    this.targets.cals = data[0].target_calories || 2500; 
                }
            },
            
            async saveTargets() {
                const today = new Date().toLocaleDateString('en-CA');
                
                const { data: existing } = await _client.from('daily_metrics')
                    .select('id')
                    .eq('user_id', this.session.user.id) 
                    .gte('created_at', today)
                    .order('created_at', { ascending: false })
                    .limit(1);

                let error;
                if(existing && existing.length > 0) {
                    const { error: err } = await _client.from('daily_metrics')
                        .update({ target_protein: this.targets.protein, target_calories: this.targets.cals })
                        .eq('id', existing[0].id);
                    error = err;
                } else {
                    const { error: err } = await _client.from('daily_metrics').insert([{ 
                        user_id: this.session.user.id, 
                        target_protein: this.targets.protein, 
                        target_calories: this.targets.cals, 
                        weight: this.currentWeight !== '--' ? parseFloat(this.currentWeight) : null 
                    }]);
                    error = err;
                }

                if(!error) { 
                    this.showTargetModal = false;
                    this.showToast("Goals Synced", "Neural pathways updated."); // FIXED: Added visual confirmation
                    await this.fetchTargets(); 
                } else {
                    console.error("Save failed:", error);
                    alert("Could not save targets.");
                }
            },

            async runAnalysis() {
                this.isAnalyzing = true;
                try {
                    const { data, error } = await _client.functions.invoke('ai-performance-summary', { body: { user_id: this.session.user.id } });
                    if (error) throw error;
                    this.analysis = data;
                    this.$nextTick(() => lucide.createIcons());
                } catch (e) { console.error("Neural link failed", e); } finally { this.isAnalyzing = false; }
            },
            async fetchBodyHistory() {
                const { data } = await _client.from('body_metrics').select('*').order('created_at', { ascending: true });
                this.bodyHistory = data || [];
            },
            getLatestMetric(m) { 
                const valid = this.bodyHistory.filter(h => h[m] !== null);
                return valid.length ? valid[valid.length-1][m] : '--'; 
            },
            getMetricPath(m) {
                const data = this.bodyHistory.filter(h => h[m] !== null);
                if(data.length < 2) return "";
                const vals = data.map(d => d[m]); const min = Math.min(...vals) - 0.1; const max = Math.max(...vals) + 0.1; const range = max - min || 1;
                return data.map((d, i) => `${(i/(data.length-1))*300},${60 - ((d[m]-min)/range*60)}`).join(' ');
            },
            async saveBodyMetrics() {
                const { error } = await _client.from('body_metrics').insert([{ user_id: this.session.user.id, waist: parseFloat(this.bodyMetrics.waist), chest: parseFloat(this.bodyMetrics.chest), arms: parseFloat(this.bodyMetrics.arms), thigh: parseFloat(this.bodyMetrics.thigh) }]);
                if(!error) { await this.fetchBodyHistory(); this.showToast("Saved", "Biometrics registry updated."); }
            },
            async fetchWeight() {
                // FIXED: Now fetches newest 30 entries (Descending), then reverses for graph
                const { data } = await _client.from('daily_metrics')
                    .select('*')
                    .eq('user_id', this.session.user.id)
                    .neq('weight', null)
                    .order('created_at', { ascending: false }) // Get Newest
                    .limit(30);
                    
                if (data?.length) { 
                    this.weightHistory = data.reverse(); // Reverse for Chart (Old -> New)
                    this.calculateGraph(this.weightHistory); 
                }
            },
            calculateGraph(data) {
                const weights = data.map(d => d.weight).filter(w => w);
                if (weights.length < 2) return;
                const min = Math.min(...weights) - 1; const max = Math.max(...weights) + 1; const range = max - min || 1;
                const points = weights.map((w, i) => ({ x: (i/(weights.length-1))*300, y: 150 - ((w-min)/range*150) }));
                this.chartPath = points.map(p => `${p.x},${p.y}`).join(' ');
                this.chartFillPath = `0,150 ${this.chartPath} 300,150`;
                this.lastPoint = points[points.length-1];
            },
            async fetchWeeklyLogs() {
                const { data } = await _client.from('food_logs').select('*').gte('created_at', new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0]);
                this.weeklyLogs = data || [];
            },
            async fetchWorkouts() {
                const { data } = await _client.from('workout_logs').select('*').order('created_at', { ascending: false });
                this.rawWorkouts = data || [];
                this.calculateStreak(data);
            },
            calculateStreak(logs) {
                const dates = [...new Set(logs.map(l => l.created_at.split('T')[0]))].sort().reverse();
                let s = 0; let today = new Date().toLocaleDateString('en-CA');
                let yesterday = new Date(Date.now()-86400000).toLocaleDateString('en-CA');
                if(dates.includes(today) || dates.includes(yesterday)) {
                    let d = dates.includes(today) ? new Date() : new Date(Date.now()-86400000);
                    while(dates.includes(d.toLocaleDateString('en-CA'))) { s++; d.setDate(d.getDate()-1); }
                }
                this.streak = s;
            },
            formatTUL(s) { return `${Math.floor(s/60)}m ${s%60}s`; }
        }
    }).mount('#app');
</script>


</body>
</html>
