<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kitchen | Constellation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none !important; }
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* Clean Active State (No Glow) */
        .tab-active { color: #3b82f6; }
        .tab-active svg { stroke-width: 3px; }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-mask { position: fixed; inset: 0; background: #020617; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="font-sans antialiased">
<div id="app" v-cloak class="min-h-screen flex flex-col p-6 pb-32">
    
    <div v-if="initialLoading" class="loading-mask">
        <div class="animate-pulse flex flex-col items-center gap-4">
            <div class="w-10 h-10 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
            <p class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600 italic">Synchronizing</p>
        </div>
    </div>

    <header class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-3xl font-black italic text-green-500 uppercase">Kitchen</h1>
            <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest">Neural Fuel</p>
        </div>
        <a href="index.html" class="w-12 h-12 glass rounded-2xl flex items-center justify-center border border-white/5 shadow-lg active:scale-95 transition-all">
            <icon name="layout-grid" class="w-5 h-5 text-slate-400"></icon>
        </a>
    </header>

    <input type="file" ref="cameraInput" accept="image/*" capture="environment" class="hidden" @change="handleScan">

    <div class="glass rounded-[2.5rem] p-8 shadow-2xl mb-8">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-white text-lg font-black italic uppercase">Fuel Log</h3>
            <button @click="triggerCamera" :disabled="scanning" class="bg-blue-600/20 px-4 py-2 rounded-xl border border-blue-500/30 text-blue-500 text-[10px] font-black uppercase italic flex items-center gap-2 active:scale-95 transition-all">
                <icon v-if="scanning" key="spin" name="loader-2" class="w-3 h-3 animate-spin"></icon>
                <icon v-else key="cam" name="camera" class="w-3 h-3"></icon> 
                {{ scanning ? 'UPLOADING...' : 'AI SCAN' }}
            </button>
        </div>

        <input type="text" v-model="foodSearch" @input="filterMemory" placeholder="Search Memory..." class="w-full bg-slate-950 border border-slate-800 rounded-2xl py-5 px-6 outline-none font-black text-lg mb-6 placeholder-slate-700 focus:ring-1 focus:ring-green-500/50 transition-all">
        
        <div v-if="showMemory && filteredMemory.length" class="glass rounded-2xl overflow-hidden mb-6 border-blue-500/20">
            <button v-for="item in filteredMemory" :key="item.id" @click="selectFood(item)" class="w-full px-6 py-4 text-left border-b border-white/5 hover:bg-blue-500/10 flex justify-between font-black text-xs italic transition-colors">
                <span class="text-white uppercase">{{ item.food_name }}</span>
                <span class="opacity-50">{{ item.calories }}c | {{ item.protein }}p</span>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div v-for="m in ['cals','protein','carbs','fat']" :key="m" class="bg-slate-950/50 p-4 rounded-2xl border border-white/5 focus-within:border-green-500/50 transition-colors">
                <span class="text-[8px] text-slate-600 uppercase font-black italic tracking-widest">{{m}}</span>
                <input type="number" v-model="foodEntry[m]" class="bg-transparent border-none text-2xl font-black w-full text-white p-0 focus:ring-0 placeholder-slate-800" placeholder="0">
            </div>
        </div>
        
        <button @click="saveFood" class="w-full bg-green-600 hover:bg-green-500 py-5 rounded-2xl font-black text-xl shadow-xl shadow-green-900/20 active:scale-95 transition-all">LOG FUEL</button>
    </div>

    <div class="glass rounded-[2.5rem] p-8 shadow-2xl">
        <div class="flex items-center gap-2 mb-6 opacity-60">
            <icon name="list" class="w-4 h-4 text-green-400"></icon>
            <h3 class="text-xs font-black uppercase tracking-widest">Today's Ledger</h3>
        </div>

        <div v-if="dailyLogs.length === 0" class="text-center py-4 text-slate-600 italic text-xs">
            No fuel recorded today.
        </div>

        <div v-else class="space-y-4">
            <div v-for="log in dailyLogs" :key="log.id" class="flex justify-between items-center border-b border-white/5 pb-4 last:border-0 last:pb-0">
                <div>
                    <div class="font-black text-sm uppercase italic text-slate-200">{{ log.food_name }}</div>
                    <div class="text-[10px] text-slate-500 font-bold mt-1 tracking-wider">
                        {{ log.calories }} <span class="text-[8px]">CAL</span> <span class="mx-1">•</span>
                        {{ log.protein }} <span class="text-[8px]">PRO</span> <span class="mx-1">•</span>
                        {{ log.carbs }} <span class="text-[8px]">CHO</span> <span class="mx-1">•</span>
                        {{ log.fat }} <span class="text-[8px]">FAT</span>
                    </div>
                </div>
                <button @click="deleteLog(log.id)" class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center text-slate-600 hover:text-red-500 hover:bg-red-500/10 transition-all active:scale-90">
                    <icon name="trash-2" class="w-4 h-4"></icon>
                </button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-white/5 flex justify-between px-6 py-4 safe-area-bottom z-[100]">
        <a href="today.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all">
            <icon name="calendar" class="w-6 h-6 mb-1"></icon>
            <span class="text-[8px] font-black uppercase italic tracking-widest">Today</span>
        </a>
        <a href="gym.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all">
            <icon name="dumbbell" class="w-6 h-6 mb-1"></icon>
            <span class="text-[8px] font-black uppercase italic tracking-widest">Gym</span>
        </a>
        <a href="#" class="flex flex-col items-center tab-active text-green-500">
            <icon name="utensils" class="w-6 h-6 mb-1"></icon>
            <span class="text-[8px] font-black uppercase italic tracking-widest">Kitchen</span>
        </a>
        <a href="tracker.html" class="flex flex-col items-center text-slate-600 hover:text-white transition-all">
            <icon name="line-chart" class="w-6 h-6 mb-1"></icon>
            <span class="text-[8px] font-black uppercase italic tracking-widest">Tracker</span>
        </a>
    </nav>
</div>

<script>
    const { createApp } = Vue;
    const _client = supabase.createClient(
        'https://mvoyrchefjcpjkdtezmz.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12b3lyY2hlZmpjcGprZHRlem16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjkxNzksImV4cCI6MjA4MzY0NTE3OX0.o_dh0rMw0RPYWJjn3ssA6OkKY8udy5vhqVQzN50uvEQ'
    );

    // Icon Component to prevent Vue/Lucide conflicts
    const IconComponent = {
        props: ['name', 'class'],
        template: `<i :class="this.class" v-html="svgContent"></i>`,
        computed: {
            svgContent() {
                // Ensure Lucide is loaded
                if (window.lucide && window.lucide.icons) {
                    const camel = this.name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                    if (window.lucide.icons[camel]) {
                        return window.lucide.icons[camel].toSvg();
                    }
                }
                return '';
            }
        }
    };

    createApp({
        components: { icon: IconComponent },
        data() { 
            return { 
                initialLoading: true,
                scanning: false,
                session: null, 
                foodSearch: '', 
                foodEntry: { cals: 0, protein: 0, carbs: 0, fat: 0 }, 
                memory: [], 
                filteredMemory: [], 
                showMemory: false,
                dailyLogs: [] 
            } 
        },
        async mounted() {
            const { data: { session } } = await _client.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            this.session = session;
            await Promise.all([this.initMemory(), this.fetchDailyLogs()]);
            this.initialLoading = false;
            this.$nextTick(() => { if(window.lucide) window.lucide.createIcons(); });
        },
        methods: {
            async initMemory() {
                const { data } = await _client.from('food_memory').select('*').order('use_count', { ascending: false });
                this.memory = data || [];
            },
            async fetchDailyLogs() {
                const today = new Date().toISOString().split('T')[0];
                const { data } = await _client.from('food_logs')
                    .select('*')
                    .gte('created_at', today)
                    .order('created_at', { ascending: false });
                this.dailyLogs = data || [];
            },
            filterMemory() {
                this.showMemory = this.foodSearch.length > 1;
                this.filteredMemory = this.memory.filter(f => f.food_name.toLowerCase().includes(this.foodSearch.toLowerCase())).slice(0, 5);
            },
            selectFood(i) {
                this.foodSearch = i.food_name;
                this.foodEntry = { cals: i.calories, protein: i.protein, carbs: i.carbs, fat: i.fat };
                this.showMemory = false;
            },
            async saveFood() {
                if(!this.foodSearch) return;
                await _client.from('food_logs').insert([{ 
                    food_name: this.foodSearch, 
                    calories: this.foodEntry.cals, 
                    protein: this.foodEntry.protein, 
                    carbs: this.foodEntry.carbs, 
                    fat: this.foodEntry.fat, 
                    user_id: this.session.user.id 
                }]);
                this.foodSearch = '';
                this.foodEntry = { cals: 0, protein: 0, carbs: 0, fat: 0 };
                this.fetchDailyLogs(); 
            },
            async deleteLog(id) {
                if(confirm("Delete this entry?")) {
                    await _client.from('food_logs').delete().eq('id', id);
                    this.fetchDailyLogs(); 
                }
            },
            triggerCamera() {
                this.$refs.cameraInput.click();
            },
            async handleScan(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.scanning = true;
                
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Image = e.target.result;
                        
                        // STANDARD INVOKE - Client handles Auth
                        const { data, error } = await _client.functions.invoke('ai-nutrition-parser', {
                            body: { image: base64Image }
                        });

                        if (error) {
                            console.error("Function Error:", error);
                            alert("Upload Failed: " + (error.message || "Unknown error"));
                            throw error;
                        }

                        if (data) {
                            this.foodSearch = data.food_name || "Scanned Item";
                            this.foodEntry = {
                                cals: data.calories || 0,
                                protein: data.protein || 0,
                                carbs: data.carbs || 0,
                                fat: data.fat || 0
                            };
                            alert("Scan Complete.");
                        }
                        this.scanning = false;
                    };
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error(e);
                    this.scanning = false;
                } finally {
                    event.target.value = ''; 
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
